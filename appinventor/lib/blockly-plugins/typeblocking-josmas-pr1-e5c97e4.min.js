/*! For license information please see index.js.LICENSE.txt */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("blockly/core"));else if("function"==typeof define&&define.amd)define(["blockly/core"],e);else{var n="object"==typeof exports?e(require("blockly/core")):e(t.Blockly);for(var o in n)("object"==typeof exports?exports:t)[o]=n[o]}}(this,(t=>(()=>{"use strict";var e={370:e=>{e.exports=t}},n={};function o(t){var s=n[t];if(void 0!==s)return s.exports;var i=n[t]={exports:{}};return e[t](i,i.exports,o),i.exports}o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{TypeBlocking:()=>L});var i=o(370);const r="floatInput";function c(t){return t.replace(/_/g," ")}class a{constructor(t){this.workspace=t}setScopeAnalyzer(t){this.scopeAnalyzer=t}generateOptions(){const t=[];t.push(...this.getBuiltinBlockOptions()),t.push(...this.getVariableOptions()),t.push(...this.getProcedureOptions());const e=new Set;return t.filter((t=>{const n=`${t.blockType}:${t.displayText}`;return!e.has(n)&&(e.add(n),!0)}))}getVariableOptions(){const t=[],e=this.workspace.getVariablesOfType("");for(const n of e){const e=n.name;t.push({blockType:`get ${e}`,displayText:`get ${e}`}),t.push({blockType:`set ${e} to`,displayText:`set ${e} to`})}if(this.scopeAnalyzer){const e=this.scopeAnalyzer.getLocalVariablesInScope();console.log("Local variables in scope:",e);for(const n of e)t.push({blockType:`get ${n}`,displayText:`get ${n}`}),t.push({blockType:`set ${n} to`,displayText:`set ${n} to`})}return t}getProcedureOptions(){const t=[],e=this.workspace.getAllBlocks(!1);for(const n of e)if("procedures_defnoreturn"===n.type||"procedures_defreturn"===n.type){const e=n.getField("NAME");if(e){const o=e.getValue();if(o&&o.trim()){t.push({blockType:o,displayText:o});const e=this.getProcedureParameters(n);if(e.length>0){const n=`${o}(${e.join(", ")})`;t.push({blockType:n,displayText:n})}}}}return t}getBuiltinBlockOptions(){const t=[];for(const e in i.Blocks){const n=i.Blocks[e];this.shouldSkipBlock(e)||(n.typeblock?t.push({blockType:e,displayText:n.typeblock}):this.isValidBuiltinBlock(e)&&t.push({blockType:e,displayText:c(e)}))}return t}getProcedureParameters(t){const e=[];if(t.getVars){const n=t.getVars();e.push(...n)}return e}shouldSkipBlock(t){return[/^procedures_/,/^variables_get$/,/^variables_set$/,/^_/].some((e=>e.test(t)))}isValidBuiltinBlock(t){return i.Blocks[t]}}class l{constructor(t={}){var e,n,o,s,i,r,c,a;this.patterns=[],this.detectionCache=new Map,this.config={enableNumberDetection:null===(e=t.enableNumberDetection)||void 0===e||e,enableTextDetection:null===(n=t.enableTextDetection)||void 0===n||n,enableBooleanDetection:null===(o=t.enableBooleanDetection)||void 0===o||o,enableMathExpressions:null===(s=t.enableMathExpressions)||void 0===s||s,enableVariableAssignments:null===(i=t.enableVariableAssignments)||void 0===i||i,customPatterns:null!==(r=t.customPatterns)&&void 0!==r?r:[],patternPriorities:null!==(c=t.patternPriorities)&&void 0!==c?c:{},confidenceThreshold:null!==(a=t.confidenceThreshold)&&void 0!==a?a:.7},this.initializePatterns()}initializePatterns(){this.patterns.push(...this.config.customPatterns),this.sortPatterns()}registerBuiltinPatterns(t){const e=t.filter((t=>this.isPatternEnabled(t)));e.forEach((t=>{this.config.patternPriorities[t.name]&&(t.priority=this.config.patternPriorities[t.name])})),this.patterns.push(...e),this.sortPatterns()}isPatternEnabled(t){switch(t.name){case"number":return this.config.enableNumberDetection;case"text":return this.config.enableTextDetection;case"boolean":return this.config.enableBooleanDetection;case"math_expression":return this.config.enableMathExpressions;case"variable_assignment":return this.config.enableVariableAssignments;default:return!0}}sortPatterns(){this.patterns.sort(((t,e)=>e.priority-t.priority))}detectPattern(t){if(this.detectionCache.has(t))return this.detectionCache.get(t);let e=null;for(const n of this.patterns){const o=t.match(n.pattern);if(o){const s=this.calculateConfidence(n,o,t);if(s>=this.config.confidenceThreshold){const i={pattern:n,match:o,confidence:s};if(s>=.95)return this.detectionCache.set(t,i),i;(!e||s>e.confidence)&&(e=i)}}}return this.detectionCache.set(t,e),e}calculateConfidence(t,e,n){let o=.8;return e[0]===n.trim()&&(o+=.15),t.isComplete&&t.isComplete(n)&&(o+=.05),o+=t.priority/1e3,Math.min(o,1)}getBlockInstructions(t){const e=this.detectPattern(t);if(!e)return null;try{const n=e.pattern.parseInput(e.match);return n&&console.debug(`Generated block instruction using pattern: ${e.pattern.name}`,{input:t,confidence:e.confidence,blockType:n.blockType}),n}catch(t){return console.error(`Failed to generate instruction using pattern ${e.pattern.name}:`,t),null}}getSuggestions(t){const e=[];for(const n of this.patterns){if(n.generateSuggestions){const o=t.match(n.pattern);if(o){const t=n.generateSuggestions(o);e.push(...t.map((t=>({text:t,description:n.description,example:this.getPatternExample(n),patternName:n.name}))))}}this.isPartialMatch(t,n)&&e.push({text:this.getPatternExample(n),description:`${n.description} (example)`,example:this.getPatternExample(n),patternName:n.name})}return e}isPartialMatch(t,e){const n=t.trim();if(0===n.length)return!1;const o=["","0","1","true","false",'"',")"];for(const t of o){const o=n+t;if(e.pattern.test(o))return!0}return!1}getPatternExample(t){switch(t.name){case"number":return"42";case"text":return'"hello world"';case"boolean":return"true";case"math_expression":return"2 + 3";case"variable_assignment":return"set x to 5";default:return"example"}}isPatternMatch(t){return null!==this.detectPattern(t)}getPatterns(){return[...this.patterns]}clearCache(){this.detectionCache.clear()}updateConfig(t){this.config=Object.assign(Object.assign({},this.config),t),this.patterns=[],this.clearCache(),this.initializePatterns()}}class u{isComplete(t){return this.pattern.test(t.trim())}}class p extends u{constructor(){super(...arguments),this.name="number",this.pattern=/^-?\d*\.?\d+$/,this.priority=100,this.description="Create number block from numeric input"}parseInput(t){const e=t[0],n=parseFloat(e);return isNaN(n)?null:{blockType:"math_number",fieldValues:{NUM:e}}}generateSuggestions(t){const e=t[0],n=[e],o=parseFloat(e);return isNaN(o)||n.push(String(o+1),String(o-1),String(10*o),String(Math.abs(o))),n}}class h extends u{constructor(){super(...arguments),this.name="text",this.pattern=/^["'](.*)["']$/,this.priority=95,this.description="Create text block from quoted string"}parseInput(t){return{blockType:"text",fieldValues:{TEXT:t[1]}}}generateSuggestions(t){const e=t[1];return[`"${e}"`,`'${e}'`,'"hello world"','"example text"']}}class d extends u{constructor(){super(...arguments),this.name="boolean",this.pattern=/^(true|false)$/i,this.priority=90,this.description="Create boolean block from true/false"}parseInput(t){return{blockType:"logic_boolean",fieldValues:{BOOL:"true"===t[1].toLowerCase()?"TRUE":"FALSE"}}}generateSuggestions(){return["true","false"]}}class g extends u{constructor(){super(...arguments),this.name="math_expression",this.pattern=/^(\d+(?:\.\d+)?)\s*([+\-*/])\s*(\d+(?:\.\d+)?)$/,this.priority=80,this.description="Create arithmetic block from math expression",this.operatorMap={"+":"ADD","-":"MINUS","*":"MULTIPLY","/":"DIVIDE"}}parseInput(t){const[,e,n,o]=t;return this.operatorMap[n]?{blockType:"math_arithmetic",fieldValues:{OP:this.operatorMap[n]},children:[{input:"A",instruction:{blockType:"math_number",fieldValues:{NUM:e}}},{input:"B",instruction:{blockType:"math_number",fieldValues:{NUM:o}}}]}:null}generateSuggestions(t){const[,e,n,o]=t,s=parseFloat(e),i=parseFloat(o),r=[t[0]];for(const t of["+","-","*","/"])t!==n&&r.push(`${e} ${t} ${o}`);return r.push(`${s+1} ${n} ${o}`,`${e} ${n} ${i+1}`,`${10*s} ${n} ${o}`),r}}class f extends u{constructor(){super(...arguments),this.name="variable_assignment",this.pattern=/^set\s+(\w+)\s+to\s+(.+)$/i,this.priority=85,this.description='Create variable assignment from "set var to value" syntax'}parseInput(t){const[,e,n]=t,o=this.parseValueInstruction(n.trim());return o?{blockType:"variables_set",fieldValues:{VAR:e},children:[{input:"VALUE",instruction:o}]}:null}parseValueInstruction(t){if(/^-?\d*\.?\d+$/.test(t))return{blockType:"math_number",fieldValues:{NUM:t}};const e=t.match(/^["'](.*)["']$/);return e?{blockType:"text",fieldValues:{TEXT:e[1]}}:/^(true|false)$/i.test(t)?{blockType:"logic_boolean",fieldValues:{BOOL:"true"===t.toLowerCase()?"TRUE":"FALSE"}}:/^\w+$/.test(t)?{blockType:"variables_get",fieldValues:{VAR:t}}:null}generateSuggestions(t){const[,e,n]=t;return[`set ${e} to ${n}`,`set ${e} to 0`,`set ${e} to "text"`,`set ${e} to true`,"set myVar to 42","set count to 0"]}}function m(){return[new p,new h,new d,new g,new f]}function b(t){return{blockType:t,displayText:t}}class k extends a{constructor(t,e){super(t),this.lastInput="",this.lastSuggestions=[],this.patternManager=new l(e),this.patternManager.registerBuiltinPatterns(m())}generateOptionsForInput(t){if(t===this.lastInput&&this.lastSuggestions.length>0)return this.lastSuggestions;const e=t.trim(),n=this.generateOptions(),o=this.getPatternSuggestions(e),s=this.filterAndRankOptions(n,e),i=this.combineOptions(o,s,e);return this.lastInput=t,this.lastSuggestions=i,i}getPatternSuggestions(t){if(!t)return[];const e=[],n=this.patternManager.detectPattern(t);console.debug("SmartOptionGenerator: Pattern detection for",t,":",n),n&&(e.push(b(t)),console.debug("SmartOptionGenerator: Added pattern input as suggestion:",t));const o=this.patternManager.getSuggestions(t);if(console.debug("SmartOptionGenerator: Pattern manager suggestions:",o),e.push(...o.map((t=>b(t.text)))),this.isPartialPatternInput(t)){const n=this.getPatternExamples(t);console.debug("SmartOptionGenerator: Pattern examples:",n),e.push(...n.map((t=>b(t))))}console.debug("SmartOptionGenerator: Final pattern suggestions:",e);const s=new Set;return e.filter((t=>{const e=`${t.blockType}:${t.displayText}`;return!s.has(e)&&(s.add(e),!0)}))}isPartialPatternInput(t){return 0!==t.length&&[/^\d+$/,/^["']/,/^(true|false)$/i,/^\d+\s*[+\-*/]/,/^set\s+\w*/,/^get\s+/,/^when\s+/].some((e=>e.test(t)))}getPatternExamples(t){const e=[];if(/^\d/.test(t)&&e.push("42","3.14",`${t} + 1`,`${t} * 2`),/^["']/.test(t)&&e.push('"hello world"',"'example text'"),/^(t|f)/i.test(t)&&e.push("true","false"),/^set/i.test(t)&&e.push("set x to 5",'set name to "hello"',"set flag to true"),/^get/i.test(t)){const t=this.workspace.getVariablesOfType("");e.push(...t.map((t=>`get ${t.name}`)))}return e}filterAndRankOptions(t,e){return e?t.map((t=>({option:t,score:this.calculateRelevanceScore(t.displayText,e)}))).filter((t=>t.score>0)).sort(((t,e)=>e.score-t.score)).map((t=>t.option)):t}calculateRelevanceScore(t,e){const n=t.toLowerCase(),o=e.toLowerCase();let s=0;return n===o?100:(n.startsWith(o)&&(s+=50),n.includes(o)&&(s+=25),s+=this.getContextualBonus(t,e),e.length<3&&t.length>20&&(s-=10),Math.max(0,s))}getContextualBonus(t,e){let n=0;return/^\d/.test(e)&&/math|number|arithmetic|calculate/.test(t.toLowerCase())&&(n+=15),/^["']/.test(e)&&/text|string|concat|join/.test(t.toLowerCase())&&(n+=15),/^(true|false)/i.test(e)&&/logic|boolean|compare|if/.test(t.toLowerCase())&&(n+=15),/set|get|var/i.test(e)&&/variable|var|get|set/.test(t.toLowerCase())&&(n+=15),n}combineOptions(t,e,n){const o=[],s=new Set;for(const e of t){const t=`${e.blockType}:${e.displayText}`;s.has(t)||(o.push(e),s.add(t))}const i=Math.max(10,20-t.length);for(const t of e.slice(0,i)){const e=`${t.blockType}:${t.displayText}`;s.has(e)||(o.push(t),s.add(e))}if(o.length<5&&n.length<3){const t=["if","repeat","set variable","math","text","true","false"];for(const e of t){const t=b(e),n=`${t.blockType}:${t.displayText}`;!s.has(n)&&o.length<10&&(o.push(t),s.add(n))}}return o}setScopeAnalyzer(t){super.setScopeAnalyzer(t)}}class y{constructor(t){this.workspace=t,this._needsReload=!0,this.eventListeners=[],this.setupEventListeners()}get needsReload(){return this._needsReload}invalidate(t){this._needsReload||(console.debug(`TypeBlocking options invalidated: ${t}`),this._needsReload=!0)}markReloaded(){this._needsReload=!1}dispose(){this.eventListeners.forEach((t=>t())),this.eventListeners=[]}setupEventListeners(){this.addEventHandler(i.Events.VAR_CREATE,"variable created"),this.addEventHandler(i.Events.VAR_DELETE,"variable deleted"),this.addEventHandler(i.Events.VAR_RENAME,"variable renamed"),this.addEventHandler(i.Events.BLOCK_CREATE,(t=>{this.handleBlockEvent(t)})),this.addEventHandler(i.Events.BLOCK_DELETE,(t=>{this.handleBlockEvent(t)})),this.addEventHandler(i.Events.BLOCK_CHANGE,(t=>{this.handleBlockChangeEvent(t)})),this.addEventHandler(i.Events.FINISHED_LOADING,"workspace loaded"),this.addWorkspaceChangeListener()}addEventHandler(t,e){const n=t=>{t.workspaceId===this.workspace.id&&("string"==typeof e?this.invalidate(e):e(t))};this.workspace.addChangeListener(n),this.eventListeners.push((()=>{this.workspace.removeChangeListener(n)}))}handleBlockEvent(t){const e=t.type;e&&this.isProcedureBlock(e)&&this.invalidate(`procedure block ${e}`)}handleBlockChangeEvent(t){const e=this.workspace.getBlockById(t.blockId);e&&this.isProcedureBlock(e.type)&&"field"===t.element&&"NAME"===t.name&&this.invalidate(`procedure name changed from ${t.oldValue} to ${t.newValue}`)}addWorkspaceChangeListener(){let t=null;const e=e=>{e.workspaceId===this.workspace.id&&(t&&clearTimeout(t),t=setTimeout((()=>{this.shouldInvalidateForGeneralChange(e)&&this.invalidate("workspace change"),t=null}),100))};this.workspace.addChangeListener(e),this.eventListeners.push((()=>{this.workspace.removeChangeListener(e),t&&clearTimeout(t)}))}isProcedureBlock(t){return"procedures_defnoreturn"===t||"procedures_defreturn"===t||"procedures_callnoreturn"===t||"procedures_callreturn"===t}shouldInvalidateForGeneralChange(t){return!["selected","click","theme_change","viewport_change"].includes(t.type)}}class v{constructor(t){this.workspace=t}getLocalVariablesInScope(){const t=this.getLocalVariablesFromSelection();return t.length>0?(console.log("Using selection context for local variables:",t),t):(console.log("No selection context available, falling back to all procedure parameters."),this.getAllProcedureParameters())}getLocalVariablesFromSelection(){const t=this.getEnclosingProcedureFromSelection();return t?this.getProcedureParameters(t):[]}getAllProcedureParameters(){const t=[],e=this.workspace.getAllBlocks(!1);for(const n of e)this.isProcedureDefinition(n)&&t.push(...this.getProcedureParameters(n));return[...new Set(t)]}getEnclosingProcedureFromSelection(){const t=i.common.getSelected();return t&&t instanceof i.BlockSvg?this.findEnclosingProcedure(t):null}findEnclosingProcedure(t){let e=t;for(;e;){if(this.isProcedureDefinition(e))return e;const t=e.getParent();if(t&&this.isProcedureDefinition(t))return t;e=t}return null}getProcedureParameters(t){const e=[];if(this.isProcedureDefinition(t)){if(t.getVars){const n=t.getVars();Array.isArray(n)&&e.push(...n)}const n=t.inputList;for(const t of n)for(const n of t.fieldRow)if(n.name&&n.name.startsWith("ARG")){const t=n.getValue();t&&"string"==typeof t&&t.trim()&&e.push(t.trim())}}return e}isProcedureDefinition(t){return"procedures_defnoreturn"===t.type||"procedures_defreturn"===t.type}}const C=(t,e)=>{const n=e.trim().toLowerCase();return n?t.filter((t=>t.displayText.toLowerCase().includes(n))):t};class w{constructor(t,e=""){this.highlighted=-1,this.suggestions=[],this.root=document.createElement("div"),this.root.innerHTML='\n      <input type="text" spellcheck="false" class="fi-input" />\n      <ul class="fi-list" hidden></ul>\n    ',this.input=this.root.querySelector(".fi-input"),this.list=this.root.querySelector(".fi-list"),this.input.value=e,this.list.addEventListener("mousedown",(e=>{e.preventDefault();const n=e.target.closest("li");if(n){const e=parseInt(n.dataset.idx,10);t(this.suggestions[e])}}))}focus(){this.input.focus();const t=this.input.value.length;this.input.setSelectionRange(t,t)}setSuggestions(t){this.suggestions=t,this.list.innerHTML="",t.forEach(((t,e)=>{const n=document.createElement("li");n.dataset.idx=e.toString(),n.textContent=t.displayText,this.list.appendChild(n)})),t.length>0?this.updateHighlight(0):this.highlighted=-1,this.list.hidden=0===t.length}onKey(t,e){const n=()=>this.highlighted>=0&&this.highlighted<this.suggestions.length&&(e(this.suggestions[this.highlighted]),!0);switch(t){case"ArrowDown":return this.updateHighlight(Math.min(this.highlighted+1,this.suggestions.length-1)),!0;case"ArrowUp":return this.updateHighlight(Math.max(this.highlighted-1,0)),!0;case"Enter":case"Tab":return n();default:return!1}}get query(){return this.input.value}get inputEl(){return this.input}updateHighlight(t){const e=Array.from(this.list.children);this.highlighted>=0&&e[this.highlighted].classList.remove("fi-hl"),this.highlighted=t,this.highlighted>=0&&(e[this.highlighted].classList.add("fi-hl"),e[this.highlighted].scrollIntoView({block:"nearest"}))}}class T{constructor(t){this.workspace=t}createBlock(t,e,n){let o=this.createSpecialBlock(t);if(o)return o;let s=t;if(!i.Blocks[s])for(const e in i.Blocks)if(i.Blocks[e].typeblock===t){s=e;break}if(!i.Blocks[s])return void console.warn(`No block registered for "${t}"`);const r={type:s};if(n){r.fields={};for(const[t,e]of Object.entries(n))r.fields[t]=e}return e&&(r.extraState=e),i.serialization.blocks.append(r,this.workspace)}createBlockFromInstruction(t){try{const e=this.workspace.newBlock(t.blockType);if(t.fieldValues)for(const[n,o]of Object.entries(t.fieldValues)){const t=e.getField(n);if(t)if("VAR"!==n||"variables_set"!==e.type&&"variables_get"!==e.type)t.setValue(o);else{let e=this.workspace.getVariable(o);e||(e=this.workspace.createVariable(o)),t.setValue(e.getId())}}if(e.initSvg(),e.render(),t.children)for(const n of t.children){const t=this.createBlockFromInstruction(n.instruction);if(t){const o=e.getInput(n.input);o&&t.outputConnection&&t.outputConnection.connect(o.connection)}}return e}catch(t){return void console.warn("Failed to create block from instruction:",t)}}createSpecialBlock(t){const e=t.match(/^get\s+(.+)$/);if(e)return this.createVariableGetter(e[1]);const n=t.match(/^set\s+(.+?)\s+to$/);if(n)return this.createVariableSetter(n[1]);const o=t.match(/^([^(]+)(?:\([^)]*\))?$/);return o&&this.isProcedureName(o[1].trim())?this.createProcedureCall(o[1].trim()):void 0}createVariableGetter(t){var e;const n=this.workspace.getVariable(t);if(!n)return void console.warn(`Variable "${t}" not found`);const o=this.workspace.newBlock("variables_get");return null===(e=o.getField("VAR"))||void 0===e||e.setValue(n.getId()),o.initSvg(),o.render(),o}createVariableSetter(t){var e;const n=this.workspace.getVariable(t);if(!n)return void console.warn(`Variable "${t}" not found`);const o=this.workspace.newBlock("variables_set");return null===(e=o.getField("VAR"))||void 0===e||e.setValue(n.getId()),o.initSvg(),o.render(),o}createProcedureCall(t){var e,n;const o=this.workspace.getAllBlocks(!1);let s=!1;for(const n of o)if(("procedures_defnoreturn"===n.type||"procedures_defreturn"===n.type)&&(null===(e=n.getField("NAME"))||void 0===e?void 0:e.getValue())===t){s="procedures_defreturn"===n.type;break}const i=s?"procedures_callreturn":"procedures_callnoreturn",r=this.workspace.newBlock(i);return null===(n=r.getField("NAME"))||void 0===n||n.setValue(t),r.initSvg(),r.render(),r}isProcedureName(t){var e;const n=this.workspace.getAllBlocks(!1);for(const o of n)if(("procedures_defnoreturn"===o.type||"procedures_defreturn"===o.type)&&(null===(e=o.getField("NAME"))||void 0===e?void 0:e.getValue())===t)return!0;return!1}}class x{constructor(t){this.workspace=t,this.offsetCount=0}positionBlock(t,e,n){const o=this.workspace.getMetrics(),s=this.workspace.getInjectionDiv().getBoundingClientRect(),i=null!=e?e:s.left+s.width/2,r=null!=n?n:s.top+s.height/2;let c=(i-s.left)/this.workspace.scale+o.viewLeft,a=(r-s.top)/this.workspace.scale+o.viewTop;if(this.lastCreationX===i&&this.lastCreationY===r){this.offsetCount++;const t=this.offsetCount*x.OFFSET_STEP/this.workspace.scale;c+=t,a+=t}else this.offsetCount=0,this.lastCreationX=i,this.lastCreationY=r;t.moveBy(c,a)}}x.OFFSET_STEP=30;class P{areTypesCompatible(t,e){if(!t||!e)return!1;const n=t.getCheck(),o=e.getCheck();return!n||!o||n.some((t=>o.includes(t)))}isConnectionAvailable(t){return t&&!t.isConnected()}getWorkspaceScale(t){return t.scale||1}calculateDistance(t,e){const n=t.x-e.x,o=t.y-e.y;return Math.sqrt(n*n+o*o)}}class S extends P{constructor(){super(...arguments),this.priority=90,this.name="StatementSequence"}canConnect(t,e){const n=t.previousConnection;if(!n)return!1;const o=e.nextConnection;return!(!o||o.isConnected())&&this.areTypesCompatible(n,o)}connect(t,e){const n=t.previousConnection,o=e.nextConnection;if(!this.canConnect(t,e))return{success:!1,reason:"Blocks not compatible for statement sequence connection"};try{return n.connect(o),{success:!0,connectionType:"statement_sequence",targetConnection:o}}catch(t){return{success:!1,reason:`Connection failed: ${t}`}}}}class B extends P{constructor(){super(...arguments),this.priority=80,this.name="ValueInput"}canConnect(t,e){return!!t.outputConnection&&null!==this.findCompatibleInput(t,e)}connect(t,e){const n=t.outputConnection;if(!n)return{success:!1,reason:"New block has no output connection"};const o=this.findCompatibleInput(t,e);if(!o)return{success:!1,reason:"No compatible input connection found"};try{return n.connect(o),{success:!0,connectionType:"value_input",targetConnection:o}}catch(t){return{success:!1,reason:`Connection failed: ${t}`}}}findCompatibleInput(t,e){const n=t.outputConnection;if(!n)return null;for(const t of e.inputList)if(t.connection&&this.isConnectionAvailable(t.connection)&&this.areTypesCompatible(n,t.connection))return t.connection;return null}}class E extends P{constructor(){super(...arguments),this.priority=70,this.name="StatementInsertion"}canConnect(t,e){const n=t.nextConnection,o=t.previousConnection;if(!n||!o)return!1;const s=e.previousConnection;return!!s&&this.areTypesCompatible(n,s)&&this.areTypesCompatible(o,s)}connect(t,e){const n=t.nextConnection,o=t.previousConnection,s=e.previousConnection;if(!this.canConnect(t,e))return{success:!1,reason:"Blocks not compatible for statement insertion"};try{const t=s.targetConnection;return t&&(s.disconnect(),o.connect(t)),n.connect(s),{success:!0,connectionType:"statement_insertion",targetConnection:s}}catch(t){return{success:!1,reason:`Connection failed: ${t}`}}}}class $ extends P{constructor(){super(...arguments),this.priority=60,this.name="Wrapper"}canConnect(t,e){const n=this.getStatementInputs(t);if(0===n.length)return!1;const o=e.previousConnection;return!!o&&this.areTypesCompatible(o,n[0])}connect(t,e){const n=this.getStatementInputs(t),o=e.previousConnection;if(!this.canConnect(t,e))return{success:!1,reason:"Blocks not compatible for wrapping"};try{const e=o.targetConnection;if(e){o.disconnect();const n=t.previousConnection;n&&this.areTypesCompatible(n,e)&&n.connect(e)}return o.connect(n[0]),{success:!0,connectionType:"wrapper",targetConnection:n[0]}}catch(t){return{success:!1,reason:`Connection failed: ${t}`}}}getStatementInputs(t){const e=[];for(const n of t.inputList)n.type===i.inputs.inputTypes.STATEMENT&&n.connection&&e.push(n.connection);return e}}class O{constructor(t,e={}){var n,o,s,i;this.workspace=t,this.config={enableAutoConnection:null===(n=e.enableAutoConnection)||void 0===n||n,connectionRadius:null!==(o=e.connectionRadius)&&void 0!==o?o:200,maxNearbyBlocks:null!==(s=e.maxNearbyBlocks)&&void 0!==s?s:10,strategies:null!==(i=e.strategies)&&void 0!==i?i:this.getDefaultStrategies()},this.connectionStrategies=this.config.strategies.sort(((t,e)=>e.priority-t.priority))}getDefaultStrategies(){return[new S,new B,new E,new $]}attemptConnection(t,e,n,o){if(!this.config.enableAutoConnection)return null;const s=this.buildConnectionContext(t,e,n,o);return this.findAndMakeConnection(t,s)}buildConnectionContext(t,e,n,o){const s=Object.assign({},o);if(!s.selectedBlock){const t=i.common.getSelected();t&&t instanceof i.BlockSvg&&(s.selectedBlock=t)}return void 0!==e&&void 0!==n&&(s.cursorPosition={x:e,y:n}),s.nearbyBlocks||(s.nearbyBlocks=this.findNearbyBlocks(t,s.cursorPosition)),s}findAndMakeConnection(t,e){const n=this.getPriorizedTargetBlocks(t,e);for(const o of n)for(const n of this.connectionStrategies)if(n.canConnect(t,o,e)){console.debug(`Attempting connection with strategy: ${n.name}`);const s=n.connect(t,o,e);if(s.success)return console.debug(`Successfully connected using strategy: ${n.name}`),s;console.debug(`Connection failed with strategy ${n.name}: ${s.reason}`)}return console.debug("No suitable connection found for new block"),null}getPriorizedTargetBlocks(t,e){const n=[];if(e.selectedBlock&&n.push(e.selectedBlock),e.nearbyBlocks){const o=e.nearbyBlocks.filter((t=>t!==e.selectedBlock)).sort(((n,o)=>{const s=this.connectionStrategies.find((t=>"ValueInput"===t.name));if(!s)return 0;const i=s.canConnect(t,n,e),r=s.canConnect(t,o,e);if(i&&!r)return-1;if(!i&&r)return 1;if(i&&r){const t=this.countConnectedInputs(n),e=this.countConnectedInputs(o);if(t!==e)return t-e}return 0}));n.push(...o)}return[...new Set(n)]}findNearbyBlocks(t,e){const n=t.getRelativeToSurfaceXY(),o=e?this.clientToWorkspaceCoordinates(e.x,e.y):n,s=this.workspace.getAllBlocks(!1),i=[];for(const e of s){if(e===t)continue;const n=e.getRelativeToSurfaceXY(),s=this.calculateDistance(o,n);s<=this.config.connectionRadius&&i.push({block:e,distance:s})}return i.sort(((t,e)=>t.distance-e.distance)),i.slice(0,this.config.maxNearbyBlocks).map((t=>t.block))}clientToWorkspaceCoordinates(t,e){const n=this.workspace.getMetrics(),o=this.workspace.getInjectionDiv().getBoundingClientRect();return{x:(t-o.left)/this.workspace.scale+n.viewLeft,y:(e-o.top)/this.workspace.scale+n.viewTop}}calculateDistance(t,e){const n=t.x-e.x,o=t.y-e.y;return Math.sqrt(n*n+o*o)}getBlockDistance(t,e){const n=t.getRelativeToSurfaceXY(),o=e.cursorPosition?this.clientToWorkspaceCoordinates(e.cursorPosition.x,e.cursorPosition.y):n;return this.calculateDistance(o,n)}hasAvailableInputConnections(t){for(const e of t.inputList)if(e.connection&&!e.connection.isConnected())return!0;return!1}countConnectedInputs(t){let e=0;for(const n of t.inputList)n.connection&&n.connection.isConnected()&&e++;return e}setConfig(t){this.config=Object.assign(Object.assign({},this.config),t),t.strategies&&(this.connectionStrategies=t.strategies.sort(((t,e)=>e.priority-t.priority)))}getConfig(){return Object.assign({},this.config)}}class I{constructor(t,e){var n,o,s,i,r;this.ws=t,this.lastX=0,this.lastY=0,this.pointerMoveListener=t=>{this.lastX=t.x,this.lastY=t.y},this.ws=t,this.options=e.options,this.matcher=null!==(n=e.matcher)&&void 0!==n?n:C,this.optionGenerator=e.optionGenerator,this.inputPositioning={mode:null!==(s=null===(o=e.inputPositioning)||void 0===o?void 0:o.mode)&&void 0!==s?s:"mouse",fixedPosition:null!==(r=null===(i=e.inputPositioning)||void 0===i?void 0:i.fixedPosition)&&void 0!==r?r:{x:100,y:10}},this.blockFactory=new T(t),this.blockPositioner=new x(t),!1!==e.enablePatternRecognition&&(this.patternManager=new l(e.patternConfig),this.patternManager.registerBuiltinPatterns(m())),!1!==e.enableSmartConnection&&(this.connectionManager=new O(t,e.connectionConfig)),t.getInjectionDiv().addEventListener("pointermove",this.pointerMoveListener)}dispose(){this.ws.getInjectionDiv().removeEventListener("pointermove",this.pointerMoveListener)}show(t=""){i.WidgetDiv.show({},this.ws.RTL,(()=>this.ws.getInjectionDiv().focus()),this.ws);const e=new w((t=>this.choose(t)),t);i.WidgetDiv.getDiv().appendChild(e.root),this.positionWidgetDiv();const n=()=>{let t=this.options;this.optionGenerator instanceof k?(console.debug("TypeBlocking: Using smart option generation for query:",e.query),t=this.optionGenerator.generateOptionsForInput(e.query),console.debug("TypeBlocking: Generated",t.length,"options:",t.slice(0,5))):console.debug("TypeBlocking: Using static options, generator type:",typeof this.optionGenerator);const n=this.matcher(t,e.query);console.debug("TypeBlocking: After matching, got",n.length,"options:",n.slice(0,5)),e.setSuggestions(n)};e.inputEl.addEventListener("input",n),n(),e.inputEl.addEventListener("keydown",(t=>{e.onKey(t.key,(t=>this.choose(t)))?t.preventDefault():"Escape"===t.key&&i.WidgetDiv.hide(),t.stopPropagation()})),e.inputEl.addEventListener("blur",(()=>i.WidgetDiv.hide())),setTimeout((()=>e.focus()))}choose(t){let e;if(console.debug("TypeBlocking: Choosing option:",t),this.patternManager){console.debug("TypeBlocking: Trying pattern recognition for:",t.blockType);const n=this.patternManager.getBlockInstructions(t.blockType);n&&(console.debug("TypeBlocking: Found pattern instruction:",n),e=this.blockFactory.createBlockFromInstruction(n),e&&console.debug("TypeBlocking: Created block using pattern recognition:",e.type))}e||(console.debug("TypeBlocking: Falling back to regular block creation"),e=this.blockFactory.createBlock(t.blockType,t.extraState,t.fieldValues),e&&console.debug("TypeBlocking: Created block using regular method:",e.type)),e?(this.blockPositioner.positionBlock(e,this.lastX,this.lastY),this.connectionManager&&this.connectionManager.attemptConnection(e,this.lastX,this.lastY)):console.warn("TypeBlocking: Failed to create block for option:",t),i.WidgetDiv.hide(),this.ws.getInjectionDiv().focus()}positionWidgetDiv(){const t=i.WidgetDiv.getDiv();let e,n;if("fixed"===this.inputPositioning.mode){const t=this.ws.getInjectionDiv().getBoundingClientRect();e=t.left+this.inputPositioning.fixedPosition.x,n=t.top+this.inputPositioning.fixedPosition.y}else if(e=this.lastX,n=this.lastY,!e&&!n){const t=this.ws.getInjectionDiv().getBoundingClientRect();e=t.left+t.width/2,n=t.top+t.height/2}Object.assign(t.style,{position:"fixed",left:`${e}px`,top:`${n}px`})}}class V extends I{constructor(t,e){var n;super(t,{options:e.options,matcher:null!==(n=e.matcher)&&void 0!==n?n:C,enableSmartConnection:e.enableSmartConnection,connectionConfig:e.connectionConfig,enablePatternRecognition:e.enablePatternRecognition,patternConfig:e.patternConfig,optionGenerator:e.optionGenerator,inputPositioning:e.inputPositioning}),this.staticOptions=e.options,this.dynamicOptionGenerator=e.optionGenerator,this.stateTracker=e.stateTracker}getCurrentOptions(){return this.dynamicOptionGenerator&&this.stateTracker?(!this.stateTracker.needsReload&&this.cachedOptions||this.lazyLoadOptions(),this.cachedOptions||this.staticOptions):this.staticOptions}lazyLoadOptions(){if(!this.dynamicOptionGenerator||!this.stateTracker)return;console.debug("TypeBlocking: Regenerating options...");const t=performance.now();try{this.cachedOptions=this.dynamicOptionGenerator.generateOptions(),"markReloaded"in this.stateTracker&&this.stateTracker.markReloaded();const e=performance.now()-t;console.debug(`TypeBlocking: Generated ${this.cachedOptions.length} options in ${e.toFixed(2)}ms`)}catch(t){console.error("TypeBlocking: Error generating options:",t),this.cachedOptions=this.staticOptions}}show(t=""){const e=this.getCurrentOptions();this.options=e,super.show(t)}dispose(){this.cachedOptions=void 0,this.dynamicOptionGenerator=void 0,this.stateTracker=void 0,super.dispose()}}class L{constructor(t){this.workspace=t}init(t={}){const e=!1!==t.enableDynamicOptions;console.log("what am I enabling?",e),e?this.setupDynamicOptions(t):this.setupStaticOptions(t),console.info("Typeblocking initialized on workspace:",this.workspace.id)}invalidateCache(t){var e;null===(e=this.stateTracker)||void 0===e||e.invalidate(t)}setupDynamicOptions(t){if(!1!==t.enablePatternRecognition?this.optionGenerator=t.optionGenerator||new k(this.workspace,t.patternConfig):this.optionGenerator=t.optionGenerator||new a(this.workspace),this.optionGenerator instanceof a){const t=new v(this.workspace);this.optionGenerator.setScopeAnalyzer(t)}this.stateTracker=new y(this.workspace),this.installFloatingInput({options:[],matcher:t.matcher,enableSmartConnection:t.enableSmartConnection,connectionConfig:t.connectionConfig,enablePatternRecognition:t.enablePatternRecognition,patternConfig:t.patternConfig,inputPositioning:t.inputPositioning})}setupStaticOptions(t){const e=t.options||this.generateLegacyOptions();this.installFloatingInput({options:e,matcher:t.matcher,enableSmartConnection:t.enableSmartConnection,connectionConfig:t.connectionConfig,enablePatternRecognition:t.enablePatternRecognition,patternConfig:t.patternConfig,inputPositioning:t.inputPositioning})}generateLegacyOptions(){const t=[];i.Blocks.controls_if.typeblock=i.Msg.CONTROLS_IF_MSG_IF;for(const e in i.Blocks)e.split("_").length>1&&(i.Blocks[e].typeblock||(i.Blocks[e].typeblock=e),t.push(i.Blocks[e].typeblock));return t}dispose(){if(!this.workspace)return;const t=this.workspace;this.stateTracker&&(this.stateTracker.dispose(),this.stateTracker=void 0),this.controller&&(this.controller.dispose(),this.controller=void 0),i.ShortcutRegistry.registry.unregister(r),i.DropDownDiv.hideWithoutAnimation();const e=t.id;this.optionGenerator=void 0,this.workspace=null,console.info(`Typeblocking disposed from workspace ${e}`)}installFloatingInput({options:t=[],matcher:e,enableSmartConnection:n,connectionConfig:o,enablePatternRecognition:s,patternConfig:c,inputPositioning:a}){this.controller=new V(this.workspace,{options:t,matcher:e,optionGenerator:this.optionGenerator,stateTracker:this.stateTracker,enableSmartConnection:n,connectionConfig:o,enablePatternRecognition:s,patternConfig:c,inputPositioning:a}),i.ShortcutRegistry.registry.register({name:r,preconditionFn:()=>!i.FieldTextInput.activeField&&!i.WidgetDiv.isVisible(),callback:(t,e)=>{const n=e;var o;return this.controller.show(1!==(o=n).key.length||o.ctrlKey||o.metaKey||o.altKey?"":n.key),!0}},!0);const l=new Set([8,13,16,46]);for(let t=0;t<=222;++t)l.has(t)||(i.ShortcutRegistry.registry.addKeyMapping(t,r,!0),i.ShortcutRegistry.registry.addKeyMapping(i.ShortcutRegistry.registry.createSerializedKey(t,[i.utils.KeyCodes.SHIFT]),r,!0))}}return s})()));
//# sourceMappingURL=index.js.map