var Blockly={};Blockly.pathToBlockly='./';Blockly.SVG_NS='http://www.w3.org/2000/svg';Blockly.HTML_NS='http://www.w3.org/1999/xhtml';Blockly.HSV_SATURATION=0.45;Blockly.HSV_VALUE=0.65;Blockly.makeColour=function(hue){hue%=360;var topLimit=Blockly.HSV_VALUE;var bottomLimit=Blockly.HSV_VALUE*(1-Blockly.HSV_SATURATION);var rangeUp=(topLimit-bottomLimit)*(hue%60/60)+bottomLimit;var rangeDown=(topLimit-bottomLimit)*(1-hue%60/60)+bottomLimit;var r,g,b;if(0<=hue&&hue<60){r=topLimit;g=rangeUp;b=bottomLimit}else if(60<=hue&&hue<120){r=rangeDown;g=topLimit;b=bottomLimit}else if(120<=hue&&hue<180){r=bottomLimit;g=topLimit;b=rangeUp}else if(180<=hue&&hue<240){r=bottomLimit;g=rangeDown;b=topLimit}else if(240<=hue&&hue<300){r=rangeUp;g=bottomLimit;b=topLimit}else if(300<=hue&&hue<360){r=topLimit;g=bottomLimit;b=rangeDown}else{r=0;g=0;b=0}r=Math.floor(r*16);g=Math.floor(g*16);b=Math.floor(b*16);var HEX='0123456789abcdef';return'#'+HEX.charAt(r)+HEX.charAt(g)+HEX.charAt(b)};Blockly.INPUT_VALUE=1;Blockly.OUTPUT_VALUE=2;Blockly.NEXT_STATEMENT=3;Blockly.PREVIOUS_STATEMENT=4;Blockly.LOCAL_VARIABLE=5;Blockly.OPPOSITE_TYPE=[];Blockly.OPPOSITE_TYPE[Blockly.INPUT_VALUE]=Blockly.OUTPUT_VALUE;Blockly.OPPOSITE_TYPE[Blockly.OUTPUT_VALUE]=Blockly.INPUT_VALUE;Blockly.OPPOSITE_TYPE[Blockly.NEXT_STATEMENT]=Blockly.PREVIOUS_STATEMENT;Blockly.OPPOSITE_TYPE[Blockly.PREVIOUS_STATEMENT]=Blockly.NEXT_STATEMENT;Blockly.SOUNDS_={};Blockly.selected=null;Blockly.editable=true;Blockly.highlightedConnection_=null;Blockly.localConnection_=null;Blockly.DRAG_RADIUS=5;Blockly.SNAP_RADIUS=12;Blockly.BUMP_DELAY=250;Blockly.svgDoc=null;Blockly.mainWorkspace=null;Blockly.svgSize=function(){return{width:Blockly.svg.cachedWidth_,height:Blockly.svg.cachedHeight_,top:Blockly.svg.cachedTop_,left:Blockly.svg.cachedLeft_}};Blockly.svgResize=function(){var width=Blockly.svg.parentNode.offsetWidth;var height=Blockly.svg.parentNode.offsetHeight;if(Blockly.svg.cachedWidth_!=width){Blockly.svg.setAttribute('width',width+'px');Blockly.svg.cachedWidth_=width}if(Blockly.svg.cachedHeight_!=height){Blockly.svg.setAttribute('height',height+'px');Blockly.svg.cachedHeight_=height}var bBox=Blockly.svg.getBoundingClientRect();Blockly.svg.cachedLeft_=bBox.left;Blockly.svg.cachedTop_=bBox.top};Blockly.onMouseDown_=function(e){Blockly.hideChaff();Blockly.removeAllRanges();if(Blockly.isTargetInput_(e)||(Blockly.Mutator&&Blockly.Mutator.isOpen)){return}if(Blockly.selected&&e.target.nodeName=='svg'){Blockly.selected.unselect()}if(e.button==2){if(Blockly.ContextMenu){Blockly.showContextMenu_(e.clientX,e.clientY)}}else if(e.target.nodeName=='svg'||!Blockly.editable){Blockly.mainWorkspace.dragMode=true;Blockly.mainWorkspace.startDragMouseX=e.clientX;Blockly.mainWorkspace.startDragMouseY=e.clientY;Blockly.mainWorkspace.startDragMetrics=Blockly.getMainWorkspaceMetrics();Blockly.mainWorkspace.startScrollX=Blockly.mainWorkspace.scrollX;Blockly.mainWorkspace.startScrollY=Blockly.mainWorkspace.scrollY}};Blockly.onMouseUp_=function(e){Blockly.setCursorHand_(false);Blockly.mainWorkspace.dragMode=false};Blockly.onMouseMove_=function(e){if(Blockly.mainWorkspace.dragMode){Blockly.removeAllRanges();var dx=e.clientX-Blockly.mainWorkspace.startDragMouseX;var dy=e.clientY-Blockly.mainWorkspace.startDragMouseY;var metrics=Blockly.mainWorkspace.startDragMetrics;var x=Blockly.mainWorkspace.startScrollX+dx;var y=Blockly.mainWorkspace.startScrollY+dy;x=Math.min(x,-metrics.contentLeft);y=Math.min(y,-metrics.contentTop);x=Math.max(x,metrics.viewWidth-metrics.contentLeft-metrics.contentWidth);y=Math.max(y,metrics.viewHeight-metrics.contentTop-metrics.contentHeight);Blockly.mainWorkspace.scrollbar.set(-x-metrics.contentLeft,-y-metrics.contentTop)}};Blockly.onKeyDown_=function(e){if(Blockly.isTargetInput_(e)){return}if(e.keyCode==27){Blockly.hideChaff();if(Blockly.Mutator&&Blockly.Mutator.isOpen){Blockly.Mutator.closeDialog()}}else if(e.keyCode==8||e.keyCode==46){if(Blockly.selected&&Blockly.selected.editable&&(!Blockly.Mutator||!Blockly.Mutator.isOpen)){Blockly.hideChaff();Blockly.playAudio('delete');Blockly.selected.destroy(true)}e.preventDefault()}};Blockly.showContextMenu_=function(x,y){var options=[];var helpOption={enabled:false};helpOption.text=Blockly.MSG_HELP;helpOption.callback=function(){};options.push(helpOption);Blockly.ContextMenu.show(x,y,options)};Blockly.onContextMenu_=function(e){if(!Blockly.isTargetInput_(e)&&Blockly.ContextMenu){e.preventDefault()}};Blockly.hideChaff=function(opt_allowToolbox){Blockly.Tooltip&&Blockly.Tooltip.hide();Blockly.ContextMenu&&Blockly.ContextMenu.hide();Blockly.FieldDropdown.hideMenu();if(Blockly.Toolbox&&!opt_allowToolbox){Blockly.Toolbox.clearSelection()}};Blockly.removeAllRanges=function(){if(window.getSelection){var sel=window.getSelection();if(sel&&sel.removeAllRanges){sel.removeAllRanges();window.setTimeout(function(){window.getSelection().removeAllRanges()},0)}}};Blockly.isTargetInput_=function(e){return e.target.type=='textarea'||e.target.type=='text'};Blockly.loadAudio_=function(name){var sound=new Audio(Blockly.pathToBlockly+'media/'+name+'.wav');if(sound&&sound.play){sound.play();sound.pause();Blockly.SOUNDS_[name]=sound}};Blockly.playAudio=function(name){var sound=Blockly.SOUNDS_[name];if(sound){sound.play()}};Blockly.setCursorHand_=function(closed){if(!Blockly.editable){return}var cursor='';if(closed){cursor='url('+Blockly.pathToBlockly+'media/handclosed.cur) 7 3, auto'}if(Blockly.selected){Blockly.selected.getSvgRoot().style.cursor=cursor}Blockly.svgDoc.getElementsByTagName('svg')[0].style.cursor=cursor};Blockly.getMainWorkspaceMetrics=function(){var hwView=Blockly.svgSize();if(Blockly.Toolbox){hwView.width-=Blockly.Toolbox.width}var viewWidth=hwView.width-Blockly.Scrollbar.scrollbarThickness;var viewHeight=hwView.height-Blockly.Scrollbar.scrollbarThickness;try{var blockBox=Blockly.mainWorkspace.getCanvas().getBBox()}catch(e){return null}if(blockBox.width==-Infinity&&blockBox.height==-Infinity){blockBox={width:0,height:0,x:0,y:0}}var leftEdge=Math.min(blockBox.x-viewWidth/2,blockBox.x+blockBox.width-viewWidth);var rightEdge=Math.max(blockBox.x+blockBox.width+viewWidth/2,blockBox.x+viewWidth);var topEdge=Math.min(blockBox.y-viewHeight/2,blockBox.y+blockBox.height-viewHeight);var bottomEdge=Math.max(blockBox.y+blockBox.height+viewHeight/2,blockBox.y+viewHeight);var absoluteLeft=0;if(Blockly.Toolbox&&!Blockly.RTL){absoluteLeft=Blockly.Toolbox.width}return{viewHeight:hwView.height,viewWidth:hwView.width,contentHeight:bottomEdge-topEdge,contentWidth:rightEdge-leftEdge,viewTop:-Blockly.mainWorkspace.scrollY,viewLeft:-Blockly.mainWorkspace.scrollX,contentTop:topEdge,contentLeft:leftEdge,absoluteTop:0,absoluteLeft:absoluteLeft}};Blockly.setMainWorkspaceMetrics=function(xyRatio){var metrics=Blockly.getMainWorkspaceMetrics();if(typeof xyRatio.x=='number'){Blockly.mainWorkspace.scrollX=-metrics.contentWidth*xyRatio.x-metrics.contentLeft}if(typeof xyRatio.y=='number'){Blockly.mainWorkspace.scrollY=-metrics.contentHeight*xyRatio.y-metrics.contentTop}var translation='translate('+(Blockly.mainWorkspace.scrollX+metrics.absoluteLeft)+','+(Blockly.mainWorkspace.scrollY+metrics.absoluteTop)+')';Blockly.mainWorkspace.getCanvas().setAttribute('transform',translation);Blockly.commentCanvas.setAttribute('transform',translation)};Blockly.cssLoaded=function(){Blockly.Toolbox&&Blockly.Toolbox.redraw()};Blockly.removeChildren_=function(node){var child;while((child=node.firstChild)){node.removeChild(child)}};Blockly.addClass_=function(node,className){var classes=node.getAttribute('class')||'';if((' '+classes+' ').indexOf(' '+className+' ')==-1){if(classes){classes+=' '}node.setAttribute('class',classes+className)}};Blockly.removeClass_=function(node,className){var classes=node.getAttribute('class');if((' '+classes+' ').indexOf(' '+className+' ')!=-1){var classList=classes.split(/\s+/);for(var x=0;x<classList.length;x++){if(!classList[x]||classList[x]==className){classList.splice(x,1);x--}}if(classList.length){node.setAttribute('class',classList.join(' '))}else{node.removeAttribute('class')}}};Blockly.bindEvent_=function(element,name,thisObject,func){var wrapFunc;if(element.addEventListener){wrapFunc=function(e){func.apply(thisObject,arguments)};element.addEventListener(name,wrapFunc,false)}else{wrapFunc=function(e){func.apply(thisObject,arguments);e.stopPropagation()};element.attachEvent('on'+name,wrapFunc)}return wrapFunc};Blockly.unbindEvent_=function(element,name,func){if(element.removeEventListener){element.removeEventListener(name,func,false)}else{element.detachEvent('on'+name,func)}};Blockly.fireUiEvent=function(doc,element,eventName){if(doc.createEvent){var evt=doc.createEvent('UIEvents');evt.initEvent(eventName,true,true);element.dispatchEvent(evt)}else if(doc.createEventObject){var evt=doc.createEventObject();element.fireEvent('on'+eventName,evt)}else{throw'FireEvent: No event creation mechanism.';}};Blockly.noEvent=function(e){e.stopPropagation()};Blockly.getRelativeXY_=function(element){var xy={x:0,y:0};var x=element.getAttribute('x');if(x){xy.x=parseInt(x,10)}var y=element.getAttribute('y');if(y){xy.y=parseInt(y,10)}var transform=element.getAttribute('transform');var r=transform&&transform.match(/translate\(\s*([-\d.]+)(,\s*([-\d.]+)\s*\))?/);if(r){xy.x+=parseInt(r[1],10);if(r[3]){xy.y+=parseInt(r[3],10)}}return xy};Blockly.getAbsoluteXY_=function(element){var x=0;var y=0;do{var xy=Blockly.getRelativeXY_(element);x+=xy.x;y+=xy.y;element=element.parentNode}while(element&&element!=Blockly.svgDoc);return{x:x,y:y}};Blockly.createSvgElement=function(name,attrs,parent){var e=Blockly.svgDoc.createElementNS(Blockly.SVG_NS,name);for(var key in attrs){e.setAttribute(key,attrs[key])}if(parent){parent.appendChild(e)}return e};Blockly.caseInsensitiveComparator=function(a,b){a=a.toLowerCase();b=b.toLowerCase();if(a>b){return 1}if(a<b){return-1}return 0};Blockly.uniqueId=function(){var soup='abcdefghijklmnopqrstuvwxyz';var id=soup.charAt(Math.random()*soup.length);soup+='0123456789-_:.';for(var x=1;x<8;x++){id+=soup.charAt(Math.random()*soup.length)}if(id.indexOf('--')!=-1){id=Blockly.uniqueId()}return id};Blockly.Block=function(workspace,prototypeName){this.id=Blockly.uniqueId();this.titleRow=[];this.outputConnection=null;this.nextConnection=null;this.previousConnection=null;this.inputList=[];this.inputsInline=false;this.rendered=false;this.comment=null;this.collapsed=false;this.editable=workspace.editable;this.tooltip='';this.contextMenu=true;this.parentBlock_=null;this.childBlocks_=[];this.isInFlyout=false;this.workspace=workspace;workspace.addTopBlock(this);if(prototypeName){this.type=prototypeName;var prototype=Blockly.Language[prototypeName];if(!prototype){throw'Error: "'+prototypeName+'" is an unknown language block.';}for(var name in prototype){this[name]=prototype[name]}}if(typeof this.init=='function'){this.init()}};Blockly.Block.prototype.svg_=null;Blockly.Block.prototype.initSvg=function(){this.svg_=new Blockly.BlockSvg(this);this.svg_.init();Blockly.bindEvent_(this.svg_.getRootNode(),'mousedown',this,this.onMouseDown_);this.workspace.getCanvas().appendChild(this.svg_.getRootNode())};Blockly.Block.prototype.getSvgRoot=function(){return this.svg_&&this.svg_.getRootNode()};Blockly.Block.dragMode_=0;Blockly.Block.onMouseUpWrapper_=null;Blockly.Block.onMouseMoveWrapper_=null;Blockly.Block.unbindDragEvents_=function(e){if(Blockly.Block.onMouseUpWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mouseup',Blockly.Block.onMouseUpWrapper_);Blockly.Block.onMouseUpWrapper_=null}if(Blockly.Block.onMouseMoveWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mousemove',Blockly.Block.onMouseMoveWrapper_);Blockly.Block.onMouseMoveWrapper_=null}};Blockly.Block.prototype.select=function(){if(Blockly.selected){Blockly.selected.unselect()}Blockly.selected=this;this.svg_.addSelect();Blockly.fireUiEvent(Blockly.svgDoc,this.workspace.getCanvas(),'blocklySelectChange')};Blockly.Block.prototype.unselect=function(){Blockly.selected=null;this.svg_.removeSelect();Blockly.fireUiEvent(Blockly.svgDoc,this.workspace.getCanvas(),'blocklySelectChange')};Blockly.Block.prototype.destroy=function(gentle){if(this.outputConnection){this.setParent(null)}else{var previousTarget=null;if(this.previousConnection&&this.previousConnection.targetConnection){previousTarget=this.previousConnection.targetConnection;this.setParent(null)}if(gentle&&this.nextConnection&&this.nextConnection.targetConnection){var nextTarget=this.nextConnection.targetConnection;var nextBlock=this.nextConnection.targetBlock();this.nextConnection.disconnect();nextBlock.setParent(null);if(previousTarget){previousTarget.connect(nextTarget)}}}this.workspace.removeTopBlock(this);this.rendered=false;if(Blockly.selected==this){Blockly.selected=null;Blockly.Block.unbindDragEvents_()}for(var x=this.childBlocks_.length-1;x>=0;x--){this.childBlocks_[x].destroy(false)}for(var x=0;x<this.titleRow.length;x++){this.titleRow[x].destroy()}if(this.comment){this.comment.destroy()}if(this.mutator){this.mutator.destroy()}for(var x=0;x<this.inputList.length;x++){var input=this.inputList[x];if(input.label){input.label.destroy()}if(input.destroy){input.destroy()}}this.inputList=[];var connections=this.getConnections_(true);for(var x=0;x<connections.length;x++){var connection=connections[x];if(connection.targetConnection){connection.disconnect()}connections[x].destroy()}if(this.svg_){this.svg_.destroy();this.svg_=null}};Blockly.Block.prototype.getRelativeToSurfaceXY=function(){var element=this.svg_.getRootNode();var x=0;var y=0;do{var xy=Blockly.getRelativeXY_(element);x+=xy.x;y+=xy.y;element=element.parentNode}while(element&&element!=this.workspace.getCanvas());return{x:x,y:y}};Blockly.Block.prototype.moveBy=function(dx,dy){var xy=this.getRelativeToSurfaceXY();this.svg_.getRootNode().setAttribute('transform','translate('+(xy.x+dx)+', '+(xy.y+dy)+')');this.moveConnections_(dx,dy)};Blockly.Block.prototype.onMouseDown_=function(e){Blockly.svgResize();Blockly.Block.unbindDragEvents_();this.select();Blockly.hideChaff(this.isInFlyout);if(e.button==2){if(Blockly.ContextMenu){this.showContextMenu_(e.clientX,e.clientY)}}else if(!this.editable){return}else{Blockly.removeAllRanges();Blockly.setCursorHand_(true);var xy=this.getRelativeToSurfaceXY();this.startDragX=xy.x;this.startDragY=xy.y;this.startDragMouseX=e.clientX;this.startDragMouseY=e.clientY;Blockly.Block.dragMode_=1;Blockly.Block.onMouseUpWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mouseup',this,this.onMouseUp_);Blockly.Block.onMouseMoveWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mousemove',this,this.onMouseMove_);this.draggedComments_=[];var descendants=this.getDescendants();for(var x=0,descendant;descendant=descendants[x];x++){if(descendant.comment){var data=descendant.comment.getIconLocation();data.comment=descendant.comment;this.draggedComments_.push(data)}}}e.stopPropagation()};Blockly.Block.prototype.onMouseUp_=function(e){Blockly.Block.unbindDragEvents_();if(Blockly.Block.dragMode_==2){if(Blockly.selected!=this){throw'Dragging no object?';}this.setDragging_(false);var xy=this.getRelativeToSurfaceXY();var dx=xy.x-this.startDragX;var dy=xy.y-this.startDragY;this.moveConnections_(dx,dy);var selected=this;Blockly.fireUiEvent(Blockly.svgDoc,window,'resize');window.setTimeout(function(){selected.bumpNeighbours_()},Blockly.BUMP_DELAY)}Blockly.Block.dragMode_=0;delete this.draggedComments_;if(Blockly.selected&&Blockly.highlightedConnection_){Blockly.playAudio('click');Blockly.localConnection_.connect(Blockly.highlightedConnection_);if(this.workspace.trashcan&&this.workspace.trashcan.isOpen){Blockly.Trashcan.close(this.workspace.trashcan)}}else if(this.workspace.trashcan&&this.workspace.trashcan.isOpen){Blockly.playAudio('delete');Blockly.selected.destroy(false);var trashcan=this.workspace.trashcan;var closure=function(){Blockly.Trashcan.close(trashcan)};window.setTimeout(closure,100);Blockly.fireUiEvent(Blockly.svgDoc,window,'resize')}if(Blockly.highlightedConnection_){Blockly.highlightedConnection_.unhighlight();Blockly.highlightedConnection_=null}};Blockly.Block.prototype.showHelp_=function(){var url=(typeof this.helpUrl=='function')?this.helpUrl():this.helpUrl;if(url){window.open(url)}};Blockly.Block.prototype.showContextMenu_=function(x,y){if(!this.contextMenu){return}var block=this;var options=[];if(this.editable){if(Blockly.Comment&&!this.collapsed){var commentOption={enabled:true};if(this.comment){commentOption.text=Blockly.MSG_REMOVE_COMMENT;commentOption.callback=function(){block.setCommentText(null)}}else{commentOption.text=Blockly.MSG_ADD_COMMENT;commentOption.callback=function(){block.setCommentText('')}}options.push(commentOption)}if(!this.collapsed){for(var i=0;i<this.inputList.length;i++){if(this.inputList[i].type==Blockly.INPUT_VALUE){var inlineOption={enabled:true};inlineOption.text=this.inputsInline?Blockly.MSG_EXTERNAL_INPUTS:Blockly.MSG_INLINE_INPUTS;inlineOption.callback=function(){block.setInputsInline(!block.inputsInline)};options.push(inlineOption);break}}}if(this.collapsed){var expandOption={enabled:true};expandOption.text=Blockly.MSG_EXPAND_BLOCK;expandOption.callback=function(){block.setCollapsed(false)};options.push(expandOption)}else if(this.inputList.length){var collapseOption={enabled:true};collapseOption.text=Blockly.MSG_COLLAPSE_BLOCK;collapseOption.callback=function(){block.setCollapsed(true)};options.push(collapseOption)}var descendantCount=this.getDescendants().length;if(block.nextConnection&&block.nextConnection.targetConnection){descendantCount-=this.nextConnection.targetBlock().getDescendants().length}var deleteOption={text:descendantCount==1?Blockly.MSG_DELETE_BLOCK:Blockly.MSG_DELETE_X_BLOCKS.replace('%1',descendantCount),enabled:true,callback:function(){Blockly.playAudio('delete');block.destroy(true)}};options.push(deleteOption)}var url=(typeof this.helpUrl=='function')?this.helpUrl():this.helpUrl;var helpOption={enabled:!!url};helpOption.text=Blockly.MSG_HELP;helpOption.callback=function(){block.showHelp_()};options.push(helpOption);Blockly.ContextMenu.show(x,y,options)};Blockly.Block.prototype.getConnections_=function(all){var myConnections=[];if(all||this.rendered){if(this.outputConnection){myConnections.push(this.outputConnection)}if(this.nextConnection){myConnections.push(this.nextConnection)}if(this.previousConnection){myConnections.push(this.previousConnection)}if(all||!this.collapsed){for(var x=0,input;input=this.inputList[x];x++){if(input.type!=Blockly.LOCAL_VARIABLE){myConnections.push(input)}}}}return myConnections};Blockly.Block.prototype.moveConnections_=function(dx,dy){if(!this.rendered){return}var myConnections=this.getConnections_(false);for(var x=0;x<myConnections.length;x++){myConnections[x].moveBy(dx,dy)}if(this.comment){this.comment.computeIconLocation()}for(var x=0;x<this.childBlocks_.length;x++){this.childBlocks_[x].moveConnections_(dx,dy)}};Blockly.Block.prototype.setDragging_=function(adding){if(adding){this.svg_.addDragging()}else{this.svg_.removeDragging()}for(var x=0;x<this.childBlocks_.length;x++){this.childBlocks_[x].setDragging_(adding)}};Blockly.Block.prototype.onMouseMove_=function(e){Blockly.removeAllRanges();var dx=e.clientX-this.startDragMouseX;var dy=e.clientY-this.startDragMouseY;if(Blockly.Block.dragMode_==1){var dr=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));if(dr>Blockly.DRAG_RADIUS){Blockly.Block.dragMode_=2;this.setParent(null);this.setDragging_(true)}}if(Blockly.Block.dragMode_==2){var x=this.startDragX+dx;var y=this.startDragY+dy;this.svg_.getRootNode().setAttribute('transform','translate('+x+', '+y+')');for(var x=0;x<this.draggedComments_.length;x++){var commentData=this.draggedComments_[x];commentData.comment.setIconLocation(commentData.x+dx,commentData.y+dy)}var myConnections=this.getConnections_(false);var closestConnection=null;var localConnection=null;var radiusConnection=Blockly.SNAP_RADIUS;for(var i=0;i<myConnections.length;i++){var myConnection=myConnections[i];var neighbour=myConnection.closest(radiusConnection,dx,dy);if(neighbour.connection){closestConnection=neighbour.connection;localConnection=myConnection;radiusConnection=neighbour.radius}}if(Blockly.highlightedConnection_&&Blockly.highlightedConnection_!=closestConnection){Blockly.highlightedConnection_.unhighlight();Blockly.highlightedConnection_=null;Blockly.localConnection_=null}if(closestConnection&&closestConnection!=Blockly.highlightedConnection_){closestConnection.highlight();Blockly.highlightedConnection_=closestConnection;Blockly.localConnection_=localConnection}this.workspace.trashcan&&this.workspace.trashcan.onMouseMove(e)}};Blockly.Block.prototype.bumpNeighbours_=function(){var rootBlock=this.getRootBlock();var myConnections=this.getConnections_(false);for(var x=0;x<myConnections.length;x++){var connection=myConnections[x];if(connection.targetConnection&&(connection.type==Blockly.INPUT_VALUE||connection.type==Blockly.NEXT_STATEMENT)){connection.targetBlock().bumpNeighbours_()}var neighbours=connection.neighbours_(Blockly.SNAP_RADIUS);for(var y=0;y<neighbours.length;y++){var otherConnection=neighbours[y];if(!connection.targetConnection||!otherConnection.targetConnection){if(otherConnection.sourceBlock_.getRootBlock()!=rootBlock){otherConnection.bumpAwayFrom_(connection)}}}}};Blockly.Block.prototype.getParent=function(){return this.parentBlock_};Blockly.Block.prototype.getRootBlock=function(){var rootBlock;var block=this;do{rootBlock=block;block=rootBlock.parentBlock_}while(block);return rootBlock};Blockly.Block.prototype.getChildren=function(){return this.childBlocks_};Blockly.Block.prototype.setParent=function(newParent){if(this.parentBlock_){var children=this.parentBlock_.childBlocks_;for(var child,x=0;child=children[x];x++){if(child==this){children.splice(x,1);break}}var xy=this.getRelativeToSurfaceXY();this.workspace.getCanvas().appendChild(this.svg_.getRootNode());this.svg_.getRootNode().setAttribute('transform','translate('+xy.x+', '+xy.y+')');if(this.previousConnection&&this.previousConnection.targetConnection){this.previousConnection.disconnect()}if(this.outputConnection&&this.outputConnection.targetConnection){this.outputConnection.disconnect()}}else{this.workspace.removeTopBlock(this)}this.parentBlock_=newParent;if(newParent){newParent.childBlocks_.push(this);var oldXY=this.getRelativeToSurfaceXY();newParent.svg_.getRootNode().appendChild(this.svg_.getRootNode());var newXY=this.getRelativeToSurfaceXY();this.moveConnections_(newXY.x-oldXY.x,newXY.y-oldXY.y)}else{this.workspace.addTopBlock(this)}};Blockly.Block.prototype.getDescendants=function(){var blocks=[this];for(var child,x=0;child=this.childBlocks_[x];x++){blocks=blocks.concat(child.getDescendants())}return blocks};Blockly.Block.prototype.getColour=function(){return this.colourHue_};Blockly.Block.prototype.setColour=function(colourHue){this.colourHue_=colourHue;if(this.svg_){this.svg_.updateColour()}if(this.comment){this.comment.updateColour()}if(this.rendered){this.render()}};Blockly.Block.prototype.appendTitle=function(title,opt_name){if(typeof title=='string'){title=new Blockly.FieldLabel(title)}title.name=opt_name;this.titleRow.push(title);if(this.svg_){title.init(this)}if(this.rendered){this.render();this.bumpNeighbours_()}return title};Blockly.Block.prototype.getTitleText=function(name){for(var x=0,title;title=this.titleRow[x];x++){if(title.name===name){return title.getText()}}return null};Blockly.Block.prototype.getTitleValue=function(name){for(var x=0,title;title=this.titleRow[x];x++){if(title.name===name){return title.getValue()}}return null};Blockly.Block.prototype.setTitleText=function(newText,name){for(var x=0,title;title=this.titleRow[x];x++){if(title.name===name){title.setText(newText);return}}throw'Title "'+name+'" not found.';};Blockly.Block.prototype.setTitleValue=function(newValue,name){for(var x=0,title;title=this.titleRow[x];x++){if(title.name===name){title.setValue(newValue);return}}throw'Title "'+name+'" not found.';};Blockly.Block.prototype.setTooltip=function(newTip){this.tooltip=newTip};Blockly.Block.prototype.setPreviousStatement=function(newBoolean){if(this.previousConnection){if(this.previousConnection.targetConnection){throw'Must disconnect previous statement before removing connection.';}this.previousConnection.destroy();this.previousConnection=null}if(newBoolean){if(this.outputConnection){throw'Remove output connection prior to adding previous connection.';}this.previousConnection=new Blockly.Connection(this,Blockly.PREVIOUS_STATEMENT)}if(this.rendered){this.render();this.bumpNeighbours_()}};Blockly.Block.prototype.setNextStatement=function(newBoolean){if(this.nextConnection){if(this.nextConnection.targetConnection){throw'Must disconnect next statement before removing connection.';}this.nextConnection.destroy();this.nextConnection=null}if(newBoolean){this.nextConnection=new Blockly.Connection(this,Blockly.NEXT_STATEMENT)}if(this.rendered){this.render();this.bumpNeighbours_()}};Blockly.Block.prototype.setOutput=function(newBoolean){if(this.outputConnection){if(this.outputConnection.targetConnection){throw'Must disconnect output value before removing connection.';}this.outputConnection.destroy();this.outputConnection=null}if(newBoolean){if(this.previousConnection){throw'Remove previous connection prior to adding output connection.';}this.outputConnection=new Blockly.Connection(this,Blockly.OUTPUT_VALUE)}if(this.rendered){this.render();this.bumpNeighbours_()}};Blockly.Block.prototype.setInputsInline=function(newBoolean){this.inputsInline=newBoolean;if(this.rendered){this.render();this.bumpNeighbours_()}};Blockly.Block.prototype.setCollapsed=function(collapsed){if(this.collapsed==collapsed){return}this.collapsed=collapsed;var display=collapsed?'none':'block';var renderList=[];for(var x=0,input;input=this.inputList[x];x++){if(input.label){var labelElement=input.label.getRootElement?input.label.getRootElement():input.label;labelElement.style.display=display}if(input.targetBlock){if(collapsed){input.hideAll()}else{renderList=renderList.concat(input.unhideAll())}var child=input.targetBlock();if(child){child.svg_.getRootNode().style.display=display;if(collapsed){child.rendered=false}}}else if(input.getText){input.setVisible(!collapsed)}}if(collapsed&&this.comment){this.comment.setPinned(false)}if(renderList.length==0){renderList[0]=this}if(this.rendered){for(var x=0,block;block=renderList[x];x++){block.render()}this.bumpNeighbours_()}};Blockly.Block.prototype.appendInput=function(label,type,name){var textElement=null;if(label){if(typeof label=='string'){textElement=new Blockly.FieldLabel(label)}else if(typeof label=='object'){textElement=label}if(this.svg_){textElement.init(this)}}var input;if(type==Blockly.LOCAL_VARIABLE){input=new Blockly.FieldDropdown(Blockly.Variables.dropdownCreate,Blockly.Variables.dropdownChange);if(this.svg_){input.init(this)}input.type=Blockly.LOCAL_VARIABLE}else{input=new Blockly.Connection(this,type)}input.label=textElement;input.name=name;if(typeof opt_index=='number'){if(opt_index<0||opt_index>this.inputList.length){throw'There are '+this.inputList.length+' input(s), unable to insert at index '+opt_index+'.';}this.inputList.splice(opt_index,0,input)}else{this.inputList.push(input)}if(this.rendered){this.render();this.bumpNeighbours_()}return input};Blockly.Block.prototype.removeInput=function(name){for(var x=0;x<this.inputList.length;x++){var input=this.inputList[x];if(input.name==name){if(input.targetConnection){input.targetBlock().setParent(null)}var field=input.label;if(field){field.destroy()}if(input.destroy){input.destroy()}this.inputList.splice(x,1);if(this.rendered){this.render();this.bumpNeighbours_()}return}}throw'Input "'+name+'" not found.';};Blockly.Block.prototype.getInput=function(name){for(var x=0;x<this.inputList.length;x++){if(this.inputList[x].name==name){return this.inputList[x]}}return null};Blockly.Block.prototype.getInputTargetBlock=function(name){var input=this.getInput(name);return input&&input.targetBlock()};Blockly.Block.prototype.getInputVariable=function(name){var input=this.getInput(name);return input&&input.getText()};Blockly.Block.prototype.setInputVariable=function(name,text){var input=this.getInput(name);if(!input){throw'Input does not exist.';}input.setText(text)};Blockly.Block.prototype.getInputLabelValue=function(name){var input=this.getInput(name);if(input){var label=input.label;if(label){if(label.getText){return label.getValue()}else{return label.textContent}}else{return''}}return null};Blockly.Block.prototype.setMutator=function(mutator){if(this.mutator&&this.mutator!==mutator){this.mutator.destroy()}this.mutator=mutator;if(this.svg_){mutator.createIcon()}};Blockly.Block.prototype.getCommentText=function(){if(this.comment){var comment=this.comment.getText();return comment.replace(/\s+$/,'').replace(/ +\n/g,'\n')}return''};Blockly.Block.prototype.setCommentText=function(text){if(!Blockly.Comment){throw'Comments not supported.';}var changedState=false;if(typeof text=='string'){if(!this.comment){this.comment=new Blockly.Comment(this,Blockly.commentCanvas);changedState=true}this.comment.setText(text)}else{if(this.comment){this.comment.destroy();this.comment=null;changedState=true}}if(this.rendered){this.render();if(changedState){this.bumpNeighbours_()}}};Blockly.Block.prototype.render=function(){this.svg_.render()};Blockly.BlockSvg=function(block){this.block_=block;this.svgGroup_=Blockly.createSvgElement('g',{},null);this.svgPathDark_=Blockly.createSvgElement('path',{transform:'translate(1, 1)'},this.svgGroup_);this.svgPath_=Blockly.createSvgElement('path',{},this.svgGroup_);this.svgPathLight_=Blockly.createSvgElement('path',{'fill':'none','stroke-width':2,'stroke-linecap':'round'},this.svgGroup_);this.svgPath_.tooltip=this.block_;Blockly.Tooltip&&Blockly.Tooltip.bindMouseEvents(this.svgPath_);if(block.editable){Blockly.addClass_(this.svgGroup_,'blocklyDraggable')}};Blockly.BlockSvg.prototype.init=function(){var block=this.block_;this.updateColour();for(var x=0;x<block.titleRow.length;x++){block.titleRow[x].init(block,this)}for(var x=0,input;input=block.inputList[x];x++){if(input.label){input.label.init(block,this)}if(input.type==Blockly.LOCAL_VARIABLE){input.init(block,this)}}if(block.mutator){block.mutator.createIcon()}};Blockly.BlockSvg.prototype.getRootNode=function(){return this.svgGroup_};Blockly.BlockSvg.SEP_SPACE_X=10;Blockly.BlockSvg.SEP_SPACE_Y=5;Blockly.BlockSvg.MIN_BLOCK_Y=25;Blockly.BlockSvg.TAB_HEIGHT=20;Blockly.BlockSvg.TAB_WIDTH=8;Blockly.BlockSvg.NOTCH_WIDTH=30;Blockly.BlockSvg.CORNER_RADIUS=8;Blockly.BlockSvg.DISTANCE_45_INSIDE=(1-Math.SQRT1_2)*(Blockly.BlockSvg.CORNER_RADIUS-1)+1;Blockly.BlockSvg.DISTANCE_45_OUTSIDE=(1-Math.SQRT1_2)*(Blockly.BlockSvg.CORNER_RADIUS+1)-1;Blockly.BlockSvg.NOTCH_PATH_LEFT='l 6,4 3,0 6,-4';Blockly.BlockSvg.NOTCH_PATH_LEFT_HIGHLIGHT='l 6.5,4 2,0 6.5,-4';Blockly.BlockSvg.NOTCH_PATH_RIGHT='l -6,4 -3,0 -6,-4';Blockly.BlockSvg.JAGGED_TEETH='l 8,0 0,4 8,4 -16,8 8,4';Blockly.BlockSvg.TAB_PATH_DOWN='v 5 c 0,10 -'+Blockly.BlockSvg.TAB_WIDTH+',-8 -'+Blockly.BlockSvg.TAB_WIDTH+',7.5 s '+Blockly.BlockSvg.TAB_WIDTH+',-2.5 '+Blockly.BlockSvg.TAB_WIDTH+',7.5';Blockly.BlockSvg.TAB_PATH_DOWN_HIGHLIGHT_RTL='v 6.5 m -'+(Blockly.BlockSvg.TAB_WIDTH*0.98)+',2.5 q -'+(Blockly.BlockSvg.TAB_WIDTH*.05)+',10 '+(Blockly.BlockSvg.TAB_WIDTH*.27)+',10 m '+(Blockly.BlockSvg.TAB_WIDTH*.71)+',-2.5 v 1.5';Blockly.BlockSvg.prototype.destroy=function(){this.svgGroup_.parentNode.removeChild(this.svgGroup_);this.svgGroup_=null;this.svgPath_=null;this.svgPathLight_=null;this.svgPathDark_=null;this.block_=null};Blockly.BlockSvg.prototype.updateColour=function(){var hexColour=Blockly.makeColour(this.block_.getColour());var r=window.parseInt(hexColour.charAt(1),16);var g=window.parseInt(hexColour.charAt(2),16);var b=window.parseInt(hexColour.charAt(3),16);var HEX='0123456789abcdef';var rLight=HEX.charAt(Math.min(r+3,15));var gLight=HEX.charAt(Math.min(g+2,15));var bLight=HEX.charAt(Math.min(b+2,15));var rDark=HEX.charAt(Math.max(r-4,0));var gDark=HEX.charAt(Math.max(g-4,0));var bDark=HEX.charAt(Math.max(b-4,0));this.svgPathLight_.setAttribute('stroke','#'+rLight+gLight+bLight);this.svgPathDark_.setAttribute('fill','#'+rDark+gDark+bDark);this.svgPath_.setAttribute('fill',hexColour)};Blockly.BlockSvg.prototype.addSelect=function(){Blockly.addClass_(this.svgPath_,'blocklySelected');this.svgPathLight_.setAttribute('display','none');this.svgGroup_.parentNode.appendChild(this.svgGroup_)};Blockly.BlockSvg.prototype.removeSelect=function(){Blockly.removeClass_(this.svgPath_,'blocklySelected');this.svgPathLight_.setAttribute('display','block')};Blockly.BlockSvg.prototype.addDragging=function(){Blockly.addClass_(this.svgPath_,'blocklyDragging');Blockly.addClass_(this.svgPathLight_,'blocklyDragging');this.svgPathDark_.style.display='none'};Blockly.BlockSvg.prototype.removeDragging=function(){Blockly.removeClass_(this.svgPath_,'blocklyDragging');Blockly.removeClass_(this.svgPathLight_,'blocklyDragging');this.svgPathDark_.style.display='block'};Blockly.BlockSvg.prototype.render=function(){this.block_.rendered=true;var titleY=18;if(!this.block_.collapsed&&this.block_.inputsInline&&this.block_.inputList.length&&this.block_.inputList[0].type==Blockly.INPUT_VALUE){titleY+=Blockly.BlockSvg.SEP_SPACE_Y}var titleX=Blockly.RTL?this.renderTitleRTL_(titleY):this.renderTitleLTR_(titleY);var inputRows=this.renderCompute_(this.block_.inputList);this.renderDraw_(titleX,inputRows);var parentBlock=this.block_.getParent();if(parentBlock){parentBlock.render()}else{Blockly.fireUiEvent(Blockly.svgDoc,window,'resize')}};Blockly.BlockSvg.prototype.renderTitleRTL_=function(titleY){var titleX=-Blockly.BlockSvg.SEP_SPACE_X;var iconWidth;if(this.block_.comment){iconWidth=this.block_.comment.renderIcon(titleX);if(iconWidth){titleX-=iconWidth+Blockly.BlockSvg.SEP_SPACE_X}}if(this.block_.mutator){iconWidth=this.block_.mutator.renderIcon(titleX);if(iconWidth){titleX-=iconWidth+Blockly.BlockSvg.SEP_SPACE_X}}for(var x=0,title;title=this.block_.titleRow[x];x++){var titleWidth=title.width();titleX-=titleWidth;title.getRootElement().setAttribute('transform','translate('+titleX+', '+titleY+')');if(titleWidth){titleX-=Blockly.BlockSvg.SEP_SPACE_X}}if(this.block_.previousConnection||this.block_.nextConnection){titleX=Math.min(titleX,-Blockly.BlockSvg.NOTCH_WIDTH-Blockly.BlockSvg.SEP_SPACE_X)}return-titleX};Blockly.BlockSvg.prototype.renderTitleLTR_=function(titleY){var titleX=Blockly.BlockSvg.SEP_SPACE_X;var iconWidth;if(this.block_.comment){iconWidth=this.block_.comment.renderIcon(titleX);if(iconWidth){titleX+=iconWidth+Blockly.BlockSvg.SEP_SPACE_X}}if(this.block_.mutator){iconWidth=this.block_.mutator.renderIcon(titleX);if(iconWidth){titleX+=iconWidth+Blockly.BlockSvg.SEP_SPACE_X}}for(var x=0,title;title=this.block_.titleRow[x];x++){title.getRootElement().setAttribute('transform','translate('+titleX+', '+titleY+')');var titleWidth=title.width();if(titleWidth){titleX+=titleWidth+Blockly.BlockSvg.SEP_SPACE_X}}if(this.block_.previousConnection||this.block_.nextConnection){titleX=Math.max(titleX,Blockly.BlockSvg.NOTCH_WIDTH+Blockly.BlockSvg.SEP_SPACE_X)}return titleX};Blockly.BlockSvg.prototype.renderCompute_=function(inputList){var inputRows=[];inputRows.labelValueWidth=0;inputRows.labelVariableWidth=0;inputRows.labelStatementWidth=0;inputRows.hasValue=false;inputRows.hasVariable=false;inputRows.hasStatement=false;var lastType=null;if(this.block_.collapsed){return inputRows}for(var i=0;i<inputList.length;i++){var input=inputList[i];var row;if(lastType!=Blockly.INPUT_VALUE||input.type!=Blockly.INPUT_VALUE||!this.block_.inputsInline){lastType=input.type;var row=[];row.type=input.type;row.height=0;inputRows.push(row)}else{row=inputRows[inputRows.length-1]}row.push(input);input.height=Blockly.BlockSvg.MIN_BLOCK_Y;if(row.type==Blockly.INPUT_VALUE){input.width=Blockly.BlockSvg.TAB_WIDTH+Blockly.BlockSvg.SEP_SPACE_X}else{input.width=NaN}if(input.targetConnection){var linkedBlock=input.targetBlock().getSvgRoot();try{var bBox=linkedBlock.getBBox()}catch(e){var bBox={height:0,width:0}}if(window.navigator.userAgent.indexOf('AppleWebKit/')!=-1){bBox.height-=5}input.height=Math.max(input.height,bBox.height-1);input.width=Math.max(input.width,bBox.width)}row.height=Math.max(row.height,input.height);if(input.label){if(input.label.getComputedTextLength){input.labelWidth=input.label.getComputedTextLength()}else{var labelBox=input.label.render();input.labelWidth=labelBox?labelBox.width:0}}else{input.labelWidth=0}if(row.type==Blockly.INPUT_VALUE){inputRows.hasValue=true;if(row.length==1){inputRows.labelValueWidth=Math.max(inputRows.labelValueWidth,input.labelWidth)}}else if(row.type==Blockly.NEXT_STATEMENT){inputRows.hasStatement=true;inputRows.labelStatementWidth=Math.max(inputRows.labelStatementWidth,input.labelWidth)}else if(row.type==Blockly.LOCAL_VARIABLE){inputRows.hasVariable=true;inputRows.labelVariableWidth=Math.max(inputRows.labelVariableWidth,input.labelWidth)}}if(this.block_.inputsInline&&inputRows.hasValue){for(var y=0;y<inputRows.length;y++){var row=inputRows[y];if(row.type==Blockly.INPUT_VALUE){row.height+=2*Blockly.BlockSvg.SEP_SPACE_Y}}}return inputRows};Blockly.BlockSvg.prototype.renderDraw_=function(titleX,inputRows){var connectionsXY=this.block_.getRelativeToSurfaceXY();var rightEdge=titleX;if(inputRows.hasStatement){rightEdge=Math.max(rightEdge,Blockly.BlockSvg.SEP_SPACE_X+inputRows.labelStatementWidth+Blockly.BlockSvg.SEP_SPACE_X+Blockly.BlockSvg.NOTCH_WIDTH)}if(inputRows.hasValue){rightEdge=Math.max(rightEdge,titleX+(inputRows.labelValueWidth?inputRows.labelValueWidth+Blockly.BlockSvg.SEP_SPACE_X:0)+Blockly.BlockSvg.TAB_WIDTH)}if(inputRows.hasVariable){rightEdge=Math.max(rightEdge,titleX+(inputRows.labelVariableWidth?inputRows.labelVariableWidth+Blockly.BlockSvg.SEP_SPACE_X:0)+Blockly.BlockSvg.TAB_WIDTH)}var steps=[];var inlineSteps=[];var highlightSteps=[];var highlightInlineSteps=[];this.renderDrawTop_(steps,highlightSteps,connectionsXY,rightEdge);var cursorY=this.renderDrawRight_(steps,highlightSteps,inlineSteps,highlightInlineSteps,connectionsXY,rightEdge,inputRows,titleX);this.renderDrawBottom_(steps,highlightSteps,connectionsXY,cursorY);this.renderDrawLeft_(steps,highlightSteps,connectionsXY,cursorY);var pathString=steps.join(' ')+'\n'+inlineSteps.join(' ');this.svgPath_.setAttribute('d',pathString);this.svgPathDark_.setAttribute('d',pathString);pathString=highlightSteps.join(' ')+'\n'+highlightInlineSteps.join(' ');this.svgPathLight_.setAttribute('d',pathString);if(Blockly.RTL){this.svgPath_.setAttribute('transform','scale(-1 1)');this.svgPathLight_.setAttribute('transform','scale(-1 1)');this.svgPathDark_.setAttribute('transform','translate(1,1) scale(-1 1)')}};Blockly.BlockSvg.prototype.renderDrawTop_=function(steps,highlightSteps,connectionsXY,rightEdge){if(this.block_.outputConnection){steps.push('m 0,0');highlightSteps.push('m 1,1')}else{steps.push('m 0,'+Blockly.BlockSvg.CORNER_RADIUS);if(Blockly.RTL){highlightSteps.push('m '+Blockly.BlockSvg.DISTANCE_45_INSIDE+','+Blockly.BlockSvg.DISTANCE_45_INSIDE)}else{highlightSteps.push('m 1,'+(Blockly.BlockSvg.CORNER_RADIUS-1))}if(Blockly.BlockSvg.CORNER_RADIUS){steps.push('A',Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS+' 0 0,1 '+Blockly.BlockSvg.CORNER_RADIUS+',0');highlightSteps.push('A',(Blockly.BlockSvg.CORNER_RADIUS-1)+','+(Blockly.BlockSvg.CORNER_RADIUS-1)+' 0 0,1 '+Blockly.BlockSvg.CORNER_RADIUS+',1')}}if(this.block_.previousConnection){steps.push('H',Blockly.BlockSvg.NOTCH_WIDTH-15);highlightSteps.push('H',Blockly.BlockSvg.NOTCH_WIDTH-15);steps.push(Blockly.BlockSvg.NOTCH_PATH_LEFT);highlightSteps.push(Blockly.BlockSvg.NOTCH_PATH_LEFT_HIGHLIGHT);var connectionX=connectionsXY.x+(Blockly.RTL?-Blockly.BlockSvg.NOTCH_WIDTH:Blockly.BlockSvg.NOTCH_WIDTH);var connectionY=connectionsXY.y;this.block_.previousConnection.moveTo(connectionX,connectionY)}steps.push('H',rightEdge);highlightSteps.push('H',rightEdge+(Blockly.RTL?-1:0))};Blockly.BlockSvg.prototype.renderDrawRight_=function(steps,highlightSteps,inlineSteps,highlightInlineSteps,connectionsXY,rightEdge,inputRows,titleX){var cursorX=0;var cursorY=0;var connectionX,connectionY;if(inputRows.length){for(var y=0;y<inputRows.length;y++){highlightSteps.push('M',(rightEdge-1)+','+(cursorY+1));var row=inputRows[y];if(row.type==Blockly.INPUT_VALUE){if(this.block_.inputsInline){cursorX=Math.max(titleX+inputRows.labelValueWidth,inputRows.labelStatementWidth);cursorX-=row[0].labelWidth;for(var x=0;x<row.length;x++){var input=row[x];if(input.label){var labelElement=input.label.getRootElement();var labelX=Blockly.RTL?-cursorX-input.labelWidth:cursorX;var labelY=cursorY+18+Blockly.BlockSvg.SEP_SPACE_Y;labelElement.setAttribute('transform','translate('+labelX+','+labelY+')');cursorX+=input.labelWidth+Blockly.BlockSvg.SEP_SPACE_X}cursorX+=input.width+Blockly.BlockSvg.SEP_SPACE_X;inlineSteps.push('M',(cursorX-Blockly.BlockSvg.SEP_SPACE_X)+','+(cursorY+Blockly.BlockSvg.SEP_SPACE_Y));inlineSteps.push('h',Blockly.BlockSvg.TAB_WIDTH-input.width);inlineSteps.push(Blockly.BlockSvg.TAB_PATH_DOWN);inlineSteps.push('v',input.height-Blockly.BlockSvg.TAB_HEIGHT);inlineSteps.push('h',input.width-Blockly.BlockSvg.TAB_WIDTH);inlineSteps.push('z');if(Blockly.RTL){highlightInlineSteps.push('M',(cursorX-Blockly.BlockSvg.SEP_SPACE_X+Blockly.BlockSvg.TAB_WIDTH-input.width-1)+','+(cursorY+Blockly.BlockSvg.SEP_SPACE_Y+1));highlightInlineSteps.push(Blockly.BlockSvg.TAB_PATH_DOWN_HIGHLIGHT_RTL);highlightInlineSteps.push('v',input.height-Blockly.BlockSvg.TAB_HEIGHT+2);highlightInlineSteps.push('h',input.width-Blockly.BlockSvg.TAB_WIDTH)}else{highlightInlineSteps.push('M',(cursorX-Blockly.BlockSvg.SEP_SPACE_X+1)+','+(cursorY+Blockly.BlockSvg.SEP_SPACE_Y+1));highlightInlineSteps.push('v',input.height);highlightInlineSteps.push('h',Blockly.BlockSvg.TAB_WIDTH-input.width);highlightInlineSteps.push('M',(cursorX-input.width-Blockly.BlockSvg.SEP_SPACE_X+3.8)+','+(cursorY+Blockly.BlockSvg.SEP_SPACE_Y+Blockly.BlockSvg.TAB_HEIGHT-0.4));highlightInlineSteps.push('l',(Blockly.BlockSvg.TAB_WIDTH*0.42)+',-1.8')}if(Blockly.RTL){connectionX=connectionsXY.x-cursorX-Blockly.BlockSvg.TAB_WIDTH+Blockly.BlockSvg.SEP_SPACE_X+input.width-1}else{connectionX=connectionsXY.x+cursorX+Blockly.BlockSvg.TAB_WIDTH-Blockly.BlockSvg.SEP_SPACE_X-input.width+1}connectionY=connectionsXY.y+cursorY+Blockly.BlockSvg.SEP_SPACE_Y;input.moveTo(connectionX,connectionY);if(input.targetConnection){input.tighten_()}}steps.push('H',cursorX);highlightSteps.push('H',cursorX+(Blockly.RTL?-1:0));steps.push('v',row.height);if(Blockly.RTL){highlightSteps.push('v',row.height-2)}}else{var input=row[0];if(input.label){var labelElement=input.label.getRootElement();var labelX=Blockly.RTL?-rightEdge+Blockly.BlockSvg.TAB_WIDTH+Blockly.BlockSvg.SEP_SPACE_X:rightEdge-Blockly.BlockSvg.TAB_WIDTH-Blockly.BlockSvg.SEP_SPACE_X-input.labelWidth;var labelY=cursorY+18;labelElement.setAttribute('transform','translate('+labelX+','+labelY+')')}steps.push(Blockly.BlockSvg.TAB_PATH_DOWN);steps.push('v',row.height-Blockly.BlockSvg.TAB_HEIGHT);if(Blockly.RTL){highlightSteps.push(Blockly.BlockSvg.TAB_PATH_DOWN_HIGHLIGHT_RTL);highlightSteps.push('v',row.height-Blockly.BlockSvg.TAB_HEIGHT)}else{highlightSteps.push('M',(rightEdge-4.2)+','+(cursorY+Blockly.BlockSvg.TAB_HEIGHT-0.4));highlightSteps.push('l',(Blockly.BlockSvg.TAB_WIDTH*0.42)+',-1.8')}connectionX=connectionsXY.x+(Blockly.RTL?-rightEdge-1:rightEdge+1);connectionY=connectionsXY.y+cursorY;input.moveTo(connectionX,connectionY);if(input.targetConnection){input.tighten_()}}}else if(row.type==Blockly.LOCAL_VARIABLE){var input=row[0];if(input.label){var labelElement=input.label.getRootElement();if(Blockly.RTL){labelElement.setAttribute('x',-rightEdge+Blockly.BlockSvg.TAB_WIDTH+Blockly.BlockSvg.SEP_SPACE_X)}else{labelElement.setAttribute('x',rightEdge-Blockly.BlockSvg.TAB_WIDTH-Blockly.BlockSvg.SEP_SPACE_X-input.labelWidth)}labelElement.setAttribute('y',cursorY+18)}var fieldGroup=input.getRootElement();var bBox=input.render()||{height:0,width:0};if(Blockly.RTL){fieldGroup.setAttribute('transform','translate('+(-rightEdge-bBox.width+Blockly.BlockSvg.SEP_SPACE_X/2)+', '+(cursorY+18)+')')}else{fieldGroup.setAttribute('transform','translate('+(rightEdge-Blockly.BlockSvg.SEP_SPACE_X/2)+', '+(cursorY+18)+')')}var width=bBox.width+Blockly.BlockSvg.SEP_SPACE_X/2;steps.push('H',rightEdge+width);steps.push('v',row.height);steps.push('h',-width);if(Blockly.RTL){highlightSteps.push('h',width);highlightSteps.push('v',row.height-2);highlightSteps.push('m',-width+',0')}else{highlightSteps.push('h',width+1)}}else if(row.type==Blockly.NEXT_STATEMENT){var input=row[0];if(y==0){steps.push('v',Blockly.BlockSvg.MIN_BLOCK_Y);if(Blockly.RTL){highlightSteps.push('v',Blockly.BlockSvg.MIN_BLOCK_Y-2)}cursorY+=Blockly.BlockSvg.MIN_BLOCK_Y}if(input.label){var labelElement=input.label.getRootElement();if(Blockly.RTL){labelElement.setAttribute('x',-Blockly.BlockSvg.SEP_SPACE_X-inputRows.labelStatementWidth)}else{labelElement.setAttribute('x',Blockly.BlockSvg.SEP_SPACE_X+inputRows.labelStatementWidth-input.labelWidth)}labelElement.setAttribute('y',cursorY+18)}cursorX=Blockly.BlockSvg.SEP_SPACE_X+inputRows.labelStatementWidth+Blockly.BlockSvg.SEP_SPACE_X+Blockly.BlockSvg.NOTCH_WIDTH;steps.push('H',cursorX);steps.push(Blockly.BlockSvg.NOTCH_PATH_RIGHT+' h -'+(Blockly.BlockSvg.NOTCH_WIDTH-15-Blockly.BlockSvg.CORNER_RADIUS));if(Blockly.BlockSvg.CORNER_RADIUS){steps.push('a',Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS+' 0 0,0 -'+Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS)}steps.push('v',row.height-2*Blockly.BlockSvg.CORNER_RADIUS);if(Blockly.BlockSvg.CORNER_RADIUS){steps.push('a',Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS+' 0 0,0 '+Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS)}steps.push('H',rightEdge);if(Blockly.RTL){highlightSteps.push('M',(cursorX-Blockly.BlockSvg.NOTCH_WIDTH+Blockly.BlockSvg.DISTANCE_45_OUTSIDE)+','+(cursorY+Blockly.BlockSvg.DISTANCE_45_OUTSIDE));highlightSteps.push('a',(Blockly.BlockSvg.CORNER_RADIUS+1)+','+(Blockly.BlockSvg.CORNER_RADIUS+1)+' 0 0,0 '+(-Blockly.BlockSvg.DISTANCE_45_OUTSIDE-1)+','+(Blockly.BlockSvg.CORNER_RADIUS-Blockly.BlockSvg.DISTANCE_45_OUTSIDE));highlightSteps.push('v',row.height-2*Blockly.BlockSvg.CORNER_RADIUS);highlightSteps.push('a',(Blockly.BlockSvg.CORNER_RADIUS+1)+','+(Blockly.BlockSvg.CORNER_RADIUS+1)+' 0 0,0 '+(Blockly.BlockSvg.CORNER_RADIUS+1)+','+(Blockly.BlockSvg.CORNER_RADIUS+1));highlightSteps.push('H',rightEdge-1)}else{highlightSteps.push('M',(cursorX-Blockly.BlockSvg.NOTCH_WIDTH+Blockly.BlockSvg.DISTANCE_45_OUTSIDE)+','+(cursorY+row.height-Blockly.BlockSvg.DISTANCE_45_OUTSIDE));highlightSteps.push('a',(Blockly.BlockSvg.CORNER_RADIUS+1)+','+(Blockly.BlockSvg.CORNER_RADIUS+1)+' 0 0,0 '+(Blockly.BlockSvg.CORNER_RADIUS-Blockly.BlockSvg.DISTANCE_45_OUTSIDE)+','+(Blockly.BlockSvg.DISTANCE_45_OUTSIDE+1));highlightSteps.push('H',rightEdge)}connectionX=connectionsXY.x+(Blockly.RTL?-cursorX:cursorX);connectionY=connectionsXY.y+cursorY+1;input.moveTo(connectionX,connectionY);if(input.targetConnection){input.tighten_()}if(y==inputRows.length-1||inputRows[y+1].type==Blockly.NEXT_STATEMENT){steps.push('v',Blockly.BlockSvg.SEP_SPACE_Y);if(Blockly.RTL){highlightSteps.push('v',Blockly.BlockSvg.SEP_SPACE_Y-1)}cursorY+=Blockly.BlockSvg.SEP_SPACE_Y}}cursorY+=row.height}}else{if(this.block_.collapsed){steps.push(Blockly.BlockSvg.JAGGED_TEETH);if(Blockly.RTL){highlightSteps.push('l 8,0 0,3.8 7,3.2 m -14.5,9 l 8,4')}else{highlightSteps.push('h 8')}}steps.push('V',Blockly.BlockSvg.MIN_BLOCK_Y);if(Blockly.RTL){highlightSteps.push('V',Blockly.BlockSvg.MIN_BLOCK_Y-1)}cursorY=Blockly.BlockSvg.MIN_BLOCK_Y}return cursorY};Blockly.BlockSvg.prototype.renderDrawBottom_=function(steps,highlightSteps,connectionsXY,cursorY){if(this.block_.nextConnection){steps.push('H',Blockly.BlockSvg.NOTCH_WIDTH+' '+Blockly.BlockSvg.NOTCH_PATH_RIGHT);var connectionX;if(Blockly.RTL){connectionX=connectionsXY.x-Blockly.BlockSvg.NOTCH_WIDTH}else{connectionX=connectionsXY.x+Blockly.BlockSvg.NOTCH_WIDTH}var connectionY=connectionsXY.y+cursorY+1;this.block_.nextConnection.moveTo(connectionX,connectionY);if(this.block_.nextConnection.targetConnection){this.block_.nextConnection.tighten_()}}if(this.block_.outputConnection){steps.push('H 0')}else{steps.push('H',Blockly.BlockSvg.CORNER_RADIUS);if(Blockly.BlockSvg.CORNER_RADIUS){steps.push('a',Blockly.BlockSvg.CORNER_RADIUS+','+Blockly.BlockSvg.CORNER_RADIUS+' 0 0,1 -'+Blockly.BlockSvg.CORNER_RADIUS+',-'+Blockly.BlockSvg.CORNER_RADIUS);if(!Blockly.RTL){highlightSteps.push('M',Blockly.BlockSvg.DISTANCE_45_INSIDE+','+(cursorY-Blockly.BlockSvg.DISTANCE_45_INSIDE));highlightSteps.push('A',(Blockly.BlockSvg.CORNER_RADIUS-1)+','+(Blockly.BlockSvg.CORNER_RADIUS-1)+' 0 0,1 '+'1,'+(cursorY-Blockly.BlockSvg.CORNER_RADIUS))}}}};Blockly.BlockSvg.prototype.renderDrawLeft_=function(steps,highlightSteps,connectionsXY,cursorY){if(this.block_.outputConnection){steps.push('V',Blockly.BlockSvg.TAB_HEIGHT);steps.push('c 0,-10 -'+Blockly.BlockSvg.TAB_WIDTH+',8 -'+Blockly.BlockSvg.TAB_WIDTH+',-7.5 s '+Blockly.BlockSvg.TAB_WIDTH+',2.5 '+Blockly.BlockSvg.TAB_WIDTH+',-7.5');if(Blockly.RTL){highlightSteps.push('M',(Blockly.BlockSvg.TAB_WIDTH*-0.3)+',8.9');highlightSteps.push('l',(Blockly.BlockSvg.TAB_WIDTH*-0.45)+',-2.1')}else{highlightSteps.push('M','1,'+cursorY);highlightSteps.push('V',Blockly.BlockSvg.TAB_HEIGHT-1);highlightSteps.push('m',(Blockly.BlockSvg.TAB_WIDTH*-0.92)+',-1 q '+(Blockly.BlockSvg.TAB_WIDTH*-0.19)+',-5.5 0,-11');highlightSteps.push('m',(Blockly.BlockSvg.TAB_WIDTH*0.92)+',1 V 1 H 2')}this.block_.outputConnection.moveTo(connectionsXY.x,connectionsXY.y)}else{if(!Blockly.RTL){highlightSteps.push('V',Blockly.BlockSvg.CORNER_RADIUS)}}steps.push('z')};Blockly.Comment=function(block,commentGroup){this.block_=block;var angle=Blockly.Comment.ARROW_ANGLE;if(Blockly.RTL){angle=-angle}this.arrow_radians_=angle/360*Math.PI*2;this.createIcon_();this.createBubble_(commentGroup);this.setPinned(false);this.updateColour()};Blockly.Comment.ICON_RADIUS=8;Blockly.Comment.BORDER_WIDTH=6;Blockly.Comment.ARROW_THICKNESS=10;Blockly.Comment.ARROW_ANGLE=20;Blockly.Comment.ARROW_BEND=4;Blockly.Comment.onMouseUpWrapper_=null;Blockly.Comment.onMouseMoveWrapper_=null;Blockly.Comment.unbindDragEvents_=function(e){if(Blockly.Comment.onMouseUpWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mouseup',Blockly.Comment.onMouseUpWrapper_);Blockly.Comment.onMouseUpWrapper_=null}if(Blockly.Comment.onMouseMoveWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mousemove',Blockly.Comment.onMouseMoveWrapper_);Blockly.Comment.onMouseMoveWrapper_=null}};Blockly.Comment.prototype.iconX_=null;Blockly.Comment.prototype.iconY_=null;Blockly.Comment.prototype.relativeLeft_=-100;Blockly.Comment.prototype.relativeTop_=-120;Blockly.Comment.prototype.width_=160;Blockly.Comment.prototype.height_=80;Blockly.Comment.prototype.isPinned_=false;Blockly.Comment.prototype.createIcon_=function(){this.iconGroup_=Blockly.createSvgElement('g',{'class':'blocklyIconGroup'},null);var iconShield=Blockly.createSvgElement('circle',{'class':'blocklyIconShield',r:Blockly.Comment.ICON_RADIUS,cx:Blockly.Comment.ICON_RADIUS,cy:Blockly.Comment.ICON_RADIUS},this.iconGroup_);this.iconMark_=Blockly.createSvgElement('text',{'class':'blocklyCommentMark',x:Blockly.Comment.ICON_RADIUS/2,y:2*Blockly.Comment.ICON_RADIUS-3},this.iconGroup_);this.iconMark_.appendChild(Blockly.svgDoc.createTextNode('?'));this.block_.getSvgRoot().appendChild(this.iconGroup_);Blockly.bindEvent_(this.iconGroup_,'click',this,this.iconClick_);Blockly.bindEvent_(this.iconGroup_,'mouseover',this,this.iconMouseOver_);Blockly.bindEvent_(this.iconGroup_,'mouseout',this,this.iconMouseOut_)};Blockly.Comment.prototype.createBubble_=function(commentGroup){this.bubbleGroup_=Blockly.createSvgElement('g',{},null);var bubbleEmboss=Blockly.createSvgElement('g',{filter:'url(#blocklyEmboss)'},this.bubbleGroup_);this.bubbleArrow_=Blockly.createSvgElement('path',{},bubbleEmboss);this.bubbleBack_=Blockly.createSvgElement('rect',{'class':'blocklyDraggable',x:0,y:0,rx:Blockly.Comment.BORDER_WIDTH,ry:Blockly.Comment.BORDER_WIDTH},bubbleEmboss);this.resizeGroup_=Blockly.createSvgElement('g',{'class':Blockly.RTL?'blocklyResizeSW':'blocklyResizeSE'},this.bubbleGroup_);var resizeSize=2*Blockly.Comment.BORDER_WIDTH;Blockly.createSvgElement('polygon',{points:'0,x x,x x,0'.replace(/x/g,resizeSize)},this.resizeGroup_);Blockly.createSvgElement('line',{'class':'blocklyResizeLine',x1:resizeSize/3,y1:resizeSize-1,x2:resizeSize-1,y2:resizeSize/3},this.resizeGroup_);Blockly.createSvgElement('line',{'class':'blocklyResizeLine',x1:resizeSize*2/3,y1:resizeSize-1,x2:resizeSize-1,y2:resizeSize*2/3},this.resizeGroup_);this.foreignObject_=Blockly.createSvgElement('foreignObject',{x:Blockly.Comment.BORDER_WIDTH,y:Blockly.Comment.BORDER_WIDTH},this.bubbleGroup_);var body=Blockly.svgDoc.createElementNS(Blockly.HTML_NS,'body');body.setAttribute('xmlns',Blockly.HTML_NS);body.className='blocklyMinimalBody';this.textarea_=Blockly.svgDoc.createElementNS(Blockly.HTML_NS,'textarea');this.textarea_.className='blocklyCommentTextarea';this.textarea_.setAttribute('dir',Blockly.RTL?'RTL':'LTR');body.appendChild(this.textarea_);this.foreignObject_.appendChild(body);this.setBubbleSize(this.width_,this.height_);commentGroup.appendChild(this.bubbleGroup_);Blockly.bindEvent_(this.bubbleBack_,'mousedown',this,this.bubbleMouseDown_);Blockly.bindEvent_(this.resizeGroup_,'mousedown',this,this.resizeMouseDown_);Blockly.bindEvent_(this.foreignObject_,'mousedown',this,Blockly.noEvent);Blockly.bindEvent_(this.textarea_,'mouseup',this,this.textareaFocus_)};Blockly.Comment.prototype.isPinned=function(){return this.isPinned_};Blockly.Comment.prototype.setPinned=function(pinned){this.isPinned_=pinned;this.iconMark_.style.fill=pinned?'#fff':'';this.setVisible_(pinned)};Blockly.Comment.prototype.isVisible_=function(){return this.bubbleGroup_.style.display!='none'};Blockly.Comment.prototype.setVisible_=function(visible){this.bubbleGroup_.style.display=visible?'':'none';if(visible){this.positionBubble_()}};Blockly.Comment.prototype.iconClick_=function(e){this.setPinned(!this.isPinned_)};Blockly.Comment.prototype.iconMouseOver_=function(e){if(!this.isPinned_&&Blockly.Block.dragMode_==0){this.setVisible_(true)}};Blockly.Comment.prototype.iconMouseOut_=function(e){if(!this.isPinned_&&Blockly.Block.dragMode_==0){this.setVisible_(false)}};Blockly.Comment.prototype.bubbleMouseDown_=function(e){this.promote_();Blockly.Comment.unbindDragEvents_();if(e.button==2){return}else if(Blockly.isTargetInput_(e)){return}Blockly.setCursorHand_(true);if(Blockly.RTL){this.dragDeltaX=this.relativeLeft_+e.clientX}else{this.dragDeltaX=this.relativeLeft_-e.clientX}this.dragDeltaY=this.relativeTop_-e.clientY;Blockly.Comment.onMouseUpWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mouseup',this,Blockly.Comment.unbindDragEvents_);Blockly.Comment.onMouseMoveWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mousemove',this,this.bubbleMouseMove_);Blockly.hideChaff();e.stopPropagation()};Blockly.Comment.prototype.bubbleMouseMove_=function(e){if(Blockly.RTL){this.relativeLeft_=this.dragDeltaX-e.clientX}else{this.relativeLeft_=this.dragDeltaX+e.clientX}this.relativeTop_=this.dragDeltaY+e.clientY;this.positionBubble_();this.renderArrow_()};Blockly.Comment.prototype.resizeMouseDown_=function(e){this.promote_();Blockly.Comment.unbindDragEvents_();if(e.button==2){return}Blockly.setCursorHand_(true);if(Blockly.RTL){this.resizeDeltaWidth=this.width_+e.clientX}else{this.resizeDeltaWidth=this.width_-e.clientX}this.resizeDeltaHeight=this.height_-e.clientY;Blockly.Comment.onMouseUpWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mouseup',this,Blockly.Comment.unbindDragEvents_);Blockly.Comment.onMouseMoveWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mousemove',this,this.resizeMouseMove_);Blockly.hideChaff();e.stopPropagation()};Blockly.Comment.prototype.resizeMouseMove_=function(e){var w=this.resizeDeltaWidth;var h=this.resizeDeltaHeight+e.clientY;if(Blockly.RTL){w-=e.clientX}else{w+=e.clientX}this.setBubbleSize(w,h);if(Blockly.RTL){this.positionBubble_()}};Blockly.Comment.prototype.textareaFocus_=function(e){this.promote_();this.textarea_.focus()};Blockly.Comment.prototype.promote_=function(){var commentGroup=this.bubbleGroup_.parentNode;commentGroup.appendChild(this.bubbleGroup_)};Blockly.Comment.prototype.getBubbleLocation=function(){return{x:this.relativeLeft_,y:this.relativeTop_}};Blockly.Comment.prototype.setBubbleLocation=function(x,y){this.relativeLeft_=x;this.relativeTop_=y;this.positionBubble_()};Blockly.Comment.prototype.positionBubble_=function(){if(!this.isVisible_()||this.iconX_===null||this.iconY_===null){return}var left;if(Blockly.RTL){left=this.iconX_-this.relativeLeft_-this.width_}else{left=this.iconX_+this.relativeLeft_}var top=this.relativeTop_+this.iconY_;this.bubbleGroup_.setAttribute('transform','translate('+left+', '+top+')')};Blockly.Comment.prototype.getBubbleSize=function(){return{width:this.width_,height:this.height_}};Blockly.Comment.prototype.setBubbleSize=function(width,height){var doubleBorderWidth=2*Blockly.Comment.BORDER_WIDTH;width=Math.max(width,doubleBorderWidth+45);height=Math.max(height,doubleBorderWidth+18);this.width_=width;this.height_=height;this.bubbleBack_.setAttribute('width',width);this.bubbleBack_.setAttribute('height',height);if(Blockly.RTL){var resizeSize=2*Blockly.Comment.BORDER_WIDTH;this.resizeGroup_.setAttribute('transform','translate('+resizeSize+', '+(height-doubleBorderWidth)+') scale(-1 1)')}else{this.resizeGroup_.setAttribute('transform','translate('+(width-doubleBorderWidth)+', '+(height-doubleBorderWidth)+')')}this.foreignObject_.setAttribute('width',width-doubleBorderWidth);this.foreignObject_.setAttribute('height',height-doubleBorderWidth);this.textarea_.style.width=(width-doubleBorderWidth-4)+'px';this.textarea_.style.height=(height-doubleBorderWidth-4)+'px';this.renderArrow_()};Blockly.Comment.prototype.renderArrow_=function(){if(!this.isVisible_()){return}var steps=[];var relBubbleX=this.width_/2;var relBubbleY=this.height_/2;var relIconX=-this.relativeLeft_;var relIconY=-this.relativeTop_;if(relBubbleX==relIconX&&relBubbleY==relIconY){steps.push('M '+relBubbleX+','+relBubbleY)}else{var rise=relIconY-relBubbleY;var run=relIconX-relBubbleX;if(Blockly.RTL){run*=-1}var hypotenuse=Math.sqrt(rise*rise+run*run);var angle=Math.acos(run/hypotenuse);if(rise<0){angle=2*Math.PI-angle}var rightAngle=angle+Math.PI/2;if(rightAngle>Math.PI*2){rightAngle-=Math.PI*2}var rightRise=Math.sin(rightAngle);var rightRun=Math.cos(rightAngle);var bubbleSize=this.getBubbleSize();var thickness=(bubbleSize.width+bubbleSize.height)/Blockly.Comment.ARROW_THICKNESS;thickness=Math.min(thickness,bubbleSize.width,bubbleSize.height)/2;var backoffRatio=1-Blockly.Comment.ICON_RADIUS/hypotenuse;relIconX=relBubbleX+backoffRatio*run;relIconY=relBubbleY+backoffRatio*rise;var baseX1=relBubbleX+thickness*rightRun;var baseY1=relBubbleY+thickness*rightRise;var baseX2=relBubbleX-thickness*rightRun;var baseY2=relBubbleY-thickness*rightRise;var swirlAngle=angle+this.arrow_radians_;if(swirlAngle>Math.PI*2){swirlAngle-=Math.PI*2}var swirlRise=Math.sin(swirlAngle)*hypotenuse/Blockly.Comment.ARROW_BEND;var swirlRun=Math.cos(swirlAngle)*hypotenuse/Blockly.Comment.ARROW_BEND;steps.push('M'+baseX1+','+baseY1);steps.push('C'+(baseX1+swirlRun)+','+(baseY1+swirlRise)+' '+relIconX+','+relIconY+' '+relIconX+','+relIconY);steps.push('C'+relIconX+','+relIconY+' '+(baseX2+swirlRun)+','+(baseY2+swirlRise)+' '+baseX2+','+baseY2)}steps.push('z');this.bubbleArrow_.setAttribute('d',steps.join(' '))};Blockly.Comment.prototype.getText=function(){return this.textarea_.value};Blockly.Comment.prototype.setText=function(text){this.textarea_.value=text};Blockly.Comment.prototype.updateColour=function(){var hexColour=Blockly.makeColour(this.block_.getColour());this.bubbleBack_.setAttribute('fill',hexColour);this.bubbleArrow_.setAttribute('fill',hexColour)};Blockly.Comment.prototype.destroy=function(){Blockly.Comment.unbindDragEvents_();this.iconGroup_.parentNode.removeChild(this.iconGroup_);this.iconGroup_=null;this.bubbleGroup_.parentNode.removeChild(this.bubbleGroup_);this.textarea_=null;this.bubbleGroup_=null;this.block_.comment=null;this.block_=null};Blockly.Comment.prototype.renderIcon=function(titleX){if(this.block_.collapsed){this.iconGroup_.setAttribute('display','none');return 0}this.iconGroup_.setAttribute('display','block');var TOP_MARGIN=5;var diameter=2*Blockly.Comment.ICON_RADIUS;if(Blockly.RTL){titleX-=diameter}this.iconGroup_.setAttribute('transform','translate('+titleX+', '+TOP_MARGIN+')');this.computeIconLocation();if(window.navigator.userAgent.indexOf('Chrome/')!=-1){this.positionBubble_()}return diameter};Blockly.Comment.prototype.setIconLocation=function(x,y){this.iconX_=x;this.iconY_=y;this.positionBubble_()};Blockly.Comment.prototype.computeIconLocation=function(){var blockXY=this.block_.getRelativeToSurfaceXY();var iconXY=Blockly.getRelativeXY_(this.iconGroup_);var newX=blockXY.x+iconXY.x+Blockly.Comment.ICON_RADIUS;var newY=blockXY.y+iconXY.y+Blockly.Comment.ICON_RADIUS;if(newX!==this.iconX_||newY!==this.iconY_){this.iconX_=newX;this.iconY_=newY;this.positionBubble_()}};Blockly.Comment.prototype.getIconLocation=function(){return{x:this.iconX_,y:this.iconY_}};Blockly.Connection=function(source,type){this.sourceBlock_=source;this.targetConnection=null;this.type=type;this.x_=0;this.y_=0;this.inDB_=false;this.dbList_=this.sourceBlock_.workspace.connectionDBList};Blockly.Connection.prototype.destroy=function(){if(this.targetConnection){throw'Disconnect connection before destroying it.';}if(this.inDB_){this.dbList_[this.type].removeConnection_(this)}this.inDB_=false;if(Blockly.highlightedConnection_==this){Blockly.highlightedConnection_=null}if(Blockly.localConnection_==this){Blockly.localConnection_=null}};Blockly.Connection.prototype.connect=function(otherConnection){if(this.sourceBlock_==otherConnection.sourceBlock_){throw'Attempted to connect a block to itself.';}if(this.sourceBlock_.workspace!==otherConnection.sourceBlock_.workspace){throw'Blocks are on different workspaces.';}if(Blockly.OPPOSITE_TYPE[this.type]!=otherConnection.type){throw'Attempt to connect incompatible types.';}if(this.type==Blockly.INPUT_VALUE||this.type==Blockly.OUTPUT_VALUE){if(this.targetConnection){throw'Source connection already connected (value).';}else if(otherConnection.targetConnection){var orphanBlock=otherConnection.targetBlock();orphanBlock.setParent(null);function singleInput(block){var input=false;for(var x=0;x<block.inputList.length;x++){if(block.inputList[x].type==Blockly.INPUT_VALUE){if(input){return null}input=block.inputList[x]}}return input};var newBlock=this.sourceBlock_;var connection;while(connection=singleInput(newBlock)){if(connection.targetBlock()){newBlock=connection.targetBlock()}else{connection.connect(orphanBlock.outputConnection);orphanBlock=null;break}}if(orphanBlock){window.setTimeout(function(){orphanBlock.outputConnection.bumpAwayFrom_(otherConnection)},Blockly.BUMP_DELAY)}}}else{if(this.targetConnection){throw'Source connection already connected (block).';}else if(otherConnection.targetConnection){if(this.type!=Blockly.PREVIOUS_STATEMENT){throw'Can only do a mid-stack connection with the top of a block.';}var orphanBlock=otherConnection.targetBlock();orphanBlock.setParent(null);var newBlock=this.sourceBlock_;while(newBlock.nextConnection){if(newBlock.nextConnection.targetConnection){newBlock=newBlock.nextConnection.targetBlock()}else{newBlock.nextConnection.connect(orphanBlock.previousConnection);orphanBlock=null;break}}if(orphanBlock){window.setTimeout(function(){orphanBlock.previousConnection.bumpAwayFrom_(otherConnection)},Blockly.BUMP_DELAY)}}}var parentBlock,childBlock;if(this.type==Blockly.INPUT_VALUE||this.type==Blockly.NEXT_STATEMENT){parentBlock=this.sourceBlock_;childBlock=otherConnection.sourceBlock_}else{parentBlock=otherConnection.sourceBlock_;childBlock=this.sourceBlock_}this.targetConnection=otherConnection;otherConnection.targetConnection=this;childBlock.setParent(parentBlock);if(parentBlock.rendered){parentBlock.render()}};Blockly.Connection.prototype.disconnect=function(){var otherConnection=this.targetConnection;if(!otherConnection){throw'Source connection not connected.';}else if(otherConnection.targetConnection!=this){throw'Target connection not connected to source connection.';}otherConnection.targetConnection=null;this.targetConnection=null;var parentBlock;if(this.type==Blockly.INPUT_VALUE||this.type==Blockly.NEXT_STATEMENT){parentBlock=this.sourceBlock_}else{parentBlock=otherConnection.sourceBlock_}if(parentBlock.rendered){parentBlock.render()}};Blockly.Connection.prototype.targetBlock=function(){if(this.targetConnection){return this.targetConnection.sourceBlock_}return null};Blockly.Connection.prototype.bumpAwayFrom_=function(staticConnection){if(Blockly.Block.dragMode_!=0){return}var rootBlock=this.sourceBlock_.getRootBlock();var reverse=false;if(!rootBlock.editable){rootBlock=staticConnection.sourceBlock_.getRootBlock();if(!rootBlock.editable){return}staticConnection=this;reverse=true}rootBlock.getSvgRoot().parentNode.appendChild(rootBlock.getSvgRoot());var dx=(staticConnection.x_+Blockly.SNAP_RADIUS)-this.x_;var dy=(staticConnection.y_+Blockly.SNAP_RADIUS*2)-this.y_;if(reverse){dy=-dy}if(Blockly.RTL){dx=-dx}rootBlock.moveBy(dx,dy)};Blockly.Connection.prototype.moveTo=function(x,y){if(this.inDB_){this.dbList_[this.type].removeConnection_(this)}this.x_=x;this.y_=y;this.dbList_[this.type].addConnection_(this)};Blockly.Connection.prototype.moveBy=function(dx,dy){this.moveTo(this.x_+dx,this.y_+dy)};Blockly.Connection.prototype.highlight=function(){var steps;if(this.type==Blockly.INPUT_VALUE||this.type==Blockly.OUTPUT_VALUE){var tabWidth=Blockly.RTL?-Blockly.BlockSvg.TAB_WIDTH:Blockly.BlockSvg.TAB_WIDTH;steps='m 0,0 v 5 c 0,10 '+ -tabWidth+',-8 '+ -tabWidth+',7.5 s '+tabWidth+',-2.5 '+tabWidth+',7.5 v 5'}else{if(Blockly.RTL){steps='m 20,0 h -5 l -6,4 -3,0 -6,-4 h -5'}else{steps='m -20,0 h 5 l 6,4 3,0 6,-4 h 5'}}var xy=this.sourceBlock_.getRelativeToSurfaceXY();var x=this.x_-xy.x;var y=this.y_-xy.y;Blockly.Connection.highlightedPath_=Blockly.createSvgElement('path',{'class':'blocklyHighlightedConnectionPath',d:steps,transform:'translate('+x+', '+y+')'},this.sourceBlock_.getSvgRoot())};Blockly.Connection.prototype.unhighlight=function(){var path=Blockly.Connection.highlightedPath_;path.parentNode.removeChild(path);delete Blockly.Connection.highlightedPath_};Blockly.Connection.prototype.tighten_=function(){var dx=Math.round(this.targetConnection.x_-this.x_);var dy=Math.round(this.targetConnection.y_-this.y_);if(dx!=0||dy!=0){var block=this.targetBlock();var xy=Blockly.getRelativeXY_(block.getSvgRoot());block.getSvgRoot().setAttribute('transform','translate('+(xy.x-dx)+', '+(xy.y-dy)+')');block.moveConnections_(-dx,-dy)}};Blockly.Connection.prototype.closest=function(maxLimit,dx,dy){if(this.targetConnection){return{connection:null,radius:maxLimit}}var oppositeType=Blockly.OPPOSITE_TYPE[this.type];var db=this.dbList_[oppositeType];var currentX=this.x_+dx;var currentY=this.y_+dy;var pointerMin=0;var pointerMax=db.length-2;var pointerMid=pointerMax;while(pointerMin<pointerMid){if(db[pointerMid].y_<currentY){pointerMin=pointerMid}else{pointerMax=pointerMid}pointerMid=Math.floor((pointerMin+pointerMax)/2)}pointerMin=pointerMid;pointerMax=pointerMid;var closestConnection=null;var sourceBlock=this.sourceBlock_;if(db.length){while(pointerMin>=0&&checkConnection_(pointerMin)){pointerMin--}do{pointerMax++}while(pointerMax<db.length&&checkConnection_(pointerMax))}function checkConnection_(yIndex){var connection=db[yIndex];if(connection.type==Blockly.OUTPUT_VALUE||connection.type==Blockly.PREVIOUS_STATEMENT){if(connection.targetConnection){return true}}var targetSourceBlock=connection.sourceBlock_;do{if(sourceBlock==targetSourceBlock){return true}targetSourceBlock=targetSourceBlock.getParent()}while(targetSourceBlock);var dx=currentX-db[yIndex].x_;var dy=currentY-db[yIndex].y_;var r=Math.sqrt(dx*dx+dy*dy);if(r<=maxLimit){closestConnection=db[yIndex];maxLimit=r}return dy<maxLimit}return{connection:closestConnection,radius:maxLimit}};Blockly.Connection.prototype.neighbours_=function(maxLimit){var oppositeType=Blockly.OPPOSITE_TYPE[this.type];var db=this.dbList_[oppositeType];var currentX=this.x_;var currentY=this.y_;var pointerMin=0;var pointerMax=db.length-2;var pointerMid=pointerMax;while(pointerMin<pointerMid){if(db[pointerMid].y_<currentY){pointerMin=pointerMid}else{pointerMax=pointerMid}pointerMid=Math.floor((pointerMin+pointerMax)/2)}pointerMin=pointerMid;pointerMax=pointerMid;var neighbours=[];var sourceBlock=this.sourceBlock_;if(db.length){while(pointerMin>=0&&checkConnection_(pointerMin)){pointerMin--}do{pointerMax++}while(pointerMax<db.length&&checkConnection_(pointerMax))}function checkConnection_(yIndex){var dx=currentX-db[yIndex].x_;var dy=currentY-db[yIndex].y_;var r=Math.sqrt(dx*dx+dy*dy);if(r<=maxLimit){neighbours.push(db[yIndex])}return dy<maxLimit}return neighbours};Blockly.Connection.prototype.hideAll=function(){if(this.inDB_){this.dbList_[this.type].removeConnection_(this)}if(this.targetConnection){var blocks=this.targetBlock().getDescendants();for(var b=0;b<blocks.length;b++){var block=blocks[b];var connections=block.getConnections_(true);for(var c=0;c<connections.length;c++){var connection=connections[c];if(connection.inDB_){this.dbList_[connection.type].removeConnection_(connection)}}if(block.comment){block.comment.setVisible_(false)}}}};Blockly.Connection.prototype.unhideAll=function(){if(!this.inDB_){this.dbList_[this.type].addConnection_(this)}var renderList=[];if(this.type!=Blockly.INPUT_VALUE&&this.type!=Blockly.NEXT_STATEMENT){return renderList}var block=this.targetBlock();if(block){var connections;if(block.collapsed){connections=[];block.outputConnection&&connections.push(block.outputConnection);block.nextConnection&&connections.push(block.nextConnection);block.previousConnection&&connections.push(block.previousConnection)}else{connections=block.getConnections_(true)}for(var c=0;c<connections.length;c++){renderList=renderList.concat(connections[c].unhideAll())}if(renderList.length==0){renderList[0]=block}if(block.comment&&block.comment.isPinned()){block.comment.setVisible_(true)}}return renderList};Blockly.ConnectionDB=function(){};Blockly.ConnectionDB.prototype=new Array();Blockly.ConnectionDB.prototype.addConnection_=function(connection){if(connection.inDB_){throw'Connection already in database.';}var pointerMin=0;var pointerMax=this.length;while(pointerMin<pointerMax){var pointerMid=Math.floor((pointerMin+pointerMax)/2);if(this[pointerMid].y_<connection.y_){pointerMin=pointerMid+1}else if(this[pointerMid].y_>connection.y_){pointerMax=pointerMid}else{pointerMin=pointerMid;break}}this.splice(pointerMin,0,connection);connection.inDB_=true};Blockly.ConnectionDB.prototype.removeConnection_=function(connection){if(!connection.inDB_){throw'Connection not in database.';}connection.inDB_=false;var pointerMin=0;var pointerMax=this.length-2;var pointerMid=pointerMax;while(pointerMin<pointerMid){if(this[pointerMid].y_<connection.y_){pointerMin=pointerMid}else{pointerMax=pointerMid}pointerMid=Math.floor((pointerMin+pointerMax)/2)}pointerMin=pointerMid;pointerMax=pointerMid;while(pointerMin>=0&&this[pointerMin].y_==connection.y_){if(this[pointerMin]==connection){this.splice(pointerMin,1);return}pointerMin--}do{if(this[pointerMax]==connection){this.splice(pointerMax,1);return}pointerMax++}while(pointerMax<this.length&&this[pointerMax].y_==connection.y_);throw'Unable to find connection in connectionDB.';};Blockly.ConnectionDB.init=function(workspace){var dbList=[];dbList[Blockly.INPUT_VALUE]=new Blockly.ConnectionDB();dbList[Blockly.OUTPUT_VALUE]=new Blockly.ConnectionDB();dbList[Blockly.NEXT_STATEMENT]=new Blockly.ConnectionDB();dbList[Blockly.PREVIOUS_STATEMENT]=new Blockly.ConnectionDB();workspace.connectionDBList=dbList};Blockly.ContextMenu={};Blockly.ContextMenu.X_PADDING=20;Blockly.ContextMenu.Y_HEIGHT=20;Blockly.ContextMenu.visible=false;Blockly.ContextMenu.createDom=function(){var svgGroup=Blockly.createSvgElement('g',{'class':'blocklyHidden'},null);Blockly.ContextMenu.svgGroup=svgGroup;Blockly.ContextMenu.svgShadow=Blockly.createSvgElement('rect',{'class':'blocklyContextMenuShadow',x:2,y:-2,rx:4,ry:4},svgGroup);Blockly.ContextMenu.svgBackground=Blockly.createSvgElement('rect',{'class':'blocklyContextMenuBackground',y:-4,rx:4,ry:4},svgGroup);Blockly.ContextMenu.svgOptions=Blockly.createSvgElement('g',{'class':'blocklyContextMenuOptions'},svgGroup);return svgGroup};Blockly.ContextMenu.show=function(anchorX,anchorY,options){if(options.length==0){Blockly.ContextMenu.hide()}Blockly.removeChildren_(Blockly.ContextMenu.svgOptions);Blockly.ContextMenu.svgGroup.style.display='block';var maxWidth=0;var resizeList=[Blockly.ContextMenu.svgBackground,Blockly.ContextMenu.svgShadow];for(var x=0,option;option=options[x];x++){var gElement=Blockly.ContextMenu.optionToDom(option.text);var rectElement=gElement.firstChild;var textElement=gElement.lastChild;Blockly.ContextMenu.svgOptions.appendChild(gElement);gElement.setAttribute('transform','translate(0, '+(x*Blockly.ContextMenu.Y_HEIGHT)+')');resizeList.push(rectElement);Blockly.bindEvent_(gElement,'mousedown',null,Blockly.noEvent);if(option.enabled){Blockly.bindEvent_(gElement,'mouseup',null,option.callback);Blockly.bindEvent_(gElement,'mouseup',null,Blockly.ContextMenu.hide)}else{gElement.setAttribute('class','blocklyMenuDivDisabled')}maxWidth=Math.max(maxWidth,textElement.getComputedTextLength())}maxWidth+=Blockly.ContextMenu.X_PADDING*2;for(var x=0;x<resizeList.length;x++){resizeList[x].setAttribute('width',maxWidth)}if(Blockly.RTL){for(var x=0,gElement;gElement=Blockly.ContextMenu.svgOptions.childNodes[x];x++){var textElement=gElement.lastChild;textElement.setAttribute('x',maxWidth-textElement.getComputedTextLength()-Blockly.ContextMenu.X_PADDING)}}Blockly.ContextMenu.svgBackground.setAttribute('height',options.length*Blockly.ContextMenu.Y_HEIGHT+8);Blockly.ContextMenu.svgShadow.setAttribute('height',options.length*Blockly.ContextMenu.Y_HEIGHT+10);var bBox=Blockly.ContextMenu.svgGroup.getBBox();var svgSize=Blockly.svgSize();anchorX-=svgSize.left;anchorY-=svgSize.top;if(anchorY+bBox.height>svgSize.height){anchorY-=bBox.height-10}if(Blockly.RTL){if(anchorX-bBox.width<=0){anchorX++}else{anchorX-=bBox.width}}else{if(anchorX+bBox.width>svgSize.width){anchorX-=bBox.width}else{anchorX++}}Blockly.ContextMenu.svgGroup.setAttribute('transform','translate('+anchorX+', '+anchorY+')');Blockly.ContextMenu.visible=true};Blockly.ContextMenu.optionToDom=function(text){var gElement=Blockly.createSvgElement('g',{'class':'blocklyMenuDiv'},null);var rectElement=Blockly.createSvgElement('rect',{height:Blockly.ContextMenu.Y_HEIGHT},gElement);var textElement=Blockly.createSvgElement('text',{'class':'blocklyMenuText',x:Blockly.ContextMenu.X_PADDING,y:15},gElement);var textNode=Blockly.svgDoc.createTextNode(text);textElement.appendChild(textNode);return gElement};Blockly.ContextMenu.hide=function(){if(Blockly.ContextMenu.visible){Blockly.ContextMenu.svgGroup.style.display='none';Blockly.ContextMenu.visible=false}};Blockly.Field=function(text){if(text===null){return}this.sourceBlock_=null;this.group_=Blockly.createSvgElement('g',{},null);this.borderRect_=Blockly.createSvgElement('rect',{rx:4,ry:4},this.group_);this.textElement_=Blockly.createSvgElement('text',{'class':'blocklyText'},this.group_);if(this.CURSOR){this.group_.style.cursor=this.CURSOR}this.setText(text)};Blockly.Field.NBSP='\u00A0';Blockly.Field.prototype.EDITABLE=true;Blockly.Field.prototype.init=function(block){if(this.sourceBlock_){throw'Field has already been initialized once.';}this.sourceBlock_=block;this.group_.setAttribute('class',block.editable?'blocklyEditableText':'blocklyNonEditableText');block.getSvgRoot().appendChild(this.group_);if(block.editable){this.mouseUpWrapper_=Blockly.bindEvent_(this.group_,'mouseup',this,this.onMouseUp_)}};Blockly.Field.prototype.destroy=function(){if(this.mouseUpWrapper_){Blockly.unbindEvent_(this.group_,'mouseup',this.mouseUpWrapper_);this.mouseUpWrapper_=null}this.sourceBlock_=null;this.group_.parentNode.removeChild(this.group_);this.group_=null;this.textElement_=null;this.borderRect_=null};Blockly.Field.prototype.setVisible=function(visible){this.getRootElement().style.display=visible?'block':'none'};Blockly.Field.prototype.getRootElement=function(){return this.group_};Blockly.Field.prototype.render=function(){try{var bBox=this.textElement_.getBBox()}catch(e){return null}if(bBox.height==0){bBox.height=18}var width=bBox.width+Blockly.BlockSvg.SEP_SPACE_X;var height=bBox.height;var left=bBox.x-Blockly.BlockSvg.SEP_SPACE_X/2;var top=bBox.y;this.borderRect_.setAttribute('width',width);this.borderRect_.setAttribute('height',height);this.borderRect_.setAttribute('x',left);this.borderRect_.setAttribute('y',top);return bBox};Blockly.Field.prototype.width=function(){var bBox=this.render();if(!bBox){return 0}if(bBox.width==-Infinity){return 0}return bBox.width};Blockly.Field.prototype.getText=function(){return this.text_};Blockly.Field.prototype.setText=function(text){this.text_=text;Blockly.removeChildren_(this.textElement_);text=text.replace(/\s/g,Blockly.Field.NBSP);if(!text){text=Blockly.Field.NBSP}var textNode=Blockly.svgDoc.createTextNode(text);this.textElement_.appendChild(textNode);if(this.sourceBlock_&&this.sourceBlock_.rendered){this.sourceBlock_.render();this.sourceBlock_.bumpNeighbours_()}};Blockly.Field.prototype.getValue=function(){return this.getText()};Blockly.Field.prototype.setValue=function(text){this.setText(text)};Blockly.Field.prototype.onMouseUp_=function(e){if(e.button==2){return}else if(Blockly.Block.dragMode_==2){return}this.showEditor_()};Blockly.Field.prototype.setTooltip=function(newTip){};Blockly.FieldDropdown=function(menuGenerator,opt_changeHandler){var options=menuGenerator.call(this);firstOption=options[0][0];Blockly.Field.call(this,firstOption);this.menuGenerator_=menuGenerator;this.changeHandler_=opt_changeHandler};Blockly.FieldDropdown.prototype=new Blockly.Field(null);Blockly.FieldDropdown.createDom=function(){var svgGroup=Blockly.createSvgElement('g',{'class':'blocklyHidden'},null);Blockly.FieldDropdown.svgGroup_=svgGroup;Blockly.FieldDropdown.svgShadow_=Blockly.createSvgElement('rect',{'class':'blocklyDropdownMenuShadow',x:0,y:1,rx:2,ry:2},svgGroup);Blockly.FieldDropdown.svgBackground_=Blockly.createSvgElement('rect',{x:-2,y:-1,rx:2,ry:2,filter:'url(#blocklyEmboss)'},svgGroup);Blockly.FieldDropdown.svgOptions_=Blockly.createSvgElement('g',{'class':'blocklyDropdownMenuOptions'},svgGroup);return svgGroup};Blockly.FieldDropdown.CORNER_RADIUS=2;Blockly.FieldDropdown.prototype.CURSOR='default';Blockly.FieldDropdown.prototype.showEditor_=function(){var svgGroup=Blockly.FieldDropdown.svgGroup_;var svgOptions=Blockly.FieldDropdown.svgOptions_;var svgBackground=Blockly.FieldDropdown.svgBackground_;var svgShadow=Blockly.FieldDropdown.svgShadow_;Blockly.removeChildren_(svgOptions);svgGroup.style.display='block';function callbackFactory(text){return function(e){if(this.changeHandler_){this.changeHandler_(text)}else{this.setText(text)}e.stopPropagation()}}var maxWidth=0;var resizeList=[];var checkElement=null;var options=this.menuGenerator_();for(var x=0;x<options.length;x++){var text=options[x][0];var value=options[x][1];var gElement=Blockly.ContextMenu.optionToDom(text);var rectElement=gElement.firstChild;var textElement=gElement.lastChild;svgOptions.appendChild(gElement);if(!checkElement&&text==this.text_){checkElement=Blockly.createSvgElement('text',{'class':'blocklyMenuText',y:15},null);gElement.insertBefore(checkElement,textElement);checkElement.appendChild(Blockly.svgDoc.createTextNode('\u2713'))}gElement.setAttribute('transform','translate(0, '+(x*Blockly.ContextMenu.Y_HEIGHT)+')');resizeList.push(rectElement);Blockly.bindEvent_(gElement,'mousedown',null,Blockly.noEvent);Blockly.bindEvent_(gElement,'mouseup',this,callbackFactory(text));Blockly.bindEvent_(gElement,'mouseup',null,Blockly.FieldDropdown.hideMenu);maxWidth=Math.max(maxWidth,textElement.getComputedTextLength())}maxWidth+=Blockly.ContextMenu.X_PADDING*2;for(var x=0;x<resizeList.length;x++){resizeList[x].setAttribute('width',maxWidth)}if(Blockly.RTL){for(var x=0,gElement;gElement=svgOptions.childNodes[x];x++){var textElement=gElement.lastChild;textElement.setAttribute('x',maxWidth-textElement.getComputedTextLength()-Blockly.ContextMenu.X_PADDING)}}if(checkElement){if(Blockly.RTL){checkElement.setAttribute('x',maxWidth-5-checkElement.getComputedTextLength())}else{checkElement.setAttribute('x',5)}}var width=maxWidth+Blockly.FieldDropdown.CORNER_RADIUS*2;var height=options.length*Blockly.ContextMenu.Y_HEIGHT+Blockly.FieldDropdown.CORNER_RADIUS+1;svgShadow.setAttribute('width',width);svgShadow.setAttribute('height',height);svgBackground.setAttribute('width',width);svgBackground.setAttribute('height',height);var hexColour=Blockly.makeColour(this.sourceBlock_.getColour());svgBackground.setAttribute('fill',hexColour);var xy=Blockly.getAbsoluteXY_(this.borderRect_);var borderBBox=this.borderRect_.getBBox();var x;if(Blockly.RTL){x=xy.x-maxWidth+Blockly.ContextMenu.X_PADDING+borderBBox.width-Blockly.BlockSvg.SEP_SPACE_X/2}else{x=xy.x-Blockly.ContextMenu.X_PADDING+Blockly.BlockSvg.SEP_SPACE_X/2}svgGroup.setAttribute('transform','translate('+x+', '+(xy.y+borderBBox.height)+')')};Blockly.FieldDropdown.hideMenu=function(){Blockly.FieldDropdown.svgGroup_.style.display='none'};Blockly.FieldDropdown.prototype.getValue=function(){var selectedText=this.text_;var options=this.menuGenerator_();for(var x=0;x<options.length;x++){if(options[x][0]==selectedText){return options[x][1]}}throw'"'+selectedText+'" not valid in dropdown.';};Blockly.FieldDropdown.prototype.setValue=function(newValue){var options=this.menuGenerator_();for(var x=0;x<options.length;x++){if(options[x][1]==newValue){this.setText(options[x][0]);return}}throw'"'+newValue+'" not found in dropdown.';};Blockly.FieldLabel=function(text){this.sourceBlock_=null;this.textElement_=Blockly.createSvgElement('text',{'class':'blocklyText'},null);this.setText(text)};Blockly.FieldLabel.prototype=new Blockly.Field(null);Blockly.FieldLabel.prototype.EDITABLE=false;Blockly.FieldLabel.prototype.init=function(block){if(this.sourceBlock_){throw'Text has already been initialized once.';}this.sourceBlock_=block;block.getSvgRoot().appendChild(this.textElement_);this.textElement_.tooltip=this.sourceBlock_;Blockly.Tooltip&&Blockly.Tooltip.bindMouseEvents(this.textElement_)};Blockly.FieldLabel.prototype.destroy=function(){this.textElement_.parentNode.removeChild(this.textElement_);this.textElement_=null};Blockly.FieldLabel.prototype.getRootElement=function(){return this.textElement_};Blockly.FieldLabel.prototype.render=function(){try{var bBox=this.textElement_.getBBox()}catch(e){return null}if(bBox.height==0){bBox.height=18}return bBox};Blockly.FieldLabel.prototype.setTooltip=function(newTip){this.textElement_.tooltip=newTip};Blockly.FieldTextInput=function(text,opt_validationFunc){Blockly.Field.call(this,text);this.validationFunc_=opt_validationFunc};Blockly.FieldTextInput.prototype=new Blockly.Field(null);Blockly.FieldTextInput.prototype.setText=function(text){if(this.validationFunc_){var validated=this.validationFunc_(text);if(validated!==null){text=validated}}Blockly.Field.prototype.setText.call(this,text)};Blockly.FieldTextInput.createDom=function(){var foreignObject=Blockly.createSvgElement('foreignObject',{'class':'blocklyHidden',height:22},null);Blockly.FieldTextInput.svgForeignObject_=foreignObject;var body=Blockly.svgDoc.createElement('body');body.className='blocklyMinimalBody';var input=Blockly.svgDoc.createElement('input');input.className='blocklyHtmlInput';input.style.border='none';input.style.outline='none';Blockly.FieldTextInput.htmlInput_=input;body.appendChild(input);foreignObject.appendChild(body);return foreignObject};Blockly.FieldTextInput.prototype.CURSOR='text';Blockly.FieldTextInput.prototype.showEditor_=function(){if(window.opera){var newValue=window.prompt(Blockly.MSG_CHANGE_VALUE_TITLE,this.text_);if(this.validationFunc_){newValue=this.validationFunc_(newValue)}if(newValue!==null){this.setText(newValue)}return}var htmlInput=Blockly.FieldTextInput.htmlInput_;htmlInput.value=htmlInput.defaultValue=this.text_;htmlInput.oldValue_=null;var htmlInputFrame=Blockly.FieldTextInput.svgForeignObject_;htmlInputFrame.style.display='block';var xy=Blockly.getAbsoluteXY_(this.borderRect_);if(!Blockly.RTL){htmlInputFrame.setAttribute('x',xy.x+1)}var isGecko=window.navigator.userAgent.indexOf('Gecko/')!=-1;if(isGecko){htmlInputFrame.setAttribute('y',xy.y-1)}else{htmlInputFrame.setAttribute('y',xy.y-3)}htmlInput.focus();htmlInput.select();htmlInput.onBlurWrapper_=Blockly.bindEvent_(htmlInput,'blur',this,this.onHtmlInputBlur_);htmlInput.onKeyUpWrapper_=Blockly.bindEvent_(htmlInput,'keyup',this,this.onHtmlInputKeyUp_);htmlInput.onKeyPressWrapper_=Blockly.bindEvent_(htmlInput,'keypress',this,this.resizeEditor_);this.resizeEditor_();this.validate_()};Blockly.FieldTextInput.prototype.onHtmlInputBlur_=function(e){this.closeEditor_(true)};Blockly.FieldTextInput.prototype.onHtmlInputKeyUp_=function(e){if(e.keyCode==13){this.closeEditor_(true)}else if(e.keyCode==27){this.closeEditor_(false)}else{this.resizeEditor_();this.validate_()}};Blockly.FieldTextInput.prototype.validate_=function(){var valid=true;var htmlInput=Blockly.FieldTextInput.htmlInput_;if(this.validationFunc_){valid=this.validationFunc_(htmlInput.value)}if(valid){Blockly.removeClass_(htmlInput,'blocklyInvalidInput')}else{Blockly.addClass_(htmlInput,'blocklyInvalidInput')}};Blockly.FieldTextInput.prototype.resizeEditor_=function(){var htmlInput=Blockly.FieldTextInput.htmlInput_;var text=htmlInput.value;if(text===htmlInput.oldValue_){return}htmlInput.oldValue_=text;this.setText(text);var bBox=this.group_.getBBox();var htmlInputFrame=Blockly.FieldTextInput.svgForeignObject_;htmlInputFrame.setAttribute('width',bBox.width);htmlInput.style.width=(bBox.width-2)+'px';if(Blockly.RTL){var xy=Blockly.getAbsoluteXY_(this.group_);htmlInputFrame.setAttribute('x',xy.x-4)}};Blockly.FieldTextInput.prototype.closeEditor_=function(save){var htmlInput=Blockly.FieldTextInput.htmlInput_;Blockly.unbindEvent_(htmlInput,'blur',htmlInput.onBlurWrapper_);Blockly.unbindEvent_(htmlInput,'keyup',htmlInput.onKeyUpWrapper_);Blockly.unbindEvent_(htmlInput,'keypress',htmlInput.onKeyPressWrapper_);var text;if(save){text=htmlInput.value;if(this.validationFunc_){text=this.validationFunc_(text);if(text===null){text=htmlInput.defaultValue}}}else{text=htmlInput.defaultValue}this.setText(text);htmlInput.value='';htmlInput.defaultValue='';delete htmlInput.oldValue_;var htmlInputFrame=Blockly.FieldTextInput.svgForeignObject_;htmlInputFrame.style.display='none';this.sourceBlock_.render()};Blockly.Flyout=function(){this.workspace_=new Blockly.Workspace(false)};Blockly.Flyout.prototype.autoClose=true;Blockly.Flyout.prototype.CORNER_RADIUS=8;Blockly.Flyout.prototype.createDom=function(){this.svgGroup_=Blockly.createSvgElement('g',{},null);this.svgBackground_=Blockly.createSvgElement('path',{'class':'blocklyFlyoutBackground'},this.svgGroup_);this.svgOptions_=Blockly.createSvgElement('g',{},this.svgGroup_);this.svgOptions_.appendChild(this.workspace_.createDom());return this.svgGroup_};Blockly.Flyout.prototype.getMetrics=function(){if(!this.isVisible()){return null}var viewHeight=this.height_-2*this.CORNER_RADIUS;var viewWidth=this.width_;try{var optionBox=this.svgOptions_.getBBox()}catch(e){var optionBox={height:0,y:0}}return{viewHeight:viewHeight,viewWidth:viewWidth,contentHeight:optionBox.height+optionBox.y,viewTop:-this.svgOptions_.scrollY,contentTop:0,absoluteTop:this.CORNER_RADIUS,absoluteLeft:0}};Blockly.Flyout.prototype.setMetrics=function(yRatio){var metrics=this.getMetrics();if(typeof yRatio.y=='number'){this.svgOptions_.scrollY=-metrics.contentHeight*yRatio.y-metrics.contentTop}var y=this.svgOptions_.scrollY+metrics.absoluteTop;this.svgOptions_.setAttribute('transform','translate(0,'+y+')')};Blockly.Flyout.prototype.init=function(workspace,workspaceMetrics){this.targetWorkspace_=workspace;this.targetWorkspaceMetrics_=workspaceMetrics;this.width_=0;this.height_=0;var flyout=this;new Blockly.Scrollbar(this.svgOptions_,function(){return flyout.getMetrics()},function(ratio){return flyout.setMetrics(ratio)},false,false);this.buttons_=[];this.position_();Blockly.bindEvent_(window,'resize',this,this.position_)};Blockly.Flyout.prototype.position_=function(){var metrics=this.targetWorkspaceMetrics_();if(!metrics){return}var edgeWidth=this.width_-this.CORNER_RADIUS;if(Blockly.RTL){edgeWidth*=-1}var path=['M '+(Blockly.RTL?this.width_:0)+',0'];path.push('h',edgeWidth);path.push('a',this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,Blockly.RTL?0:1,Blockly.RTL?-this.CORNER_RADIUS:this.CORNER_RADIUS,this.CORNER_RADIUS);path.push('v',Math.max(0,metrics.viewHeight-this.CORNER_RADIUS*2));path.push('a',this.CORNER_RADIUS,this.CORNER_RADIUS,0,0,Blockly.RTL?0:1,Blockly.RTL?this.CORNER_RADIUS:-this.CORNER_RADIUS,this.CORNER_RADIUS);path.push('h',-edgeWidth);path.push('z');this.svgBackground_.setAttribute('d',path.join(' '));var x=metrics.absoluteLeft;if(Blockly.RTL){x-=this.width_}this.svgGroup_.setAttribute('transform','translate('+x+','+metrics.absoluteTop+')');this.height_=metrics.viewHeight};Blockly.Flyout.prototype.isVisible=function(){return this.svgGroup_.style.display!='none'};Blockly.Flyout.prototype.hide=function(){this.svgGroup_.style.display='none';var blocks=this.workspace_.getTopBlocks(false);for(var x=0,block;block=blocks[x];x++){block.destroy()}for(var x=0,rect;rect=this.buttons_[x];x++){Blockly.unbindEvent_(rect,'mousedown',rect.wrapper_);rect.parentNode.removeChild(rect)}this.buttons_=[]};Blockly.Flyout.prototype.show=function(names){var margin=this.CORNER_RADIUS;this.svgGroup_.style.display='block';var blocks=[];var gaps=[];if(names==Blockly.MSG_VARIABLE_CATEGORY){Blockly.Variables.flyoutCategory(blocks,gaps,margin,this.workspace_)}else if(names==Blockly.MSG_PROCEDURE_CATEGORY){Blockly.Procedures.flyoutCategory(blocks,gaps,margin,this.workspace_)}else{for(var i=0,name;name=names[i];i++){var block=new Blockly.Block(this.workspace_,name);block.initSvg();blocks[i]=block;gaps[i]=margin*2}}var flyoutWidth=0;var cursorY=margin;for(var i=0,block;block=blocks[i];i++){block.isInFlyout=true;Blockly.Comment&&block.setCommentText(null);block.render();var bBox=block.getSvgRoot().getBBox();var x=Blockly.RTL?0:margin+Blockly.BlockSvg.TAB_WIDTH;block.moveBy(x,cursorY);flyoutWidth=Math.max(flyoutWidth,bBox.width);cursorY+=bBox.height+gaps[i];Blockly.bindEvent_(block.getSvgRoot(),'mousedown',null,Blockly.Flyout.createBlockFunc_(this,block))}flyoutWidth+=margin+Blockly.BlockSvg.TAB_WIDTH+margin/2+Blockly.Scrollbar.scrollbarThickness;for(var i=0,block;block=blocks[i];i++){if(Blockly.RTL){block.moveBy(flyoutWidth-margin-Blockly.BlockSvg.TAB_WIDTH,0)}var bBox=block.getSvgRoot().getBBox();var xy=block.getRelativeToSurfaceXY();var rect=Blockly.createSvgElement('rect',{width:bBox.width,height:bBox.height,x:xy.x+bBox.x,y:xy.y+bBox.y,'fill-opacity':0},null);this.svgOptions_.insertBefore(rect,this.svgOptions_.firstChild);rect.wrapper_=Blockly.bindEvent_(rect,'mousedown',null,Blockly.Flyout.createBlockFunc_(this,block));this.buttons_[i]=rect}this.width_=flyoutWidth;Blockly.fireUiEvent(Blockly.svgDoc,window,'resize')};Blockly.Flyout.createBlockFunc_=function(flyout,originBlock){return function(e){if(e.button==2){return}var xml=Blockly.Xml.blockToDom_(originBlock);var block=Blockly.Xml.domToBlock_(flyout.targetWorkspace_,xml);var xyOld=Blockly.getAbsoluteXY_(originBlock.getSvgRoot());var xyNew=Blockly.getAbsoluteXY_(flyout.targetWorkspace_.getCanvas());block.moveBy(xyOld.x-xyNew.x,xyOld.y-xyNew.y);block.render();if(flyout.autoClose){flyout.hide()}block.onMouseDown_(e)}};Blockly.Generator={};Blockly.Generator.NAME_TYPE='generated_function';Blockly.Generator.languages={};Blockly.Generator.get=function(name){if(!(name in Blockly.Generator.languages)){var generator={};generator.blockToCode=function(block,opt_dropParens){if(!block){return''}var func=this[block.type];if(!func){throw'Language "'+name+'" does not know how to generate code '+'for block type "'+block.type+'"';}var code=func.call(block,opt_dropParens);return this.scrub_(block,code)};generator.valueToCode=function(block,name,opt_dropParens){var input=block.getInputTargetBlock(name);return this.blockToCode(input,opt_dropParens)};generator.statementToCode=function(block,name){var input=block.getInputTargetBlock(name);var code=this.blockToCode(input);if(code){code=Blockly.Generator.prefixLines(code,'  ')}return code};Blockly.Generator.languages[name]=generator}return Blockly.Generator.languages[name]};Blockly.Generator.workspaceToCode=function(name){var code=[];var generator=Blockly.Generator.get(name);generator.init();var blocks=Blockly.mainWorkspace.getTopBlocks(true);for(var x=0,block;block=blocks[x];x++){var line=generator.blockToCode(block,true);if(block.outputConnection&&generator.scrubNakedValue){line=generator.scrubNakedValue(line)}code.push(line)}code=code.join('\n');code=generator.finish(code);code=code.replace(/^\s+\n/,'');code=code.replace(/\n\s+$/,'\n');code=code.replace(/[ \t]+\n/g,'\n');return code};Blockly.Generator.prefixLines=function(text,prefix){return prefix+text.replace(/\n(.)/g,'\n'+prefix+'$1')};Blockly.Generator.allNestedComments=function(block){var comments=[];var blocks=block.getDescendants();for(var x=0;x<blocks.length;x++){var comment=blocks[x].getCommentText();if(comment){comments.push(comment)}}if(comments.length){comments.push('')}return comments.join('\n')};Blockly.inject=function(container,opt_options){if(opt_options){Blockly.parseOptions_(opt_options)}Blockly.createDom_(container);Blockly.init_()};Blockly.parseOptions_=function(options){Blockly.RTL=!!options['rtl'];Blockly.editable=!options['readOnly'];Blockly.pathToBlockly=options['path']||'./'};Blockly.createDom_=function(container){var doc=container;while(doc.parentNode){doc=doc.parentNode}Blockly.svgDoc=doc;var link=doc.createElement('link');link.setAttribute('href',Blockly.pathToBlockly+'blockly.css');link.setAttribute('rel','stylesheet');link.setAttribute('type','text/css');link.setAttribute('onload','Blockly.cssLoaded()');var head=doc.head||doc.getElementsByTagName('head')[0];if(!head){throw'No head in document.';}head.appendChild(link);var svg=Blockly.createSvgElement('svg',{'xmlns':'http://www.w3.org/2000/svg','xmlns:html':'http://www.w3.org/1999/xhtml','xmlns:xlink':'http://www.w3.org/1999/xlink','version':'1.1','class':'blocklySvg'},null);var defs=Blockly.createSvgElement('defs',{},svg);var filter,feSpecularLighting,feMerge;filter=Blockly.createSvgElement('filter',{id:'blocklyEmboss'},defs);Blockly.createSvgElement('feGaussianBlur',{'in':'SourceAlpha',stdDeviation:1,result:'blur'},filter);feSpecularLighting=Blockly.createSvgElement('feSpecularLighting',{'in':'blur',surfaceScale:1,specularConstant:0.5,specularExponent:10,'lighting-color':'white',result:'specOut'},filter);Blockly.createSvgElement('fePointLight',{x:-5000,y:-10000,z:20000},feSpecularLighting);Blockly.createSvgElement('feComposite',{'in':'specOut',in2:'SourceAlpha',operator:'in',result:'specOut'},filter);Blockly.createSvgElement('feComposite',{'in':'SourceGraphic',in2:'specOut',operator:'arithmetic',k1:0,k2:1,k3:1,k4:0},filter);filter=Blockly.createSvgElement('filter',{id:'blocklyTrashcanShadowFilter'},defs);Blockly.createSvgElement('feGaussianBlur',{'in':'SourceAlpha',stdDeviation:2,result:'blur'},filter);Blockly.createSvgElement('feOffset',{'in':'blur',dx:1,dy:1,result:'offsetBlur'},filter);feMerge=Blockly.createSvgElement('feMerge',{},filter);Blockly.createSvgElement('feMergeNode',{'in':'offsetBlur'},feMerge);Blockly.createSvgElement('feMergeNode',{'in':'SourceGraphic'},feMerge);filter=Blockly.createSvgElement('filter',{id:'blocklyShadowFilter'},defs);Blockly.createSvgElement('feGaussianBlur',{stdDeviation:2},filter);Blockly.mainWorkspace=new Blockly.Workspace(Blockly.editable);svg.appendChild(Blockly.mainWorkspace.createDom());svg.appendChild(Blockly.FieldTextInput.createDom());Blockly.commentCanvas=Blockly.createSvgElement('g',{},svg);if(Blockly.Toolbox&&Blockly.editable){svg.appendChild(Blockly.Toolbox.createDom())}if(Blockly.Mutator&&Blockly.editable){svg.appendChild(Blockly.Mutator.createDom())}Blockly.Tooltip&&svg.appendChild(Blockly.Tooltip.createDom());if(Blockly.editable){svg.appendChild(Blockly.FieldDropdown.createDom())}if(Blockly.ContextMenu){svg.appendChild(Blockly.ContextMenu.createDom())}container.appendChild(svg);Blockly.svg=svg;Blockly.svgResize()};Blockly.init_=function(){var doc=Blockly.svgDoc;Blockly.bindEvent_(window,'resize',doc,Blockly.svgResize);Blockly.bindEvent_(Blockly.svg,'mousedown',null,Blockly.onMouseDown_);Blockly.bindEvent_(doc,'mouseup',null,Blockly.onMouseUp_);Blockly.bindEvent_(Blockly.svg,'mousemove',null,Blockly.onMouseMove_);Blockly.bindEvent_(Blockly.svg,'contextmenu',null,Blockly.onContextMenu_);Blockly.bindEvent_(doc,'keydown',null,Blockly.onKeyDown_);if(Blockly.editable){Blockly.Toolbox&&Blockly.Toolbox.init();Blockly.Mutator&&Blockly.Mutator.init()}Blockly.mainWorkspace.addTrashcan(Blockly.getMainWorkspaceMetrics);Blockly.mainWorkspace.scrollbar=new Blockly.ScrollbarPair(Blockly.mainWorkspace.getCanvas(),Blockly.getMainWorkspaceMetrics,this.setMainWorkspaceMetrics);Blockly.loadAudio_('click');Blockly.loadAudio_('delete')};Blockly.Mutator=function(block,quarkNames){this.block_=block;this.quarkNames_=quarkNames};Blockly.Mutator.ICON_SIZE=16;Blockly.Mutator.isOpen=false;Blockly.Mutator.prototype.destroy=function(){this.iconGroup_.parentNode.removeChild(this.iconGroup_);this.iconGroup_=null;this.block_.mutator=null;this.block_=null};Blockly.Mutator.prototype.createIcon=function(){var quantum=Blockly.Mutator.ICON_SIZE/8;this.iconGroup_=Blockly.createSvgElement('g',{},null);if(this.block_.editable){this.iconGroup_.setAttribute('class','blocklyIconGroup')}var iconShield=Blockly.createSvgElement('rect',{'class':'blocklyIconShield',width:8*quantum,height:8*quantum,rx:2*quantum,ry:2*quantum},this.iconGroup_);if(!Blockly.Mutator.crossPath_){var path=[];path.push('M',(3.5*quantum)+','+(3.5*quantum));path.push('v',-2*quantum,'h',quantum);path.push('v',2*quantum,'h',2*quantum);path.push('v',quantum,'h',-2*quantum);path.push('v',2*quantum,'h',-quantum);path.push('v',-2*quantum,'h',-2*quantum);path.push('v',-quantum,'z');Blockly.Mutator.crossPath_=path.join(' ')}var iconMark=Blockly.createSvgElement('path',{'class':'blocklyMutatorMark',d:Blockly.Mutator.crossPath_},this.iconGroup_);this.block_.getSvgRoot().appendChild(this.iconGroup_);if(this.block_.editable){Blockly.bindEvent_(this.iconGroup_,'mouseup',this,this.onMouseUp_)}if(Blockly.Tooltip){this.tooltip=Blockly.MSG_MUTATOR_TOOLTIP;iconShield.tooltip=this;iconMark.tooltip=this;Blockly.Tooltip.bindMouseEvents(iconShield);Blockly.Tooltip.bindMouseEvents(iconMark)}};Blockly.Mutator.prototype.renderIcon=function(titleX){if(this.block_.collapsed){this.iconGroup_.setAttribute('display','none');return 0}this.iconGroup_.setAttribute('display','block');var TOP_MARGIN=5;var diameter=Blockly.Mutator.ICON_SIZE;if(Blockly.RTL){titleX-=diameter}this.iconGroup_.setAttribute('transform','translate('+titleX+', '+TOP_MARGIN+')');return diameter};Blockly.Mutator.prototype.onMouseUp_=function(e){if(e.button==2){return}else if(Blockly.Block.dragMode_==2){return}Blockly.Mutator.openDialog_(this.block_)};Blockly.Mutator.createDom=function(){var svgGroup=Blockly.createSvgElement('g',{'class':'blocklyHidden'},null);Blockly.Mutator.svgGroup_=svgGroup;Blockly.Mutator.svgShadow_=Blockly.createSvgElement('rect',{'class':'blocklyScreenShadow'},svgGroup);Blockly.Mutator.svgDialog_=Blockly.createSvgElement('svg',{},svgGroup);Blockly.Mutator.svgBackground_=Blockly.createSvgElement('rect',{'class':'blocklyMutatorBackground',height:'100%',width:'100%'},Blockly.Mutator.svgDialog_);Blockly.Mutator.svgHeader_=Blockly.createSvgElement('text',{'class':'blocklyHeader',y:30},Blockly.Mutator.svgDialog_);var textNode=Blockly.svgDoc.createTextNode(Blockly.MSG_MUTATOR_HEADER);Blockly.Mutator.svgHeader_.appendChild(textNode);Blockly.Mutator.helpButton_=new Blockly.Mutator.Button(Blockly.MSG_HELP,false,Blockly.Mutator.showHelp_);Blockly.Mutator.cancelButton_=new Blockly.Mutator.Button(Blockly.MSG_MUTATOR_CANCEL,false,Blockly.Mutator.closeDialog);Blockly.Mutator.changeButton_=new Blockly.Mutator.Button(Blockly.MSG_MUTATOR_CHANGE,true,Blockly.Mutator.saveDialog_);Blockly.Mutator.svgDialog_.appendChild(Blockly.Mutator.helpButton_.createDom());Blockly.Mutator.svgDialog_.appendChild(Blockly.Mutator.cancelButton_.createDom());Blockly.Mutator.svgDialog_.appendChild(Blockly.Mutator.changeButton_.createDom());Blockly.Mutator.workspace_=new Blockly.Workspace(true);Blockly.Mutator.flyout_=new Blockly.Flyout();Blockly.Mutator.flyout_.autoClose=false;Blockly.Mutator.svgDialog_.appendChild(Blockly.Mutator.flyout_.createDom());Blockly.Mutator.svgDialog_.appendChild(Blockly.Mutator.workspace_.createDom());return svgGroup};Blockly.Mutator.init=function(){Blockly.Mutator.helpButton_.init();Blockly.Mutator.cancelButton_.init();Blockly.Mutator.changeButton_.init();Blockly.Mutator.headerLength_=Blockly.Mutator.svgHeader_.getComputedTextLength();Blockly.Mutator.helpLength_=Blockly.Mutator.helpButton_.getBBox().width;Blockly.Mutator.cancelLength_=Blockly.Mutator.cancelButton_.getBBox().width;var bBoxChange=Blockly.Mutator.changeButton_.getBBox();Blockly.Mutator.changeLength_=bBoxChange.width;Blockly.Mutator.workspaceLeft_=0;Blockly.Mutator.workspaceTop_=bBoxChange.height+10;Blockly.Mutator.workspace_.addTrashcan(Blockly.Mutator.getWorkspaceMetrics_);Blockly.Mutator.flyout_.init(Blockly.Mutator.workspace_,Blockly.Mutator.getFlyoutMetrics_)};Blockly.Mutator.position_=function(){var svgSize=Blockly.svgSize();Blockly.Mutator.svgShadow_.setAttribute('width',svgSize.width);Blockly.Mutator.svgShadow_.setAttribute('height',svgSize.height);var MARGIN=40;var width=Math.max(0,svgSize.width-2*MARGIN);var height=Math.max(0,svgSize.height-2*MARGIN);Blockly.Mutator.svgDialog_.setAttribute('x',MARGIN);Blockly.Mutator.svgDialog_.setAttribute('y',MARGIN);Blockly.Mutator.svgDialog_.setAttribute('width',width);Blockly.Mutator.svgDialog_.setAttribute('height',height);Blockly.Mutator.svgDialog_.setAttribute('viewBox','0 0 '+width+' '+height);var headerX=Blockly.ContextMenu.X_PADDING;if(Blockly.RTL){headerX=width-Blockly.Mutator.headerLength_-headerX}Blockly.Mutator.svgHeader_.setAttribute('x',headerX);var cursorX;var cursorY=5;if(Blockly.RTL){cursorX=Blockly.ContextMenu.X_PADDING;Blockly.Mutator.changeButton_.setLocation(cursorX,cursorY);cursorX+=Blockly.Mutator.changeLength_+Blockly.ContextMenu.X_PADDING;Blockly.Mutator.cancelButton_.setLocation(cursorX,cursorY);cursorX+=Blockly.Mutator.cancelLength_+Blockly.ContextMenu.X_PADDING;Blockly.Mutator.helpButton_.setLocation(cursorX,cursorY);cursorX+=Blockly.Mutator.helpLength_;cursorX=headerX-cursorX}else{var cursorX=width-Blockly.ContextMenu.X_PADDING-Blockly.Mutator.changeLength_;Blockly.Mutator.changeButton_.setLocation(cursorX,cursorY);cursorX-=Blockly.ContextMenu.X_PADDING+Blockly.Mutator.cancelLength_;Blockly.Mutator.cancelButton_.setLocation(cursorX,cursorY);cursorX-=Blockly.ContextMenu.X_PADDING+Blockly.Mutator.helpLength_;Blockly.Mutator.helpButton_.setLocation(cursorX,cursorY);Blockly.Mutator.helpButton_.setVisible(cursorX>0);cursorX-=headerX+Blockly.Mutator.headerLength_}Blockly.Mutator.svgHeader_.style.display=(cursorX>0)?'block':'none';Blockly.Mutator.workspaceWidth_=width;Blockly.Mutator.workspaceHeight_=height-Blockly.Mutator.workspaceTop_};Blockly.Mutator.getFlyoutMetrics_=function(){if(!Blockly.Mutator.isOpen){return null}var left=Blockly.Mutator.workspaceLeft_;if(Blockly.RTL){left+=Blockly.Mutator.workspaceWidth_}return{viewHeight:Blockly.Mutator.workspaceHeight_,absoluteTop:Blockly.Mutator.workspaceTop_,absoluteLeft:left}};Blockly.Mutator.getWorkspaceMetrics_=function(){if(!Blockly.Mutator.isOpen){return null}return{viewHeight:Blockly.Mutator.workspaceHeight_,viewWidth:Blockly.Mutator.workspaceWidth_,absoluteTop:Blockly.Mutator.workspaceTop_,absoluteLeft:Blockly.Mutator.workspaceLeft_}};Blockly.Mutator.showHelp_=function(){Blockly.Mutator.sourceBlock_.showHelp_()};Blockly.Mutator.openDialog_=function(block){Blockly.Mutator.isOpen=true;Blockly.Mutator.sourceBlock_=block;Blockly.Mutator.helpButton_.setVisible(!!block.helpUrl);Blockly.removeClass_(Blockly.Mutator.svgGroup_,'blocklyHidden');Blockly.Mutator.position_();Blockly.fireUiEvent(Blockly.svgDoc,window,'resize');Blockly.Mutator.resizeWrapper_=Blockly.bindEvent_(window,'resize',null,Blockly.Mutator.position_);Blockly.Mutator.flyout_.show(block.mutator.quarkNames_);Blockly.Mutator.rootBlock_=block.decompose(Blockly.Mutator.workspace_);var blocks=Blockly.Mutator.rootBlock_.getDescendants();for(var i=0,child;child=blocks[i];i++){child.render()}var x=150;if(Blockly.RTL){x=Blockly.Mutator.workspaceWidth_-x}Blockly.Mutator.rootBlock_.moveBy(x,50)};Blockly.Mutator.closeDialog=function(){Blockly.Mutator.isOpen=false;Blockly.addClass_(Blockly.Mutator.svgGroup_,'blocklyHidden');Blockly.unbindEvent_(window,'resize',Blockly.Mutator.resizeWrapper_);Blockly.Mutator.resizeWrapper_=null;Blockly.Mutator.flyout_.hide();var blocks=Blockly.Mutator.workspace_.getTopBlocks(false);for(var x=0,block;block=blocks[x];x++){block.destroy()}Blockly.Mutator.sourceBlock_=null;Blockly.Mutator.rootBlock_=null};Blockly.Mutator.saveDialog_=function(){Blockly.Mutator.sourceBlock_.compose(Blockly.Mutator.rootBlock_);Blockly.Mutator.closeDialog()};Blockly.Mutator.Button=function(caption,launch,action){this.caption_=caption;this.launch_=launch;this.action_=action};Blockly.Mutator.Button.prototype.destroy=function(){if(this.onClickWrapper_){Blockly.unbindEvent_(this.svgGroup_,'click',this.onClickWrapper_);this.onClickWrapper_=null}this.svgGroup_.parentNode.removeChild(this.svgGroup_);this.svgGroup_=null;this.svgShadow_=null;this.svgBackground_=null;this.svgText_=null};Blockly.Mutator.Button.prototype.createDom=function(){var className='blocklyButton';if(this.launch_){className+=' blocklyLaunchButton'}this.svgGroup_=Blockly.createSvgElement('g',{'class':className},null);this.svgShadow_=Blockly.createSvgElement('rect',{rx:5,ry:5,x:2,y:2,'class':'blocklyButtonShadow'},this.svgGroup_);this.svgBackground_=Blockly.createSvgElement('rect',{rx:5,ry:5,'class':'blocklyButtonBackground'},this.svgGroup_);this.svgText_=Blockly.createSvgElement('text',{'class':'blocklyButtonText'},this.svgGroup_);this.svgText_.appendChild(Blockly.svgDoc.createTextNode(this.caption_));this.onClickWrapper_=null;if(this.action_){this.onClickWrapper_=Blockly.bindEvent_(this.svgGroup_,'click',this,this.action_)}return this.svgGroup_};Blockly.Mutator.Button.prototype.init=function(){var X_PADDING=Blockly.ContextMenu.X_PADDING;try{var bBox=this.svgText_.getBBox()}catch(e){var bBox={height:0,width:0}}this.svgShadow_.setAttribute('width',bBox.width+2*X_PADDING);this.svgShadow_.setAttribute('height',bBox.height+10);this.svgBackground_.setAttribute('width',bBox.width+2*X_PADDING);this.svgBackground_.setAttribute('height',bBox.height+10);this.svgText_.setAttribute('x',X_PADDING);this.svgText_.setAttribute('y',bBox.height)};Blockly.Mutator.Button.prototype.getBBox=function(){try{return this.svgGroup_.getBBox()}catch(e){return{height:0,width:0}}};Blockly.Mutator.Button.prototype.setLocation=function(x,y){this.svgGroup_.setAttribute('transform','translate('+x+','+y+')')};Blockly.Mutator.Button.prototype.setVisible=function(visible){this.svgGroup_.setAttribute('display',visible?'block':'none')};Blockly.Names=function(reservedWords){this.reservedDict_={};if(reservedWords){for(var x=0;x<reservedWords.length;x++){this.reservedDict_[Blockly.Names.PREFIX_+reservedWords[x]]=true}}this.reset()};Blockly.Names.PREFIX_='v_';Blockly.Names.prototype.reset=function(){this.db_={};this.dbReverse_={}};Blockly.Names.prototype.getName=function(name,type){var normalized=Blockly.Names.PREFIX_+name.toLowerCase()+'X'+type;if(normalized in this.db_){return this.db_[normalized]}else{return this.getDistinctName(name,type)}};Blockly.Names.prototype.getDistinctName=function(name,type){var safeName=this.safeName_(name);var i='';while(this.dbReverse_[Blockly.Names.PREFIX_+safeName+i]||(Blockly.Names.PREFIX_+safeName+i)in this.reservedDict_){i=i?i+1:2}safeName+=i;this.db_[Blockly.Names.PREFIX_+name.toLowerCase()+'X'+type]=safeName;this.dbReverse_[Blockly.Names.PREFIX_+safeName]=true;return safeName};Blockly.Names.prototype.safeName_=function(name){if(!name){name='unnamed'}else{name=encodeURI(name.replace(/ /g,'_')).replace(/[^\w]/g,'_');if('0123456789'.indexOf(name.charAt(0))!=-1){name='my_'+name}}return name};Blockly.Names.equals=function(name1,name2){return name1.toLowerCase()==name2.toLowerCase()};Blockly.Procedures={};Blockly.Procedures.NAME_TYPE='procedure';Blockly.Procedures.allProcedures=function(){var blocks=Blockly.mainWorkspace.getAllBlocks(false);var proceduresReturn=[];var proceduresNoReturn=[];for(var x=0;x<blocks.length;x++){var func=blocks[x].getProcedureDef;if(func){var tuple=func.call(blocks[x]);if(tuple){if(tuple[1]){proceduresReturn.push(tuple[0])}else{proceduresNoReturn.push(tuple[0])}}}}proceduresNoReturn.sort(Blockly.caseInsensitiveComparator);proceduresReturn.sort(Blockly.caseInsensitiveComparator);return[proceduresNoReturn,proceduresReturn]};Blockly.Procedures.findLegalName=function(name,block){if(!block.workspace.editable){return name}while(!Blockly.Procedures.isLegalName(name,block.workspace,block)){var r=name.match(/^(.*?)(\d+)$/);if(!r){name+='2'}else{name=r[1]+(parseInt(r[2],10)+1)}}return name};Blockly.Procedures.isLegalName=function(name,workspace,opt_exclude){name=name.toLowerCase();var blocks=workspace.getAllBlocks(false);for(var x=0;x<blocks.length;x++){if(blocks[x]==opt_exclude){continue}var func=blocks[x].getProcedureDef;if(func){var procName=func.call(blocks[x]);if(procName[0].toLowerCase()==name){return false}}}return true};Blockly.Procedures.rename=function(text){if(!this.sourceBlock_.editable){return text}text=text.replace(/^[\s\xa0]+|[\s\xa0]+$/g,'');if(!text){return null}text=Blockly.Procedures.findLegalName(text,this.sourceBlock_);var blocks=this.sourceBlock_.workspace.getAllBlocks(false);for(var x=0;x<blocks.length;x++){var func=blocks[x].renameProcedure;if(func){func.call(blocks[x],this.text_,text)}}return text};Blockly.Procedures.flyoutCategory=function(blocks,gaps,margin,workspace){if(Blockly.Language.procedures_defnoreturn){var block=new Blockly.Block(workspace,'procedures_defnoreturn');block.initSvg();blocks.push(block);gaps.push(margin*2)}if(Blockly.Language.procedures_defnoreturn){var block=new Blockly.Block(workspace,'procedures_defreturn');block.initSvg();blocks.push(block);gaps.push(margin*2)}var tuple=Blockly.Procedures.allProcedures();var proceduresNoReturn=tuple[0];var proceduresReturn=tuple[1];if(Blockly.Language.procedures_callnoreturn){for(var x=0;x<proceduresNoReturn.length;x++){var block=new Blockly.Block(workspace,'procedures_callnoreturn');block.setTitleText(proceduresNoReturn[x],'NAME');block.initSvg();blocks.push(block);gaps.push(margin*2)}}if(Blockly.Language.procedures_callreturn){for(var x=0;x<proceduresReturn.length;x++){var block=new Blockly.Block(workspace,'procedures_callreturn');block.setTitleText(proceduresReturn[x],'NAME');block.initSvg();blocks.push(block);gaps.push(margin*2)}}};Blockly.Procedures.destroyCallers=function(name,workspace){name=name.toLowerCase();var blocks=workspace.getAllBlocks(false);for(var x=0;x<blocks.length;x++){var func=blocks[x].getProcedureCall;if(func){var procName=func.call(blocks[x]);if(procName&&procName.toLowerCase()==name){blocks[x].destroy(true)}}}};Blockly.ScrollbarPair=function(element,getMetrics,setMetrics){this.element_=element;this.getMetrics_=getMetrics;this.setMetrics_=setMetrics;this.oldHostMetrics_={};this.hScroll=new Blockly.Scrollbar(element,getMetrics,setMetrics,true,true);this.vScroll=new Blockly.Scrollbar(element,getMetrics,setMetrics,false,true);this.corner_=this.addCorner_(element);this.resize();var pair=this;Blockly.bindEvent_(window,'resize',pair,function(){pair.resize()})};Blockly.ScrollbarPair.prototype.addCorner_=function(element){var corner=Blockly.createSvgElement('rect',{height:Blockly.Scrollbar.scrollbarThickness,width:Blockly.Scrollbar.scrollbarThickness,style:'fill: #fff'},null);Blockly.Scrollbar.insertAfter_(corner,element);return corner};Blockly.ScrollbarPair.prototype.resize=function(){var hostMetrics=this.getMetrics_();if(!hostMetrics){return}var resizeH=false;var resizeV=false;if(this.oldHostMetrics_.viewWidth!=hostMetrics.viewWidth||this.oldHostMetrics_.viewHeight!=hostMetrics.viewHeight||this.oldHostMetrics_.absoluteTop!=hostMetrics.absoluteTop||this.oldHostMetrics_.absoluteLeft!=hostMetrics.absoluteLeft){resizeH=true;resizeV=true}else{if(this.oldHostMetrics_.contentWidth!=hostMetrics.contentWidth||this.oldHostMetrics_.viewLeft!=hostMetrics.viewLeft||this.oldHostMetrics_.contentLeft!=hostMetrics.contentLeft){resizeH=true}if(this.oldHostMetrics_.contentHeight!=hostMetrics.contentHeight||this.oldHostMetrics_.viewTop!=hostMetrics.viewTop||this.oldHostMetrics_.contentTop!=hostMetrics.contentTop){resizeV=true}}if(resizeH){this.hScroll.resize(hostMetrics)}if(resizeV){this.vScroll.resize(hostMetrics)}if(this.oldHostMetrics_.viewWidth!=hostMetrics.viewWidth||this.oldHostMetrics_.absoluteLeft!=hostMetrics.absoluteLeft){this.corner_.setAttribute('x',this.vScroll.xCoordinate)}if(this.oldHostMetrics_.viewHeight!=hostMetrics.viewHeight||this.oldHostMetrics_.absoluteTop!=hostMetrics.absoluteTop){this.corner_.setAttribute('y',this.hScroll.yCoordinate)}this.oldHostMetrics_=hostMetrics};Blockly.ScrollbarPair.prototype.set=function(x,y){if(Blockly.Scrollbar===Blockly.ScrollbarNative){this.hScroll.set(x,false);this.vScroll.set(y,false);var xyRatio={};xyRatio.x=(this.hScroll.outerDiv_.scrollLeft/this.hScroll.innerImg_.offsetWidth)||0;xyRatio.y=(this.vScroll.outerDiv_.scrollTop/this.vScroll.innerImg_.offsetHeight)||0;this.setMetrics_(xyRatio)}else{this.hScroll.set(x,true);this.vScroll.set(y,true)}};Blockly.ScrollbarNative=function(element,getMetrics,setMetrics,horizontal,opt_pair){this.element_=element;this.getMetrics_=getMetrics;this.setMetrics_=setMetrics;this.pair_=opt_pair||false;this.horizontal_=horizontal;this.createDom_(element);if(horizontal===null){return}if(!Blockly.ScrollbarNative.scrollbarThickness){Blockly.ScrollbarNative.measureScrollbarThickness_(element)}if(horizontal){this.foreignObject_.setAttribute('height',Blockly.ScrollbarNative.scrollbarThickness);this.outerDiv_.style.height=Blockly.ScrollbarNative.scrollbarThickness+'px';this.outerDiv_.style.overflowX='scroll';this.outerDiv_.style.overflowY='hidden';this.innerImg_.style.height='1px'}else{this.foreignObject_.setAttribute('width',Blockly.ScrollbarNative.scrollbarThickness);this.outerDiv_.style.width=Blockly.ScrollbarNative.scrollbarThickness+'px';this.outerDiv_.style.overflowX='hidden';this.outerDiv_.style.overflowY='scroll';this.innerImg_.style.width='1px'}var scrollbar=this;this.onScrollWrapper_=Blockly.bindEvent_(this.outerDiv_,'scroll',scrollbar,function(){scrollbar.onScroll_()});Blockly.bindEvent_(this.foreignObject_,'mousedown',null,Blockly.noEvent);if(!this.pair_){this.resize();Blockly.bindEvent_(window,'resize',scrollbar,function(){scrollbar.resize()})}};Blockly.ScrollbarNative.prototype.resize=function(opt_metrics){var hostMetrics=opt_metrics;if(!hostMetrics){hostMetrics=this.getMetrics_();if(!hostMetrics){return}}if(this.horizontal_){var outerLength=hostMetrics.viewWidth;if(this.pair_){outerLength-=Blockly.ScrollbarNative.scrollbarThickness}else{this.setVisible(outerLength<hostMetrics.contentHeight)}this.ratio_=outerLength/hostMetrics.viewWidth;var innerLength=this.ratio_*hostMetrics.contentWidth;var innerOffset=(hostMetrics.viewLeft-hostMetrics.contentLeft)*this.ratio_;this.outerDiv_.style.width=outerLength+'px';this.innerImg_.style.width=innerLength+'px';this.xCoordinate=hostMetrics.absoluteLeft;if(this.pair_&&Blockly.RTL){this.xCoordinate+=Blockly.ScrollbarNative.scrollbarThickness}this.yCoordinate=hostMetrics.absoluteTop+hostMetrics.viewHeight-Blockly.ScrollbarNative.scrollbarThickness;this.foreignObject_.setAttribute('x',this.xCoordinate);this.foreignObject_.setAttribute('y',this.yCoordinate);this.foreignObject_.setAttribute('width',Math.max(0,outerLength));this.outerDiv_.scrollLeft=Math.round(innerOffset)}else{var outerLength=hostMetrics.viewHeight;if(this.pair_){outerLength-=Blockly.ScrollbarNative.scrollbarThickness}else{this.setVisible(outerLength<hostMetrics.contentHeight)}this.ratio_=outerLength/hostMetrics.viewHeight;var innerLength=this.ratio_*hostMetrics.contentHeight;var innerOffset=(hostMetrics.viewTop-hostMetrics.contentTop)*this.ratio_;this.outerDiv_.style.height=outerLength+'px';this.innerImg_.style.height=innerLength+'px';this.xCoordinate=hostMetrics.absoluteLeft;if(!Blockly.RTL){this.xCoordinate+=hostMetrics.viewWidth-Blockly.ScrollbarNative.scrollbarThickness}this.yCoordinate=hostMetrics.absoluteTop;this.foreignObject_.setAttribute('x',this.xCoordinate);this.foreignObject_.setAttribute('y',this.yCoordinate);this.foreignObject_.setAttribute('height',Math.max(0,outerLength));this.outerDiv_.scrollTop=Math.round(innerOffset)}};Blockly.ScrollbarNative.prototype.createDom_=function(element){this.foreignObject_=Blockly.createSvgElement('foreignObject',{},null);var body=Blockly.svgDoc.createElementNS(Blockly.HTML_NS,'body');body.setAttribute('xmlns',Blockly.HTML_NS);body.setAttribute('class','blocklyMinimalBody');var outer=Blockly.svgDoc.createElementNS(Blockly.HTML_NS,'div');this.outerDiv_=outer;var inner=Blockly.svgDoc.createElementNS(Blockly.HTML_NS,'img');inner.setAttribute('src',Blockly.pathToBlockly+'1x1.gif');this.innerImg_=inner;outer.appendChild(inner);body.appendChild(outer);this.foreignObject_.appendChild(body);Blockly.Scrollbar.insertAfter_(this.foreignObject_,element)};Blockly.ScrollbarNative.prototype.isVisible=function(){return this.foreignObject_.style.display!='none'};Blockly.ScrollbarNative.prototype.setVisible=function(visible){if(visible==this.isVisible()){return}if(this.pair_){throw'Unable to toggle visibility of paired scrollbars.';}if(visible){this.foreignObject_.style.display='block';this.getMetrics_()}else{this.setMetrics_({x:0,y:0});this.foreignObject_.style.display='none'}};Blockly.ScrollbarNative.prototype.onScroll_=function(){var xyRatio={};if(this.horizontal_){xyRatio.x=(this.outerDiv_.scrollLeft/this.innerImg_.offsetWidth)||0}else{xyRatio.y=(this.outerDiv_.scrollTop/this.innerImg_.offsetHeight)||0}this.setMetrics_(xyRatio)};Blockly.ScrollbarNative.prototype.set=function(value,fireEvents){if(!fireEvents){Blockly.unbindEvent_(this.outerDiv_,'scroll',this.onScrollWrapper_)}if(this.horizontal_){this.outerDiv_.scrollLeft=value*this.ratio_}else{this.outerDiv_.scrollTop=value*this.ratio_}if(!fireEvents){var scrollbar=this;Blockly.bindEvent_(this.outerDiv_,'scroll',scrollbar,this.onScrollWrapper_)}};Blockly.ScrollbarNative.scrollbarThickness=0;Blockly.ScrollbarNative.measureScrollbarThickness_=function(element){var testBar=new Blockly.ScrollbarNative(element,null,null,null,false);testBar.outerDiv_.style.width='100px';testBar.outerDiv_.style.height='100px';testBar.innerImg_.style.width='100%';testBar.innerImg_.style.height='200px';testBar.foreignObject_.setAttribute('width',1);testBar.foreignObject_.setAttribute('height',1);testBar.outerDiv_.style.overflowY='scroll';var w1=testBar.innerImg_.offsetWidth;testBar.outerDiv_.style.overflowY='hidden';var w2=testBar.innerImg_.offsetWidth;element.parentNode.removeChild(testBar.foreignObject_);var thickness=w2-w1;if(thickness<=0){thickness=15}Blockly.ScrollbarNative.scrollbarThickness=thickness};Blockly.ScrollbarSvg=function(element,getMetrics,setMetrics,horizontal,opt_pair){this.element_=element;this.getMetrics_=getMetrics;this.setMetrics_=setMetrics;this.pair_=opt_pair||false;this.horizontal_=horizontal;this.createDom_(element);if(horizontal){this.svgBackground_.setAttribute('height',Blockly.ScrollbarSvg.scrollbarThickness);this.svgKnob_.setAttribute('height',Blockly.ScrollbarSvg.scrollbarThickness-6);this.svgKnob_.setAttribute('y',3)}else{this.svgBackground_.setAttribute('width',Blockly.ScrollbarSvg.scrollbarThickness);this.svgKnob_.setAttribute('width',Blockly.ScrollbarSvg.scrollbarThickness-6);this.svgKnob_.setAttribute('x',3)}var scrollbar=this;if(!this.pair_){this.resize();Blockly.bindEvent_(window,'resize',scrollbar,function(){scrollbar.resize()})}Blockly.bindEvent_(this.svgBackground_,'mousedown',scrollbar,scrollbar.onMouseDownBar_);Blockly.bindEvent_(this.svgKnob_,'mousedown',scrollbar,scrollbar.onMouseDownKnob_)};Blockly.ScrollbarSvg.prototype.resize=function(opt_metrics){var hostMetrics=opt_metrics;if(!hostMetrics){hostMetrics=this.getMetrics_();if(!hostMetrics){return}}if(this.horizontal_){var outerLength=hostMetrics.viewWidth;if(this.pair_){outerLength-=Blockly.ScrollbarSvg.scrollbarThickness}else{this.setVisible(outerLength<hostMetrics.contentHeight)}this.ratio_=outerLength/hostMetrics.contentWidth;if(this.ratio_===-Infinity||this.ratio_===Infinity||isNaN(this.ratio_)){this.ratio_=0}var innerLength=hostMetrics.viewWidth*this.ratio_;var innerOffset=(hostMetrics.viewLeft-hostMetrics.contentLeft)*this.ratio_;this.svgKnob_.setAttribute('width',Math.max(0,innerLength));this.xCoordinate=hostMetrics.absoluteLeft;if(this.pair_&&Blockly.RTL){this.xCoordinate+=hostMetrics.absoluteLeft+Blockly.ScrollbarSvg.scrollbarThickness}this.yCoordinate=hostMetrics.absoluteTop+hostMetrics.viewHeight-Blockly.ScrollbarSvg.scrollbarThickness;this.svgGroup_.setAttribute('transform','translate('+this.xCoordinate+', '+this.yCoordinate+')');this.svgBackground_.setAttribute('width',Math.max(0,outerLength));this.svgKnob_.setAttribute('x',this.constrainKnob_(innerOffset))}else{var outerLength=hostMetrics.viewHeight;if(this.pair_){outerLength-=Blockly.ScrollbarSvg.scrollbarThickness}else{this.setVisible(outerLength<hostMetrics.contentHeight)}this.ratio_=outerLength/hostMetrics.contentHeight;if(this.ratio_===-Infinity||this.ratio_===Infinity||isNaN(this.ratio_)){this.ratio_=0}var innerLength=hostMetrics.viewHeight*this.ratio_;var innerOffset=(hostMetrics.viewTop-hostMetrics.contentTop)*this.ratio_;this.svgKnob_.setAttribute('height',Math.max(0,innerLength));this.xCoordinate=hostMetrics.absoluteLeft;if(!Blockly.RTL){this.xCoordinate+=hostMetrics.viewWidth-Blockly.ScrollbarSvg.scrollbarThickness}this.yCoordinate=hostMetrics.absoluteTop;this.svgGroup_.setAttribute('transform','translate('+this.xCoordinate+', '+this.yCoordinate+')');this.svgBackground_.setAttribute('height',Math.max(0,outerLength));this.svgKnob_.setAttribute('y',this.constrainKnob_(innerOffset))}this.onScroll_()};Blockly.ScrollbarSvg.prototype.createDom_=function(element){this.svgGroup_=Blockly.createSvgElement('g',{},null);this.svgBackground_=Blockly.createSvgElement('rect',{'class':'blocklyScrollbarBackground'},this.svgGroup_);var radius=Math.floor((Blockly.ScrollbarSvg.scrollbarThickness-6)/2);this.svgKnob_=Blockly.createSvgElement('rect',{'class':'blocklyScrollbarKnob',rx:radius,ry:radius},this.svgGroup_);Blockly.Scrollbar.insertAfter_(this.svgGroup_,element)};Blockly.ScrollbarSvg.prototype.isVisible=function(){return this.svgGroup_.getAttribute('display')!='none'};Blockly.ScrollbarSvg.prototype.setVisible=function(visible){if(visible==this.isVisible()){return}if(this.pair_){throw'Unable to toggle visibility of paired scrollbars.';}if(visible){this.svgGroup_.setAttribute('display','block')}else{this.setMetrics_({x:0,y:0});this.svgGroup_.setAttribute('display','none')}};Blockly.ScrollbarSvg.prototype.onMouseDownBar_=function(e){Blockly.hideChaff(true);if(e.button==2){e.stopPropagation();return}Blockly.svgResize();var svgSize=Blockly.svgSize();var mouseLocation=this.horizontal_?e.x-svgSize.left:e.y-svgSize.top;var knobXY=Blockly.getAbsoluteXY_(this.svgKnob_);var knobStart=this.horizontal_?knobXY.x:knobXY.y;var knobLength=parseFloat(this.svgKnob_.getAttribute(this.horizontal_?'width':'height'));var knobValue=parseFloat(this.svgKnob_.getAttribute(this.horizontal_?'x':'y'));var pageLength=knobLength*0.95;if(mouseLocation<=knobStart){knobValue-=pageLength}else if(mouseLocation>=knobStart+knobLength){knobValue+=pageLength}this.svgKnob_.setAttribute(this.horizontal_?'x':'y',this.constrainKnob_(knobValue));this.onScroll_();e.stopPropagation()};Blockly.ScrollbarSvg.prototype.onMouseDownKnob_=function(e){Blockly.hideChaff(true);this.onMouseUpKnob_();if(e.button==2){e.stopPropagation();return}this.startDragKnob=parseFloat(this.svgKnob_.getAttribute(this.horizontal_?'x':'y'));this.startDragMouse=this.horizontal_?e.clientX:e.clientY;Blockly.ScrollbarSvg.onMouseUpWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mouseup',this,this.onMouseUpKnob_);Blockly.ScrollbarSvg.onMouseMoveWrapper_=Blockly.bindEvent_(Blockly.svgDoc,'mousemove',this,this.onMouseMoveKnob_);e.stopPropagation()};Blockly.ScrollbarSvg.prototype.onMouseMoveKnob_=function(e){var currentMouse=this.horizontal_?e.clientX:e.clientY;var mouseDelta=currentMouse-this.startDragMouse;var knobValue=this.startDragKnob+mouseDelta;this.svgKnob_.setAttribute(this.horizontal_?'x':'y',this.constrainKnob_(knobValue));this.onScroll_()};Blockly.ScrollbarSvg.prototype.onMouseUpKnob_=function(e){if(Blockly.ScrollbarSvg.onMouseUpWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mouseup',Blockly.ScrollbarSvg.onMouseUpWrapper_);Blockly.ScrollbarSvg.onMouseUpWrapper_=null}if(Blockly.ScrollbarSvg.onMouseMoveWrapper_){Blockly.unbindEvent_(Blockly.svgDoc,'mousemove',Blockly.ScrollbarSvg.onMouseMoveWrapper_);Blockly.ScrollbarSvg.onMouseMoveWrapper_=null}};Blockly.ScrollbarSvg.prototype.constrainKnob_=function(value){if(value<=0||isNaN(value)){value=0}else{var axis=this.horizontal_?'width':'height';var barLength=parseFloat(this.svgBackground_.getAttribute(axis));var knobLength=parseFloat(this.svgKnob_.getAttribute(axis));value=Math.min(value,barLength-knobLength)}return value};Blockly.ScrollbarSvg.prototype.onScroll_=function(e){var knobValue=parseFloat(this.svgKnob_.getAttribute(this.horizontal_?'x':'y'));var barLength=parseFloat(this.svgBackground_.getAttribute(this.horizontal_?'width':'height'));var ratio=knobValue/barLength;if(isNaN(ratio)){ratio=0}var xyRatio={};if(this.horizontal_){xyRatio.x=ratio}else{xyRatio.y=ratio}this.setMetrics_(xyRatio)};Blockly.ScrollbarSvg.prototype.set=function(value,fireEvents){this.svgKnob_.setAttribute(this.horizontal_?'x':'y',value*this.ratio_);if(fireEvents){this.onScroll_()}};Blockly.ScrollbarSvg.scrollbarThickness=15;Blockly.Scrollbar={};(function(){var useNative=false;var ua=window.navigator.userAgent;var isGecko=ua.indexOf('Gecko/')!=-1;var isMac=window.navigator.platform=='MacIntel';var isLinux=window.navigator.platform.indexOf('Linux')!=-1;if(isGecko&&(isMac||isLinux)){useNative=true}if(useNative){Blockly.Scrollbar=Blockly.ScrollbarNative}else{Blockly.Scrollbar=Blockly.ScrollbarSvg}})();Blockly.Scrollbar.insertAfter_=function(newNode,refNode){var siblingNode=refNode.nextSibling;var parentNode=refNode.parentNode;if(!parentNode){throw'Reference node has no parent.';}if(siblingNode){parentNode.insertBefore(newNode,siblingNode)}else{parentNode.appendChild(newNode)}};Blockly.Toolbox={};Blockly.Toolbox.width=0;Blockly.Toolbox.selectedOption_=null;Blockly.Toolbox.createDom=function(){Blockly.Toolbox.flyout_=new Blockly.Flyout();var svgGroup=Blockly.createSvgElement('g',{},null);Blockly.Toolbox.svgGroup_=svgGroup;var flyoutGroup=Blockly.Toolbox.flyout_.createDom();svgGroup.appendChild(flyoutGroup);Blockly.Toolbox.svgBackground_=Blockly.createSvgElement('rect',{'class':'blocklyToolboxBackground',height:'100%'},svgGroup);Blockly.Toolbox.svgOptions_=Blockly.createSvgElement('g',{'class':'blocklyToolboxOptions'},svgGroup);return svgGroup};Blockly.Toolbox.getMetrics=function(){var viewHeight=Blockly.svgSize().height;var viewWidth=Blockly.Toolbox.width;try{var optionBox=Blockly.Toolbox.svgOptions_.getBBox()}catch(e){return null}return{viewHeight:viewHeight,viewWidth:viewWidth,contentHeight:optionBox.height+optionBox.y,viewTop:-Blockly.Toolbox.svgOptions_.scrollY,contentTop:0,absoluteTop:0,absoluteLeft:Blockly.RTL?-1:1}};Blockly.Toolbox.setMetrics=function(yRatio){var metrics=Blockly.Toolbox.getMetrics();if(typeof yRatio.y=='number'){Blockly.Toolbox.svgOptions_.scrollY=-metrics.contentHeight*yRatio.y-metrics.contentTop}Blockly.Toolbox.svgOptions_.setAttribute('transform','translate(0,'+(Blockly.Toolbox.svgOptions_.scrollY+metrics.absoluteTop)+')')};Blockly.Toolbox.init=function(){Blockly.Toolbox.flyout_.init(Blockly.mainWorkspace,Blockly.getMainWorkspaceMetrics);Blockly.Toolbox.languageTree=Blockly.Toolbox.buildTree_();Blockly.Toolbox.redraw();new Blockly.Scrollbar(Blockly.Toolbox.svgOptions_,Blockly.Toolbox.getMetrics,Blockly.Toolbox.setMetrics,false,false);Blockly.Toolbox.position_();Blockly.bindEvent_(window,'resize',null,Blockly.Toolbox.position_)};Blockly.Toolbox.position_=function(){var svgSize=Blockly.svgSize();if(Blockly.RTL){Blockly.Toolbox.svgGroup_.setAttribute('transform','translate('+(svgSize.width-Blockly.Toolbox.width)+',0)')}};Blockly.Toolbox.PREFIX_='cat_';Blockly.Toolbox.buildTree_=function(){var tree={};for(var name in Blockly.Language){var block=Blockly.Language[name];if(block.category){var cat=Blockly.Toolbox.PREFIX_+window.encodeURI(block.category);if(cat in tree){tree[cat].push(name)}else{tree[cat]=[name]}}}return tree};Blockly.Toolbox.redraw=function(){var options=[];for(var cat in Blockly.Toolbox.languageTree){var option={};option.text=window.decodeURI(cat.substring(Blockly.Toolbox.PREFIX_.length));option.cat=cat;options.push(option)}var option={};if(Blockly.Language.variables_get||Blockly.Language.variables_set){options.push({text:Blockly.MSG_VARIABLE_CATEGORY,cat:Blockly.MSG_VARIABLE_CATEGORY})}if(Blockly.Language.procedures_defnoreturn||Blockly.Language.procedures_defreturn){options.push({text:Blockly.MSG_PROCEDURE_CATEGORY,cat:Blockly.MSG_PROCEDURE_CATEGORY})}function callbackFactory(cat,element){return function(e){var oldSelectedOption=Blockly.Toolbox.selectedOption_;Blockly.hideChaff();if(oldSelectedOption!=element){Blockly.Toolbox.selectOption_(cat,element)}e.stopPropagation()}}Blockly.removeChildren_(Blockly.Toolbox.svgOptions_);var TOP_MARGIN=4;var maxWidth=0;var resizeList=[Blockly.Toolbox.svgBackground_];for(var x=0,option;option=options[x];x++){var gElement=Blockly.ContextMenu.optionToDom(option.text);var rectElement=gElement.firstChild;var textElement=gElement.lastChild;Blockly.Toolbox.svgOptions_.appendChild(gElement);gElement.setAttribute('transform','translate(0, '+(x*Blockly.ContextMenu.Y_HEIGHT+TOP_MARGIN)+')');Blockly.bindEvent_(gElement,'mousedown',null,callbackFactory(option.cat,gElement));resizeList.push(rectElement);maxWidth=Math.max(maxWidth,textElement.getComputedTextLength())}maxWidth+=Blockly.ContextMenu.X_PADDING*2;for(var x=0;x<resizeList.length;x++){resizeList[x].setAttribute('width',maxWidth)}if(Blockly.RTL){for(var x=0,gElement;gElement=Blockly.Toolbox.svgOptions_.childNodes[x];x++){var textElement=gElement.lastChild;textElement.setAttribute('x',maxWidth-textElement.getComputedTextLength()-Blockly.ContextMenu.X_PADDING)}}Blockly.Toolbox.width=maxWidth;Blockly.bindEvent_(Blockly.Toolbox.svgGroup_,'mousedown',null,function(e){if(e.button==2){Blockly.hideChaff(true);e.stopPropagation()}});Blockly.fireUiEvent(Blockly.svgDoc,window,'resize')};Blockly.Toolbox.selectOption_=function(cat,newSelectedOption){Blockly.Toolbox.selectedOption_=newSelectedOption;if(newSelectedOption){Blockly.addClass_(newSelectedOption,'blocklyMenuSelected');var blockSet=Blockly.Toolbox.languageTree[cat]||cat;Blockly.Toolbox.flyout_.show(blockSet)}};Blockly.Toolbox.clearSelection=function(){var oldSelectedOption=Blockly.Toolbox.selectedOption_;if(oldSelectedOption){Blockly.removeClass_(oldSelectedOption,'blocklyMenuSelected');Blockly.Toolbox.selectedOption_=null}Blockly.Toolbox.flyout_.hide()};Blockly.Tooltip={};Blockly.Tooltip.mouseOutPid=0;Blockly.Tooltip.showPid=0;Blockly.Tooltip.lastX=0;Blockly.Tooltip.lastY=0;Blockly.Tooltip.visible=false;Blockly.Tooltip.element=null;Blockly.Tooltip.poisonedElement=null;Blockly.Tooltip.svgGroup_=null;Blockly.Tooltip.svgText_=null;Blockly.Tooltip.svgBackground_=null;Blockly.Tooltip.svgShadow_=null;Blockly.Tooltip.OFFSET_X=0;Blockly.Tooltip.OFFSET_Y=10;Blockly.Tooltip.RADIUS_OK=10;Blockly.Tooltip.HOVER_MS=1000;Blockly.Tooltip.MARGINS=5;Blockly.Tooltip.createDom=function(){var svgGroup=Blockly.createSvgElement('g',{'class':'blocklyHidden'},null);Blockly.Tooltip.svgGroup_=svgGroup;Blockly.Tooltip.svgShadow_=Blockly.createSvgElement('rect',{'class':'blocklyTooltipShadow',x:2,y:2},svgGroup);Blockly.Tooltip.svgBackground_=Blockly.createSvgElement('rect',{'class':'blocklyTooltipBackground'},svgGroup);Blockly.Tooltip.svgText_=Blockly.createSvgElement('text',{'class':'blocklyTooltipText'},svgGroup);return svgGroup};Blockly.Tooltip.bindMouseEvents=function(element){Blockly.bindEvent_(element,'mouseover',null,Blockly.Tooltip.onMouseOver_);Blockly.bindEvent_(element,'mouseout',null,Blockly.Tooltip.onMouseOut_);Blockly.bindEvent_(element,'mousemove',null,Blockly.Tooltip.onMouseMove_)};Blockly.Tooltip.onMouseOver_=function(e){var element=e.target;while(typeof element.tooltip=='object'){element=element.tooltip}if(Blockly.Tooltip.element!=element){Blockly.Tooltip.hide();Blockly.Tooltip.poisonedElement=null;Blockly.Tooltip.element=element}window.clearTimeout(Blockly.Tooltip.mouseOutPid)};Blockly.Tooltip.onMouseOut_=function(e){Blockly.Tooltip.mouseOutPid=window.setTimeout(function(){Blockly.Tooltip.element=null;Blockly.Tooltip.poisonedElement=null;Blockly.Tooltip.hide()},1);window.clearTimeout(Blockly.Tooltip.showPid)};Blockly.Tooltip.onMouseMove_=function(e){if(!Blockly.Tooltip.element||!Blockly.Tooltip.element.tooltip){return}else if((Blockly.ContextMenu&&Blockly.ContextMenu.visible)||Blockly.Block.dragMode_!=0){return}if(Blockly.Tooltip.visible){var dx=Blockly.Tooltip.lastX-e.clientX;var dy=Blockly.Tooltip.lastY-e.clientY;var dr=Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));if(dr>Blockly.Tooltip.RADIUS_OK){Blockly.Tooltip.hide()}}else if(Blockly.Tooltip.poisonedElement!=Blockly.Tooltip.element){window.clearTimeout(Blockly.Tooltip.showPid);Blockly.Tooltip.lastX=e.clientX;Blockly.Tooltip.lastY=e.clientY;Blockly.Tooltip.showPid=window.setTimeout(Blockly.Tooltip.show_,Blockly.Tooltip.HOVER_MS)}};Blockly.Tooltip.hide=function(){if(Blockly.Tooltip.visible){Blockly.Tooltip.visible=false;if(Blockly.Tooltip.svgGroup_){Blockly.Tooltip.svgGroup_.style.display='none'}}window.clearTimeout(Blockly.Tooltip.showPid)};Blockly.Tooltip.show_=function(){Blockly.Tooltip.poisonedElement=Blockly.Tooltip.element;if(!Blockly.Tooltip.svgGroup_){return}Blockly.removeChildren_(Blockly.Tooltip.svgText_);var tip=Blockly.Tooltip.element.tooltip;if(typeof tip=='function'){tip=tip()}var lines=tip.split('\n');for(var i=0;i<lines.length;i++){var tspanElement=Blockly.createSvgElement('tspan',{dy:'1em',x:Blockly.Tooltip.MARGINS},Blockly.Tooltip.svgText_);var textNode=Blockly.svgDoc.createTextNode(lines[i]);tspanElement.appendChild(textNode)}Blockly.Tooltip.visible=true;Blockly.Tooltip.svgGroup_.style.display='block';var bb=Blockly.Tooltip.svgText_.getBBox();var width=2*Blockly.Tooltip.MARGINS+bb.width;var height=bb.height;Blockly.Tooltip.svgBackground_.setAttribute('width',width);Blockly.Tooltip.svgBackground_.setAttribute('height',height);Blockly.Tooltip.svgShadow_.setAttribute('width',width);Blockly.Tooltip.svgShadow_.setAttribute('height',height);var left=Blockly.Tooltip.lastX;if(Blockly.RTL){left-=Blockly.Tooltip.OFFSET_X+width}else{left+=Blockly.Tooltip.OFFSET_X}var top=Blockly.Tooltip.lastY+Blockly.Tooltip.OFFSET_Y;Blockly.svgResize();var svgSize=Blockly.svgSize();left-=svgSize.left;top-=svgSize.top;Blockly.Tooltip.svgGroup_.setAttribute('transform','translate('+left+','+top+')')};Blockly.Trashcan=function(getMetrics){this.getMetrics_=getMetrics};Blockly.Trashcan.prototype.BODY_URL_='media/trashbody.png';Blockly.Trashcan.prototype.LID_URL_='media/trashlid.png';Blockly.Trashcan.prototype.WIDTH_=47;Blockly.Trashcan.prototype.BODY_HEIGHT_=45;Blockly.Trashcan.prototype.LID_HEIGHT_=15;Blockly.Trashcan.prototype.MARGIN_BOTTOM_=35;Blockly.Trashcan.prototype.MARGIN_SIDE_=35;Blockly.Trashcan.prototype.isOpen=false;Blockly.Trashcan.prototype.svgGroup_=null;Blockly.Trashcan.prototype.svgBody_=null;Blockly.Trashcan.prototype.svgLid_=null;Blockly.Trashcan.prototype.lidTask_=0;Blockly.Trashcan.prototype.lidAngle_=0;Blockly.Trashcan.prototype.left_=0;Blockly.Trashcan.prototype.top_=0;Blockly.Trashcan.prototype.createDom=function(){this.svgGroup_=Blockly.createSvgElement('g',{filter:'url(#blocklyTrashcanShadowFilter)'},null);this.svgBody_=Blockly.createSvgElement('image',{width:this.WIDTH_,height:this.BODY_HEIGHT_},this.svgGroup_);this.svgBody_.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href',Blockly.pathToBlockly+this.BODY_URL_);this.svgBody_.setAttribute('y',this.LID_HEIGHT_);this.svgLid_=Blockly.createSvgElement('image',{width:this.WIDTH_,height:this.LID_HEIGHT_},this.svgGroup_);this.svgLid_.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href',Blockly.pathToBlockly+this.LID_URL_);return this.svgGroup_};Blockly.Trashcan.prototype.init=function(){this.setOpen_(false);this.position_();Blockly.bindEvent_(window,'resize',this,this.position_)};Blockly.Trashcan.prototype.position_=function(){var metrics=this.getMetrics_();if(!metrics){return}if(Blockly.RTL){this.left_=this.MARGIN_SIDE_}else{this.left_=metrics.viewWidth+metrics.absoluteLeft-this.WIDTH_-this.MARGIN_SIDE_}this.top_=metrics.viewHeight+metrics.absoluteTop-(this.BODY_HEIGHT_+this.LID_HEIGHT_)-this.MARGIN_BOTTOM_;this.svgGroup_.setAttribute('transform','translate('+this.left_+','+this.top_+')')};Blockly.Trashcan.prototype.onMouseMove=function(e){if(!this.svgGroup_){return}var hwView=Blockly.svgSize();var xy=Blockly.getAbsoluteXY_(this.svgGroup_);var left=xy.x+hwView.left;var top=xy.y+hwView.top;var over=(e.clientX>left)&&(e.clientX<left+this.WIDTH_)&&(e.clientY>top)&&(e.clientY<top+this.BODY_HEIGHT_+this.LID_HEIGHT_);if(this.isOpen!=over){this.setOpen_(over)}};Blockly.Trashcan.prototype.setOpen_=function(state){if(this.isOpen==state){return}window.clearTimeout(this.lidTask_);this.isOpen=state;Blockly.Trashcan.animateLid_(this)};Blockly.Trashcan.animateLid_=function(trashcan){trashcan.lidAngle_+=trashcan.isOpen?10:-10;trashcan.lidAngle_=Math.max(0,trashcan.lidAngle_);trashcan.svgLid_.setAttribute('transform','rotate('+(Blockly.RTL?-trashcan.lidAngle_:trashcan.lidAngle_)+', '+(Blockly.RTL?4:trashcan.WIDTH_-4)+', '+(trashcan.LID_HEIGHT_-2)+')');if(trashcan.isOpen?(trashcan.lidAngle_<45):(trashcan.lidAngle_>0)){var closure=function(){Blockly.Trashcan.animateLid_(trashcan)};this.lidTask_=window.setTimeout(closure,5)}};Blockly.Trashcan.close=function(trashcan){trashcan.setOpen_(false)};Blockly.Variables={};Blockly.Variables.NAME_TYPE='variable';Blockly.Variables.allVariables=function(opt_block){var blocks;if(opt_block){blocks=opt_block.getDescendants()}else{blocks=Blockly.mainWorkspace.getAllBlocks()}var variableHash={};for(var x=0;x<blocks.length;x++){var func=blocks[x].getVars;if(func){var blockVariables=func.call(blocks[x]);for(var y=0;y<blockVariables.length;y++){var varName=blockVariables[y];if(varName){variableHash[Blockly.Names.PREFIX_+varName.toLowerCase()]=varName}}}}var variableList=[];for(var name in variableHash){variableList.push(variableHash[name])}return variableList};Blockly.Variables.dropdownCreate=function(){var variableList=Blockly.Variables.allVariables();var name=this.getText();if(name&&variableList.indexOf(name)==-1){variableList.push(name)}variableList.sort(Blockly.caseInsensitiveComparator);variableList.push(Blockly.MSG_RENAME_VARIABLE);variableList.push(Blockly.MSG_NEW_VARIABLE);var options=[];for(var x=0;x<variableList.length;x++){options[x]=[variableList[x],variableList[x]]}return options};Blockly.Variables.dropdownChange=function(text){function promptName(promptText,defaultText){Blockly.hideChaff();var newVar=window.prompt(promptText,defaultText);return newVar&&newVar.replace(/^[\s\xa0]+|[\s\xa0]+$/g,'')}if(text==Blockly.MSG_RENAME_VARIABLE){var oldVar=this.getText();text=promptName(Blockly.MSG_RENAME_VARIABLE_TITLE.replace('%1',oldVar),oldVar);if(text){Blockly.Variables.renameVariable(oldVar,text)}}else{if(text==Blockly.MSG_NEW_VARIABLE){text=promptName(Blockly.MSG_NEW_VARIABLE_TITLE,'');Blockly.Variables.renameVariable(text,text)}if(text){this.setText(text)}}};Blockly.Variables.renameVariable=function(oldName,newName){var blocks=Blockly.mainWorkspace.getAllBlocks();for(var x=0;x<blocks.length;x++){var func=blocks[x].renameVar;if(func){func.call(blocks[x],oldName,newName)}}};Blockly.Variables.flyoutCategory=function(blocks,gaps,margin,workspace){var variableList=Blockly.Variables.allVariables();variableList.sort(Blockly.caseInsensitiveComparator);variableList.unshift(null);var defaultVariable=undefined;for(var i=0;i<variableList.length;i++){if(variableList[i]===defaultVariable){continue}var getBlock=Blockly.Language.variables_get?new Blockly.Block(workspace,'variables_get'):null;getBlock&&getBlock.initSvg();var setBlock=Blockly.Language.variables_set?new Blockly.Block(workspace,'variables_set'):null;setBlock&&setBlock.initSvg();if(variableList[i]===null){defaultVariable=(getBlock||setBlock).getVars()[0]}else{getBlock&&getBlock.setTitleText(variableList[i],'VAR');setBlock&&setBlock.setTitleText(variableList[i],'VAR')}setBlock&&blocks.push(setBlock);getBlock&&blocks.push(getBlock);if(getBlock&&setBlock){gaps.push(margin,margin*3)}else{gaps.push(margin*2)}}};Blockly.Workspace=function(editable){this.editable=editable;this.topBlocks_=[];Blockly.ConnectionDB.init(this)};Blockly.Workspace.prototype.dragMode=false;Blockly.Workspace.prototype.scrollX=0;Blockly.Workspace.prototype.scrollY=0;Blockly.Workspace.prototype.trashcan=null;Blockly.Workspace.prototype.createDom=function(){this.svgGroup_=Blockly.createSvgElement('g',{},null);this.svgBlockCanvas_=Blockly.createSvgElement('g',{},this.svgGroup_);return this.svgGroup_};Blockly.Workspace.prototype.addTrashcan=function(getMetrics){if(Blockly.Trashcan&&this.editable){this.trashcan=new Blockly.Trashcan(getMetrics);var svgTrashcan=this.trashcan.createDom();this.svgGroup_.insertBefore(svgTrashcan,this.svgBlockCanvas_);this.trashcan.init()}};Blockly.Workspace.prototype.getCanvas=function(){return this.svgBlockCanvas_};Blockly.Workspace.prototype.addTopBlock=function(block){this.topBlocks_.push(block)};Blockly.Workspace.prototype.removeTopBlock=function(block){var found=false;for(var child,x=0;child=this.topBlocks_[x];x++){if(child==block){this.topBlocks_.splice(x,1);found=true;break}}if(!found){throw'Block not present in workspace\'s list of top-most blocks.';}};Blockly.Workspace.prototype.getTopBlocks=function(ordered){var blocks=[].concat(this.topBlocks_);if(ordered&&blocks.length>1){blocks.sort(function(a,b){return a.getRelativeToSurfaceXY().y-b.getRelativeToSurfaceXY().y})}return blocks};Blockly.Workspace.prototype.getAllBlocks=function(){var blocks=this.getTopBlocks(false);for(var x=0;x<blocks.length;x++){blocks=blocks.concat(blocks[x].getChildren())}return blocks};Blockly.Workspace.prototype.clear=function(){Blockly.hideChaff();while(this.topBlocks_.length){this.topBlocks_[0].destroy()}};Blockly.Workspace.prototype.render=function(){var renderList=this.getAllBlocks();for(var x=0,block;block=renderList[x];x++){if(!block.getChildren().length){block.render()}}};Blockly.Workspace.prototype.getBlockById=function(id){var blocks=this.getAllBlocks();for(var x=0,block;block=blocks[x];x++){if(block.id==id){return block}}return null};Blockly.Workspace.prototype.traceOn=function(armed){this.traceOn_=armed;if(this.traceWrapper_){Blockly.unbindEvent_(this.svgBlockCanvas_,'blocklySelectChange',this.traceWrapper_);this.traceWrapper_=null}if(armed){this.traceWrapper_=Blockly.bindEvent_(this.svgBlockCanvas_,'blocklySelectChange',this,function(){this.traceOn_=false})}};Blockly.Workspace.prototype.highlightBlock=function(id){if(!this.traceOn_){return}var block=this.getBlockById(id);if(!block){return}this.traceOn(false);block.select();this.traceOn(true)};Blockly.Xml={};Blockly.Xml.workspaceToDom=function(blockGroup){var xml=document.createElement('xml');var blocks=blockGroup.getTopBlocks(false);for(var i=0,block;block=blocks[i];i++){var element=Blockly.Xml.blockToDom_(block);var xy=block.getRelativeToSurfaceXY();element.setAttribute('x',Blockly.RTL?-xy.x:xy.x);element.setAttribute('y',xy.y);xml.appendChild(element)}return xml};Blockly.Xml.blockToDom_=function(block){var element=document.createElement('block');element.setAttribute('type',block.type);if(block.mutationToDom){var mutation=block.mutationToDom();if(mutation){element.appendChild(mutation)}}for(var i=0,title;title=block.titleRow[i];i++){if(title.name&&title.EDITABLE){var container=document.createElement('title');container.setAttribute('name',title.name);var titleText=document.createTextNode(title.getValue());container.appendChild(titleText);element.appendChild(container)}}if(block.comment){var commentElement=document.createElement('comment');var commentText=document.createTextNode(block.comment.getText());commentElement.appendChild(commentText);commentElement.setAttribute('pinned',block.comment.isPinned());var xy=block.comment.getBubbleLocation();commentElement.setAttribute('x',xy.x);commentElement.setAttribute('y',xy.y);var hw=block.comment.getBubbleSize();commentElement.setAttribute('h',hw.height);commentElement.setAttribute('w',hw.width);element.appendChild(commentElement)}var hasValues=false;for(var i=0,input;input=block.inputList[i];i++){var container;var empty=true;if(input.type==Blockly.LOCAL_VARIABLE){container=document.createElement('variable');container.setAttribute('data',input.getText());empty=false}else{var childBlock=input.targetBlock();if(input.type==Blockly.INPUT_VALUE){container=document.createElement('value');hasValues=true}else if(input.type==Blockly.NEXT_STATEMENT){container=document.createElement('statement')}if(childBlock){container.appendChild(Blockly.Xml.blockToDom_(childBlock));empty=false}}container.setAttribute('name',input.name);if(input.label&&input.label.EDITABLE&&input.label.getValue){container.setAttribute('label',input.label.getValue());empty=false}if(!empty){element.appendChild(container)}}if(hasValues){element.setAttribute('inline',block.inputsInline)}if(block.collapsed){element.setAttribute('collapsed',true)}if(block.nextConnection){var nextBlock=block.nextConnection.targetBlock();if(nextBlock){var container=document.createElement('next');container.appendChild(Blockly.Xml.blockToDom_(nextBlock));element.appendChild(container)}}return element};Blockly.Xml.domToText=function(dom){var oSerializer=new XMLSerializer();return oSerializer.serializeToString(dom)};Blockly.Xml.domToPrettyText=function(dom){var line=Blockly.Xml.domToText(dom);var lines=line.split('<');var indent='';for(var x=1;x<lines.length;x++){var nextChar=lines[x][0];if(nextChar=='/'){indent=indent.substring(2)}lines[x]=indent+'<'+lines[x];if(nextChar!='/'){indent+='  '}}var text=lines.join('\n');text=text.replace(/(<(\w+)[^>]*>[^\n]*)\n *<\/\2>/g,'$1</$2>');return text.replace(/^\n/,'')};Blockly.Xml.textToDom=function(text){var oParser=new DOMParser();var dom=oParser.parseFromString(text,'text/xml');if(!dom||!dom.firstChild||dom.firstChild.tagName!='xml'||dom.firstChild!==dom.lastChild){throw'Blockly.Xml.textToDom did not obtain a valid XML tree.';}return dom.firstChild};Blockly.Xml.domToWorkspace=function(blockGroup,xml){for(var x=0,xmlChild;xmlChild=xml.childNodes[x];x++){if(xmlChild.nodeName&&xmlChild.nodeName.toLowerCase()=='block'){var block=Blockly.Xml.domToBlock_(blockGroup,xmlChild);var blockX=parseInt(xmlChild.getAttribute('x'),10);var blockY=parseInt(xmlChild.getAttribute('y'),10);if(!isNaN(blockX)&&!isNaN(blockY)){block.moveBy(Blockly.RTL?-blockX:blockX,blockY)}}}};Blockly.Xml.domToBlock_=function(blockGroup,xmlBlock){var prototypeName=xmlBlock.getAttribute('type');var block=new Blockly.Block(blockGroup,prototypeName);block.initSvg();var inline=xmlBlock.getAttribute('inline');if(inline){block.setInputsInline(inline=='true')}var collapsed=xmlBlock.getAttribute('collapsed');if(collapsed){block.setCollapsed(collapsed=='true')}for(var x=0,xmlChild;xmlChild=xmlBlock.childNodes[x];x++){if(xmlChild.nodeType==3&&xmlChild.data.match(/^\s*$/)){continue}var blockChild=null;var input;var firstRealGrandchild=null;for(var y=0,grandchildNode;grandchildNode=xmlChild.childNodes[y];y++){if(grandchildNode.nodeType!=3||!grandchildNode.data.match(/^\s*$/)){firstRealGrandchild=grandchildNode}}var name=xmlChild.getAttribute('name');switch(xmlChild.tagName.toLowerCase()){case'mutation':if(block.domToMutation){block.domToMutation(xmlChild)}break;case'comment':block.setCommentText(xmlChild.textContent);var pinned=xmlChild.getAttribute('pinned');if(pinned){block.comment.setPinned(pinned=='true')}var bubbleX=parseInt(xmlChild.getAttribute('x'),10);var bubbleY=parseInt(xmlChild.getAttribute('y'),10);if(!isNaN(bubbleX)&&!isNaN(bubbleY)){block.comment.setBubbleLocation(bubbleX,bubbleY,false)}var bubbleW=parseInt(xmlChild.getAttribute('w'),10);var bubbleH=parseInt(xmlChild.getAttribute('h'),10);if(!isNaN(bubbleW)&&!isNaN(bubbleH)){block.comment.setBubbleSize(bubbleW,bubbleH)}break;case'title':block.setTitleValue(xmlChild.textContent,name);break;case'variable':var data=xmlChild.getAttribute('data');if(data!==null){input=block.getInput(name);if(!input){throw'Variable input does not exist.';}input.setText(data)}break;case'value':case'statement':input=block.getInput(name);if(!input){throw'Input does not exist.';}if(firstRealGrandchild&&firstRealGrandchild.tagName&&firstRealGrandchild.tagName.toLowerCase()=='block'){blockChild=Blockly.Xml.domToBlock_(blockGroup,firstRealGrandchild);if(blockChild.outputConnection){input.connect(blockChild.outputConnection)}else if(blockChild.previousConnection){input.connect(blockChild.previousConnection)}else{throw'Child block does not have output or previous statement.';}}break;case'next':if(firstRealGrandchild&&firstRealGrandchild.tagName&&firstRealGrandchild.tagName.toLowerCase()=='block'){if(!block.nextConnection){throw'Next statement does not exist.';}else if(block.nextConnection.targetConnection){throw'Next statement is already connected.';}blockChild=Blockly.Xml.domToBlock_(blockGroup,firstRealGrandchild);if(!blockChild.previousConnection){throw'Next block does not have previous statement.';}block.nextConnection.connect(blockChild.previousConnection)}break;default:}var labelText=xmlChild.getAttribute('label');if(labelText!==null&&input&&input.label&&input.label.setText){input.label.setValue(labelText)}}block.render();return block};Blockly.Xml.isFirstRealChild_=function(parentNode,tagName){for(var x=0,childNode;childNode=parentNode.childNodes[x];x++){if(childNode.nodeType!=3||!childNode.data.match(/^\s*$/)){return childNode.tagName&&childNode.tagName.toLowerCase()==tagName}}return false};