<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Screen1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"/>
    <script>
      function yailNumberToString(n) {
        if (Number.isFinite(n)) {
          if (n == Math.round(n)) {
            return n.toString();
          } else {
            // TODO(ewpatton): Match the Java version here
            return n.toString();
          }
        } else {
          return n < 0 ? "-infinity" : "+infinity";
        }
      }

function blobToBase64(blob) {
  return new Promise((resolve, _) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

class FileSystemSimulator {
  static files = {};
  static storeFile(filename, contents) {
    FileSystemSimulator.files[filename] = contents;
  }

  static getFile(filename) {
    if (filename in FileSystemSimulator.files) {
      return FileSystemSimulator.files[filename];
    } else {
      throw new Error(`File not found: ${filename}`);
    }
  }
}

class AssetFetcher {
  static loadedAssets = {};
  static async fetchAssets(cookie, projectId, baseUrl, filename) {
    let response = await fetch(`${baseUrl}/ode/download/file/${projectId}/${filename}`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Cookie': 'AppInventor = ' + cookie
      }
    });
    if (!response.ok) {
      throw new Error(`Failed to fetch asset: ${response.statusText}`);
    }
    let blob = await response.blob();
    let base64 = await blobToBase64(blob);
    console.log(base64);
    AssetFetcher.loadedAssets[filename.substring('assets/'.length)] = base64;
    RetValManager.assetTransferred(filename);
  }


  static getLoadedAsset(filename) {
    if (filename.startsWith('file:///android_asset/')) {
      filename = filename.substring('file:///android_asset/'.length);
    }
    if (filename in AssetFetcher.loadedAssets) {
      return AssetFetcher.loadedAssets[filename];
    } else {
      throw new Error(`Asset not found: ${filename}`);
    }
  }
}

top.AssetFetcher = AssetFetcher;

class RetValManager {
  static values = [];

  static appendReturnValue(blockid, ok, item) {
    if (typeof blockid !== 'string') {
      blockid = blockid.toString();
    }
    let response = {status: ok, type: 'return', value: item, blockid: blockid};
    RetValManager.values.push(response);
    console.log(response);
    if (window.opener) {
      window.opener.postMessage(response, 'http://localhost:8888');
    }
  }

  static extensionsLoaded() {
    let response = {status: 'OK', type: 'extensionsLoaded'};
    RetValManager.values.push(response);
    console.log(response);
    if (window.opener) {
      window.opener.postMessage(response, 'http://localhost:8888');
    }
  }

  static assetTransferred(filename) {
    let response = {status: 'OK', type: 'assetTransferred', value: filename};
    RetValManager.values.push(response);
    console.log(response);
    if (window.opener) {
      window.opener.postMessage(response, 'http://localhost:8888');
    }
  }
}

function getReplForm() {
  try {
    return appinventor.Screen1.getActiveForm();
  } catch (e) {
    return undefined;
  }
}

      // Receive messages from App Inventor
      window.addEventListener("message", async (event) => {
        if (event.origin !== "http://localhost:8888") return;
        const data = event.data;
        
        if (data.type === "sendToEmulator") { // Emulator will display the message and echo it in app inventor
          console.log("App Inventor said: ", data.payload);
          window.opener.postMessage({type : "response", payload : "Emulator received: " + data.payload}, "http://localhost:8888");
        } else if (data.type === "response") { // Same as sendToEmulator but without echo
          console.log("App Inventor said: ", data.payload);
        } else if (data.type === "eval") {
          var result = await evalScheme(data.payload);
          window.opener.postMessage({type : "response", payload: "Answer is: " + result}, "http://localhost:8888");
        } else if (data.type === 'repl') {
          evalScheme(data.code);
        }
      });

    </script>
    <script src="protobuf-7.5.3.min.js"></script>
    <script src="chat.proto.js" type="text/javascript"></script>
    <script src="build/runtime.js" type="text/javascript"></script>
<script id="runtimeExtra" type="text/scheme">
(define-syntax require
  (syntax-rules ()
    ((_ package)
     #f)))
(define-syntax process-repl-input
  (syntax-rules ()
    ((_ blockid expr)
     (in-ui blockid (delay expr)))))
(define-syntax add-component
  (syntax-rules ()
    ((_ container component-type component-name)
     (add-component-within-repl 'container 'component-type 'component-name #f))
    ((_ container component-type component-name init-property-form ...)
     (let ((init-thunk (lambda () init-property-form ...)))
       (add-component-within-repl 'container 'component-type 'component-name init-thunk)))))
(define-syntax *list-for-runtime*
  (syntax-rules ()
    ((_  args ...)
     (list args ...))))
;;; (gen-event-name Button2 Click)
;;; ==> Button2$Click
(define-syntax gen-event-name (syntax-rules () ((_ component-name event-name) (symbol-append 'component-name (identifier-base '$) 'event-name))))
#|
; Android version
(define-syntax define-event-helper
  (syntax-rules ()
    ((_ event-func-name (arg ...) (expr ...))

     ;; Note that if we expand directly into a lambda expression  below we expose
     ;; an error in the Kawa compiler and the function doesn't get defined properly.
     ;; I think that it ends up not becoming a public method in the generated class.

     (begin
       (define (event-func-name arg ...)
         ;; The arguments to the handler come from the components and
         ;; need to be sanitized before we can operate on them in Yail.  See
         ;; the comments on sanitize below
         (let ((arg (sanitize-component-data arg)) ...)
           expr ...))
       (if *this-is-the-repl*
           (add-to-current-form-environment 'event-func-name event-func-name)
           (add-to-form-environment 'event-func-name event-func-name))))))
; iOS Version
(define-syntax define-event-helper
  (syntax-rules ()
    ((_ event-func-name (arg ...) (expr ...))
     (begin
       (define (event-func-name arg ...)
         (let ((arg (sanitize-component-data arg)) ...)
           expr ...))
       (if *this-is-the-repl*
           (add-to-current-form-environment 'event-func-name event-func-name)
           (add-to-form-environment 'event-func-name event-func-name))))))
|#
(define-syntax define-event-helper
  (syntax-rules ()
    ((_ event-func-name (arg ...) (expr ...))
     (add-to-current-form-environment 'event-func-name (lambda (arg ...) expr ...)))))
(define-macro (define-event component-name event-name args . body)
  (let ((full-name (symbol-append component-name '$ event-name)))
    `(begin
       (define-event-helper ,full-name ,args ,body)
       (registerEventForDelegation *this-form* ',component-name ',event-name))))
(define-macro define-generic-event
  (lambda (form env)
    (let* ((component-type (cadr form))
           (event-name (caddr form))
           (args (cadddr form))
           (body (cddddr form))
           (full-name (symbol-append 'any$ component-type '$ event-name)))
      #`(define-event-helper #,full-name #,args #,body))))
(define-syntax try-catch
  (syntax-rules ()
    ((_ program (exception type handler))
     (with-exception-handler
      (lambda (exception) (if exception (begin (display exception) (display "\n") handler)))
      (lambda () program)))))
(define-syntax do-after-form-creation
  (syntax-rules ()
    ((_ expr ...)
     (if *this-is-the-repl*
         (begin expr ...)
         (add-to-form-do-after-creation (delay (begin expr ...)))))))
(define-syntax get-var
  (syntax-rules ()
    ((_ var-name)
     ;; unbound global variables default to *the-null-value*
     (lookup-global-var-in-current-form-environment 'var-name *the-null-value*))))
(define-syntax set-var!
  (syntax-rules ()
    ((_ var-name value)
     (add-global-var-to-current-form-environment 'var-name value))))
(define-syntax lexical-value
  (syntax-rules ()
    ((_ var-name)
     var-name)))
(define-syntax set-lexical!
  (syntax-rules ()
    ((_ var value)
     (set! var value))))
(define-syntax and-delayed
  (syntax-rules ()
    ((_ conjunct ...)
     (process-and-delayed (lambda () conjunct) ...))))
(define-syntax or-delayed
  (syntax-rules ()
    ((_ disjunct ...)
     (process-or-delayed (lambda () disjunct) ...))))
</script>
<script id="sampleYail" type="text/yail">
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (AssetFetcher:loadExtensions "[]"))))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (clear-current-form))))
;(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (define-syntax protect-enum   (lambda (x)     (syntax-case x ()       ((_ enum-value number-value)         (if (< com.google.appinventor.components.common.YaVersion:BLOCKS_LANGUAGE_VERSION 34)           #'number-value           #'enum-value)))))(clear-current-form))))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (try-catch (let ((attempt (delay (set-form-name "Screen1")))) (force attempt)) (exception java.lang.Throwable 'notfound)))))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (do-after-form-creation (set-and-coerce-property! 'Screen1 'ActionBar #t 'boolean)
 (set-and-coerce-property! 'Screen1 'AppName "GWTAndroidTest" 'text)
 (set-and-coerce-property! 'Screen1 'ScreenOrientation "unspecified" 'text)
 (set-and-coerce-property! 'Screen1 'ShowListsAsJson #t 'boolean)
 (set-and-coerce-property! 'Screen1 'Sizing "Responsive" 'text)
 (set-and-coerce-property! 'Screen1 'Title "Screen1" 'text)
)

(add-component Screen1 com.google.appinventor.components.runtime.Button Button1
(set-and-coerce-property! 'Button1 'Text "0" 'text)

)
)))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (init-runtime))))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input "wvT3}2O~B^(xLo3]9rxj" (begin (define-event Button1 Click()(set-this-form)
    (set-and-coerce-property! 'Button1 'Text (call-yail-primitive + (*list-for-runtime* (get-property 'Button1 'Text) 1 ) '(number number ) "+") 'text)))))
(begin (require <com.google.youngandroid.runtime>) (process-repl-input -1 (begin (call-Initialize-of-components 'Screen1 'Button1))))
</script>
<script>
let runtimeExtras = document.getElementById('runtimeExtra').innerText.trim();
function initRuntime() {
  evalScheme(runtimeExtras);
  if (window.opener) {
    window.opener.postMessage({type: "ready"}, "http://localhost:8888");
  }
}
function runYail() {
  const yail = document.getElementById('sampleYail');
  if (!yail) {
    throw new Error('Cannot find YAIL');
  }
  evalScheme(yail.innerText);
}
    </script>
    <script src="build/web/webemu/webemu.nocache.js" type="text/javascript"></script>
    <script>
      //evalScheme("(init-runtime)")
    </script>
    <style>
      @font-face {
        font-family: "Roboto";
        src: url("war/static/fonts/Roboto-Regular.ttf") format("truetype");
      }
      html, body { font-family: Roboto, Helvetica, Arial, sans-serif; width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-size: 14pt; }
      button { font-family: Roboto, Helvetica, Arial, sans-serif; font-size: 14pt; padding: 4px 8px; }
      #activity { display: flex; width: 100%; height: 100%; }
      #activity>div { width: 100%; height: 100%; }
      .fillViewport { width: 100%; height: 100%; position: relative; }
      .ContentView { display: flex; width: 100%; height: 100%; padding-top: 3.4rem; box-sizing: border-box; }
      .LinearLayout { display: flex; align-items: start; }
      .horizontal { flex-direction: row; }
      .vertical { flex-direction: column; }
    </style>
  </head>
  <body>
    <div id="activity"></div>
  </body>
</html>
