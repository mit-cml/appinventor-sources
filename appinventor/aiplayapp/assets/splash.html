<html>
    <head>
        <title>Welcome to MIT App Inventor</title>
        <script type="text/javascript">
         var permissions = ['android.permission.WRITE_EXTERNAL_STORAGE'];
         function permresult(permission, result) {
             start();/* Re-evaluate whether or not to display */
         }
         function hasallpermissions() {
             var haveall = true;
             for (var i = 0; i < permissions.length; i++) {
                 haveall = haveall && Android.hasPermission(permissions[i]);
             }
             return haveall;
         }
         function start() {
             var item = document.getElementById("needpermission");
             var cbutton = document.getElementById("cbutton");
             if (!hasallpermissions()) {
                 item.style.display = "block";
                 cbutton.style.display = "none";
             } else {
                 item.style.display = "none";
                 cbutton.style.display = "block";
             }
             if (localStorage) {
                 var again = document.getElementById("again");
                 var checkbox = document.getElementById("checkbox");
                 var inhibit = localStorage.getItem("inhibit");
                 again.style.display = "inline";
                 if (inhibit == "true") {
                     checkbox.checked = true;
                 }
             }
             getmotd();
         }
         function getpermission() {
             for (var i = 0; i < permissions.length; i++) {
                 var perm = permissions[i];
                 if (!Android.hasPermission(perm)) {
                     Android.askPermission(perm);
                     break;
                 }
             }
         }
         function done() {
             var checkbox = document.getElementById("checkbox");
             if (checkbox.checked) {
                 localStorage.setItem("inhibit", "true");
                 localStorage.setItem("generation", localStorage.getItem("sgen"));
             } else {
                 localStorage.setItem("inhibit", "false");
             }
             Android.finished();
         }
         function getmotd() {
             var xhr = new XMLHttpRequest();
             xhr.open("GET", "http://templates.appinventor.mit.edu/mit/m.json");
             xhr.onreadystatechange = function() {
                 if (this.readyState == 4 && this.status == 200) {
                     var json = JSON.parse(this.response);
                     var ele = document.getElementById("version");
                     var version = Android.getVersion();
                     var vmessage = json[version];
                     if (!vmessage) {
                         vmessage = json.message;
                     }
                     if (vmessage) {
                         ele.innerHTML = vmessage;
                     }
                     var motd = json.motd;
                     if (motd) {
                         ele = document.getElementById("motd");
                         ele.innerHTML = motd;
                     }
                     if (localStorage) {
                         var generation = localStorage.getItem("generation");
                         if (!generation) {
                             generation = "0";
                         }
                         var sgen = json.generation;
                         var inhibit = localStorage.getItem("inhibit");
                         if (sgen && generation) {
                             sgen = parseInt(sgen);
                             generation = parseInt(generation);
                             localStorage.setItem("sgen", sgen);
                             if (generation >= sgen && inhibit == "true") {
                                 setTimeout(done, 3000);
                             }
                         }
                     }
                 }
             };
             xhr.send();
         }
        </script>

    </head>
    <body onload="start();">
        <center>
            <h1>Welcome to MIT App Inventor!</h1>
        </center>
        <p>Welcome to the MIT App Inventor Companion Application. You use this application in conjunction with
            the MIT App Inventor application authoring system. You can learn more about it at http://appinventor.mit.edu.
        </p>
        <div id="version">
        </div>
        <div id="motd">
        </div>
        <div id="needpermission" style="display:none;">
        <p>
            The Companion needs STORAGE permission. Press the "Get Permissions" button below to ask your device
            to grant these permissions.
        </p>
        <p>&nbsp;</p>
        <button onclick="getpermission();">Get Permissions</button>
        </div>
        <p>&nbsp;</p>
        <div id="cbutton">
            <div id="again" style="display:none;">
                <p>
                    Check the box below and we will only show you this screen for a few seconds before
                    automatically closing it. If important information displayed here changes we will
                    not automatically close.
                </p>
                <p>Check this box for automatic closing: &nbsp;<input type="checkbox" id="checkbox"></p>
            </div>
            <button onclick="done();">Continue</button>
        </div>
    </body>
</html>
